# üé¨ **–°—Ü–µ–Ω–∞—Ä–∏–π: Cross-Shard –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

*(—á–∞—Å—Ç—å —Å–µ—Ä–∏–∏ –ø—Ä–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –ë–î –∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)*

---

# üé£ **0. –í–í–ï–î–ï–ù–ò–ï ‚Äî –±–æ–ª—å, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –≤—Å—ë –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è (1 –º–∏–Ω—É—Ç–∞)**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∏—Ç—É–∞—Ü–∏—é.

–¢—ã —Å–∏–¥–∏—à—å, –Ω–∏–∫–æ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ—à—å, –∏ –≤–Ω–µ–∑–∞–ø–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ä–∞—Ç—å:

* –ë–î —Å—Ç–∞–ª–∞ —Ç–æ—Ä–º–æ–∑–∏—Ç—å
* latency –≤—ã–ª–µ—Ç–∞–µ—Ç –∑–∞ p99
* CPU 100%
* replication lag —Ä–∞—Å—Ç—ë—Ç
* –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞—Å—Ç—ë—Ç
* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è ‚Äú–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ª–∞–≥–∞–µ—Ç!!!‚Äù

–ò –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–µ–±–µ –≥–æ–≤–æ—Ä–∏—Ç:

> ‚Äú–î–æ–±–∞–≤—å –µ—â—ë —Ä–µ–ø–ª–∏–∫, –ø—É—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ‚Äù.

–ù—É –¥–∞, –∫–æ–Ω–µ—á–Ω–æ.
–†–µ–ø–ª–∏–∫–∞ –∂–µ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø–∏—Å—å?
–û–Ω–∞ –∂–µ —Å–Ω–∏–º–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É —Å hot keys?
–û–Ω–∞ –∂–µ –º–∞–≥–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ—Ç row lock?

–ò –≤–æ—Ç –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Ç—ã –≤–ø–µ—Ä–≤—ã–µ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—à—å —Å–∞–∫—Ä–∞–º–µ–Ω—Ç–∞–ª—å–Ω—É—é —Ñ—Ä–∞–∑—É:

> ‚Äú–ù–∞–º –Ω–∞–¥–æ —à–∞—Ä–¥—ã‚Ä¶‚Äù

–ò –≤—Å—ë. –ñ–∏–∑–Ω—å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–µ–∂–Ω–µ–π.

---

# üß± **1. –ü–æ—á–µ–º—É –º—ã –≤–æ–æ–±—â–µ –ø—Ä–∏—Ö–æ–¥–∏–º –∫ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—é (2‚Äì3 –º–∏–Ω)**

–ü—Ä–∏—á–∏–Ω—ã –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ:

### ‚úî –ë–∞–∑–∞ —É–ø—ë—Ä–ª–∞—Å—å –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–µ–ª

CPU, RAM, IOPS ‚Äî –≤—Å—ë –≤ –ø–æ—Ç–æ–ª–∫–µ.

### ‚úî –õ–æ–≥–∏—á–µ—Å–∫–∏–µ hot keys —Ä–≤—É—Ç –æ–¥–∏–Ω —É–∑–µ–ª

–û–¥–∏–Ω –ø–æ–ø—É–ª—è—Ä–Ω—ã–π userId –ª–æ–º–∞–µ—Ç –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä.

### ‚úî –ó–∞–ø–∏—Å–∏ —Å–ª–∏—à–∫–æ–º —Ç—è–∂—ë–ª—ã–µ

–î–∞–µ—à—å 5–∫ RPS update ‚Äî –∏ Postgres —É–º–∏—Ä–∞–µ—Ç.

### ‚úî –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ç—É—Ç –ª–∏–Ω–µ–π–Ω–æ, –Ω–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç—ë—Ç –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ

–ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è –ë–î –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Ç—è–Ω—É—Ç—å ‚Äú–≤ –ø–∏–∫–µ‚Äù.

–¢—É—Ç –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—É—Ç—å –±–æ–ª–∏.

---

# üß† **2. –ü–æ—è—Å–Ω—è–µ–º —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º (1 –º–∏–Ω—É—Ç–∞)**

–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π:

> ‚Äú–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–µ–ª–∏–º –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ë–î‚Äù.

–û–±—ã—á–Ω–æ –¥–µ–ª–∞—é—Ç –≤–æ—Ç —Ç–∞–∫:

```text
shard = userId % 8
```

–®–∞—Ä–¥–æ–≤ 8.
–î–∞–Ω–Ω—ã–µ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è ‚Äú—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ‚Äù.
–ñ–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞.
–¢—ã —Ö–æ–¥–∏—à—å –ø–æ –æ—Ñ–∏—Å—É, –∫–∞–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å.

–ê –ø–æ—Ç–æ–º –Ω–∞—Å—Ç—É–ø–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å.

---

# üß® **3. –ë–æ–ª—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è (3‚Äì4 –º–∏–Ω—É—Ç—ã)**

–≠—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ —É —Å–ª—É—à–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∞—Ç—å —á–µ—Å–∞—Ç—å—Å—è –ª–∞–¥–æ–Ω–∏.

### ‚ùå 3.1. Hot key –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–ª—Å—è

–ï—Å–ª–∏ userId=42 –¥–∞—ë—Ç 30% –Ω–∞–≥—Ä—É–∑–∫–∏ ‚Äî –º–æ–¥—É–ª—å —Ç–µ–±–µ –Ω–µ –ø–æ–º–æ–∂–µ—Ç.
–û–Ω –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–º–∞–µ—Ç shard #2 –≤–º–µ—Å—Ç–æ –≤—Å–µ–π –±–∞–∑—ã.

### ‚ùå 3.2. –¢—ã *–Ω–∏–∫–æ–≥–¥–∞* –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å —á–∏—Å–ª–æ —à–∞—Ä–¥–æ–≤

–ü–æ—Ç–æ–º—É —á—Ç–æ:

```
userId % 8 -> userId % 9
```

‚Üí 100% –∫–ª—é—á–µ–π –º–∏–≥—Ä–∏—Ä—É—é—Ç
‚Üí –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–µ–∑–∂–∞—é—Ç
‚Üí –∫–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è
‚Üí downtime
‚Üí –≤—Å–µ –≤ –ø–∞–Ω–∏–∫–µ –±–µ–≥–∞—é—Ç –∫–∞–∫ –∫—É—Ä—ã –±–µ–∑ –≥–æ–ª–æ–≤—ã.

### ‚ùå 3.3. JOIN –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–µ—Ç–µ–≤–æ–π –æ–±—Ö–æ–¥

User –Ω–∞ shard1
Orders –Ω–∞ shard3
Payments –Ω–∞ shard7

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä cross-shard –æ–ø–µ—Ä–∞—Ü–∏–π.

### ‚ùå 3.4. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã

–î–∞–∂–µ –±–∞–Ω–∞–ª—å–Ω–æ–µ:

```
—Å–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å + —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
```

—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è distributed transaction.

### ‚ùå 3.5. –õ—é–±–æ–π RANGE / FILTER ‚Üí –æ–±—Ö–æ–¥ –≤—Å–µ—Ö —à–∞—Ä–¥–æ–≤

‚Äú–ü–æ–∫–∞–∂–∏ –≤—Å–µ—Ö –∫—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ –≤—á–µ—Ä–∞‚Äù
‚Üí –∑–∞–ø—Ä–æ—Å —à–ª—ë—Ç—Å—è –Ω–∞ –≤—Å–µ —à–∞—Ä–¥—ã.

–î–∏–∞–≥—Ä–∞–º–º–∞:

```mermaid
sequenceDiagram
User->>Router: /orders?date=2024-10-21
Router->>Shard1: fetch range
Router->>Shard2: fetch range
Router->>Shard3: fetch range
Router->>Shard4: fetch range
Shard1-->>Router: partial data
Shard2-->>Router: partial data
Shard3-->>Router: partial data
Shard4-->>Router: partial data
Router->>User: merged result
```

–ò —Ç–∞–∫ ‚Äî –¥–ª—è –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ shard key.

---

# ‚öîÔ∏è **4. –ü–µ—Ä–µ—Ö–æ–¥: –ø–æ—á–µ–º—É cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–∏–∑–±–µ–∂–Ω—ã (1 –º–∏–Ω—É—Ç–∞)**

–û—á–µ–Ω—å –≤–∞–∂–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å:

> –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É,
> –Ω–æ –ª–æ–º–∞–µ—Ç –ø—Ä–∏–≤—ã—á–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.

Cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ –ù–ï –±–∞–≥.
–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–ª–µ–¥—Å—Ç–≤–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.

–ò —Ç–µ–ø–µ—Ä—å –≤–æ–ø—Ä–æ—Å:

**–ö–∞–∫ —Å —ç—Ç–∏–º –∂–∏—Ç—å?**

---

# üß© **5. –ö–∞—Ç–∞–ª–æ–≥ cross-shard –æ–ø–µ—Ä–∞—Ü–∏–π (2 –º–∏–Ω—É—Ç—ã)**

–ß—ë—Ç–∫–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º, —á—Ç–æ–±—ã —Å–ª—É—à–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–ª –º–∞—Å—à—Ç–∞–±—ã –∞–¥–∞:

### ‚úî Cross-shard JOIN

–î–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —à–∞—Ä–¥–∞—Ö ‚Üí join –ø–æ —Å–µ—Ç–∏.

### ‚úî Cross-shard Transactions

–ù—É–∂–Ω–∞ atomicity across nodes?
2PC? –£–¥–∞—á–∏.

### ‚úî Cross-shard Aggregations

–°—É–º–º—ã / —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ / counter ‚Äî –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ.

### ‚úî Cross-shard Range Queries

–ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ, —Ñ–∏–ª—å—Ç—Ä—ã ‚Äî —Ç—Ä–µ–±—É—é—Ç –æ–±—Ö–æ–¥–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤.

### ‚úî Cross-shard Filtering

–§–∏–ª—å—Ç—Ä—ã –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º ‚Üí –≤—Å–µ —à–∞—Ä–¥—ã.

–¢—É—Ç —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –º–æ—Ä–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤ —É–∑–Ω–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏.

---

# üõ† **6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ—à–µ–Ω–∏—è cross-shard –±–æ–ª–∏ (–æ—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ ‚Äî 5‚Äì7 –º–∏–Ω—É—Ç)**

–ò–¥—ë–º –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –±–æ–µ–≤—ã–º —Ç–µ—Ö–Ω–∏–∫–∞–º.
–ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∏–Ω–∂–µ–Ω–µ—Ä–∏—è ‚Äî —ç—Ç–æ —Ä–µ–º–µ—Å–ª–æ, –Ω–µ –º–∞–≥–∏—è.

---

## üü¶ 6.1. Data Locality (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π shard key)

–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:

> –õ—É—á—à–∏–π cross-shard JOIN ‚Äî —ç—Ç–æ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –Ω—É–∂–µ–Ω.

### –ö–∞–∫ —ç—Ç–æ –¥–µ–ª–∞—é—Ç:

* —à–∞—Ä–¥–∏—Ä—É—é—Ç –ø–æ userId, –µ—Å–ª–∏ –≤—Å—ë –≤–æ–∫—Ä—É–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* —à–∞—Ä–¥–∏—Ä—É—é—Ç –ø–æ tenantId –≤ SaaS
* —à–∞—Ä–¥–∏—Ä—É—é—Ç –ø–æ –º–∞–≥–∞–∑–∏–Ω—É –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
* —à–∞—Ä–¥–∏—Ä—É—é—Ç –ø–æ chatId –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö

### –ü—Ä–∏–º–µ—Ä (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
orders –ø–æ orderId
‚Üí userId –≤ –¥—Ä—É–≥–æ–º —à–∞—Ä–¥–µ
‚Üí –≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
orders –ø–æ userId
‚Üí –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º
‚Üí JOIN –ø–æ—á—Ç–∏ –Ω–µ –Ω—É–∂–µ–Ω

–≠—Ç—É –º—ã—Å–ª—å –Ω–∞–¥–æ –≤–±–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—é –≤ –º–æ–∑–≥.

---

## üüß 6.2. –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ JOIN

–ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:

> –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞ –æ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä—ã:

* username —Ö—Ä–∞–Ω–∏–º –ø—Ä—è–º–æ –≤ order
* –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ —Ö—Ä–∞–Ω–∏–º –ø—Ä—è–º–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ—Å—Ç–∞
* –∫–µ—à–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ

–î–∏–∞–≥—Ä–∞–º–º–∞:

```mermaid
graph TD
A[User Service] -->|username| B[Orders DB]
```

–î–∞, –¥–∞–Ω–Ω—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è.
–î–∞, –Ω—É–∂–Ω–∞ eventual consistency.
–ù–æ JOIN –∏—Å—á–µ–∑–∞–µ—Ç ‚Üí latency –ø–∞–¥–∞–µ—Ç.

---

## üü© 6.3. Scatter-Gather (Fan-Out)

–¢–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç MongoDB, Elastic, Bigtable, Solr.

### –ü—Ä–æ—Ü–µ—Å—Å:

1. –†–∞–∑–æ—Å–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å–µ —à–∞—Ä–¥—ã
2. –ü–æ–ª—É—á–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –°–º–µ—Ä–∂–∏—Ç—å
4. –û—Ç–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É

–ü—Ä–æ–±–ª–µ–º–∞:

> –û–¥–∏–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π —à–∞—Ä–¥ = –º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.

Tail latency x N.

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

* –∑–∞—Ä–∞–Ω–µ–µ –∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ —à–∞—Ä–¥—ã –Ω—É–∂–Ω—ã
* early cutoff
* shard filtering
* pre-indexing

---

## üü® 6.4. Routing Index (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å)

–¢–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç:

* Cassandra
* Spanner
* Elasticsearch
* Solr
* Pinterest graph DB

–ò–¥–µ—è:

> –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞/–∏–Ω–¥–µ–∫—Å —Ö—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: –≥–¥–µ —á—Ç–æ –ª–µ–∂–∏—Ç.

–ü—Ä–∏–º–µ—Ä:

```
age: 18-25 ‚Üí shards [1, 7, 9]
premium = true ‚Üí shard 3
```

–¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å:

```
SELECT * FROM USERS WHERE age BETWEEN 18 AND 25
```

–∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 3 —à–∞—Ä–¥–∞ –≤–º–µ—Å—Ç–æ 30.

---

## üü™ 6.5. Cross-shard Transactions ‚Üí Saga

–¢—ã –≥–æ–≤–æ—Ä–∏—à—å:

> ‚Äú–°–¥–µ–ª–∞–µ–º 2PC‚Äù.

–ò DBA –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç –ø–æ–∫—É—Ä–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞.

### –ü–æ—á–µ–º—É 2PC = –∞–¥:

* coordinator –º–æ–∂–µ—Ç —É–º–µ—Ä–µ—Ç—å
* global locks
* high latency
* cluster-wide stalls

–ü–æ—ç—Ç–æ–º—É:

‚úî Saga
‚úî Outbox + CDC
‚úî Event-driven async workflow
‚úî Temporal / Conductor / Camunda

–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:

> –í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –Ω–µ –±—ã–≤–∞–µ—Ç ACID.
> –ë—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ eventual consistency + –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## üü• 6.6. Pre-aggregation (MapReduce —Å—Ç–∏–ª—å)

Facebook, YouTube, TikTok –¥–µ–ª–∞—é—Ç —Ç–∞–∫:

* –∫–∞–∂–¥—ã–π —à–∞—Ä–¥ —Å—á–∏—Ç–∞–µ—Ç —Å–≤–æ—é —á–∞—Å—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
* –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü—Ä–∏–º–µ—Ä:

```
views_total = sum(views_shard_1...views_shard_N)
```

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

* –æ–ø–µ—Ä–∞—Ü–∏–∏ O(shards), –∞ –Ω–µ O(rows)
* –ª–∏–Ω–µ–π–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

# üß® **7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ cross-shard (1‚Äì2 –º–∏–Ω—É—Ç—ã)**

–ö–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫:

* –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã scatter-gather
* –Ω–µ –¥–µ–ª–∞—Ç—å ORDER BY global
* —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –∏ –º–µ—Ä–∂–∏—Ç—å
* –∏–∑–±–µ–≥–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö JOIN
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch-–∑–∞–ø—Ä–æ—Å—ã
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bloom filters –¥–ª—è shard filtering
* –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å hot keys –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π tier
* –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å fan-out –ª–∏–º–∏—Ç–∞–º–∏

---

# ‚ò†Ô∏è **8. –ê–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω—ã (–±–ª–æ–∫ –±–æ–ª–∏, 1 –º–∏–Ω—É—Ç–∞)**

### ‚ùå ‚ÄúJOIN —á–µ—Ä–µ–∑ REST –¥—Ä—É–≥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞‚Äù

–ú–æ–ª–∏—Å—å, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ —Ç–∞–∫ –Ω–µ –¥–µ–ª–∞–ª.

### ‚ùå ‚Äú–ú—ã –¥–æ–≥–æ–≤–æ—Ä–∏–º—Å—è –ø—Ä–æ ACID –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏‚Äù

–¢–∞–º —Ç–æ–ª—å–∫–æ –±–æ–ª—å, –∫—Ä–æ–≤—å –∏ distributed deadlock.

### ‚ùå ‚Äú–§–∞–Ω-–∞—É—Ç –Ω–∞ –≤—Å–µ —à–∞—Ä–¥—ã –≤—Å–µ–≥–¥–∞‚Äù

–£–±—å—ë—Ç tail latency –≤ 10√ó.

### ‚ùå ‚Äú–ü—É—Å—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–∞–º —Å–æ–±–µ—Ä—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤‚Äù

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å, –∫–∞–∫ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ.

---

# üéØ **9. –ò—Ç–æ–≥–æ–≤–∞—è –º—ã—Å–ª—å (30 —Å–µ–∫—É–Ω–¥)**

–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–∞—ë—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.
–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –±–æ–ª–∏.

> Cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –Ω–µ –æ—à–∏–±–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
> –≠—Ç–æ —Ü–µ–Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.

–ê –¥–∞–ª—å—à–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –µ—â—ë –±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

üëâ **–ö–∞–∫ –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —à–∞—Ä–∞–º–∏ –ë–ï–ó downtime?**
üëâ **–ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É?**
üëâ **–ö–∞–∫ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —à–∞—Ä–¥–∏–Ω–≥, –∫–æ–≥–¥–∞ –±–∏–∑–Ω–µ—Å –ø–æ–º–µ–Ω—è–ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?**

–ò —ç—Ç–æ ‚Äî —Å–ª–µ–¥—É—é—â–∞—è —Ç–µ–º–∞:
**Rebalancing & Online Migrations –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫.**
