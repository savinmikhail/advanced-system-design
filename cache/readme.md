# –°—Ü–µ–Ω–∞—Ä–∏–π: –ß–∞—Å—Ç—å 1. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫—ç—à–∞

**–î–æ–º–µ–Ω –ø—Ä–∏–º–µ—Ä–æ–≤:** –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω / –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å  
**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 35-45 –º–∏–Ω—É—Ç  
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** Middle+ backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏

---

## –í–í–ï–î–ï–ù–ò–ï (1-2 –º–∏–Ω—É—Ç—ã)

–ü—Ä–∏–≤–µ—Ç! –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é —á–∞—Å—Ç—å –∫—É—Ä—Å–∞ –ø–æ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –¥–∏–∑–∞–π–Ω—É. –í –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≥–ª–∞–≤–∞—Ö –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –ø—Ä–æ –∫—ç—à –Ω–∞ —É—Ä–æ–≤–Ω–µ "–≤–æ—Ç Redis, –æ–Ω —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ". –≠—Ç–æ –ø—Ä–∞–≤–¥–∞, –Ω–æ –æ—á–µ–Ω—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ.

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –µ—â—ë –∏ –æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—ç—à –ª–µ–≥–∫–æ –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–µ ‚Äî –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–µ—Ä–≤–∏—Å –∏–ª–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –≤–æ–æ–±—â–µ –∫–ª–∞–¥—ë—Ç —Å–∏—Å—Ç–µ–º—É. –ò –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Ä–∞–∑–Ω—ã–º–∏, –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º –º—ã –≤–µ—Ä–Ω—ë–º—Å—è –≤ –∫–æ–Ω—Ü–µ —ç—Ç–æ–π —á–∞—Å—Ç–∏.

–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ "—É—Å–∫–æ—Ä–∏—Ç–µ–ª—å". –≠—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∫–∞–∫ —Å–ø–∞—Å—Ç–∏ –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π, —Ç–∞–∫ –∏ —Å–æ–∑–¥–∞—Ç—å —Ç—Ä—É–¥–Ω–æ–¥–µ–±–∞–∂–∏–º—ã–µ –±–∞–≥–∏, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞:
1. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –∫—ç—à–∞? (–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
2. –ö–∞–∫ –¥–µ—Ä–∂–∞—Ç—å –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ? (Cache Coherence)
3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ –≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π? (–°–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)

–î–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ä–∑–∏–Ω–∞–º–∏, –∑–∞–∫–∞–∑–∞–º–∏ ‚Äî –≤—Å—ë –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏.

–ü–æ–µ—Ö–∞–ª–∏!

---

## –ë–õ–û–ö 1. –ú–û–î–ï–õ–¨ –ö–≠–®–ê –ò –ë–ê–ó–û–í–´–ï –ü–ê–¢–¢–ï–†–ù–´ (3-5 –º–∏–Ω—É—Ç)

### 1.1. –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –∫—ç—à –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ?

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–æ–ª–∏. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: —É –≤–∞—Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å, –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç. –í—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º –∫—É—Ä—Å–æ–≤.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –¥—ë—Ä–≥–∞–µ—Ç —ç—Ç–æ—Ç API. –£ –≤–∞—Å 200 —Ç—ã—Å—è—á –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í–Ω–µ—à–Ω–∏–π API –Ω–µ –≤–∞—à, –æ–Ω –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å, —Ç–æ—Ä–º–æ–∑–∏—Ç—å –∏–ª–∏ –±–∞–Ω–∞–ª—å–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Å –∑–∞ DDoS.

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫—É—Ä—Å—ã –∏ –∫–ª–∞–¥—ë—Ç –∏—Ö –≤ Redis. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∏—Ç–∞—é—Ç –∏–∑ –∫—ç—à–∞, –∞ –Ω–µ –ª—É–ø—è—Ç –≤–Ω–µ—à–Ω–∏–π API.

–≠—Ç–æ —Ç–∏–ø–∏—á–Ω—ã–π –∫–µ–π—Å. –ö—ç—à –Ω—É–∂–µ–Ω –¥–ª—è:
- **–†–∞–∑–≥—Ä—É–∑–∫–∏ –ë–î –∏ –≤–Ω–µ—à–Ω–∏—Ö API** ‚Äî –≤–º–µ—Å—Ç–æ 100k –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É –¥–µ–ª–∞–µ–º 100
- **–£—Å–∫–æ—Ä–µ–Ω–∏—è –≥–æ—Ä—è—á–∏—Ö —á—Ç–µ–Ω–∏–π** ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ –∑–∞ 2ms –≤–º–µ—Å—Ç–æ 50ms –∏–∑ –ë–î
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ—Ä–æ–≥–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã, –æ—Ç—á—ë—Ç—ã

–ö—ç—à –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞—Ö: **–±—ã—Å—Ç—Ä—ã–π, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É—Å—Ç–∞—Ä–µ–≤–∞—é—â–∏–π —Å–ª–æ–π —Ä—è–¥–æ–º —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã**.

–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **Hit rate** ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ
- **Latency** ‚Äî –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∏–∑ –∫—ç—à–∞ vs –∏–∑ –ë–î
- **TTL** (Time To Live) ‚Äî –∫–∞–∫ –¥–æ–ª–≥–æ –¥–∞–Ω–Ω—ã–µ –∂–∏–≤—É—Ç –≤ –∫—ç—à–µ

–ë–∞–∑–æ–≤–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è:
- `cache hit` / `cache miss` ‚Äî –Ω–∞—à–ª–∏/–Ω–µ –Ω–∞—à–ª–∏ –≤ –∫—ç—à–µ
- `hot key` ‚Äî –æ—á–µ–Ω—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–≤–∞—Ä –¥–Ω—è)
- `stale data` ‚Äî —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ

### 1.2. –°–ª–æ–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è: –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–¢–µ–ø–µ—Ä—å –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: —É –Ω–∞—Å –Ω–µ –æ–¥–∏–Ω –∫—ç—à, –∞ **—Ü–µ–ª–∞—è –ø–∏—Ä–∞–º–∏–¥–∞ —Å–ª–æ—ë–≤**.

```mermaid
graph TB
    Client[üë§ –ö–ª–∏–µ–Ω—Ç]
    Browser[üåê –ë—Ä–∞—É–∑–µ—Ä –∫—ç—à<br/>Cache-Control, ETag]
    CDN[‚òÅÔ∏è CDN / Edge<br/>CloudFlare, CloudFront]
    Gateway[üö™ API Gateway]
    Backend1[‚öôÔ∏è Backend —Å–µ—Ä–≤–µ—Ä 1<br/>L1: in-process –∫—ç—à]
    Backend2[‚öôÔ∏è Backend —Å–µ—Ä–≤–µ—Ä 2<br/>L1: in-process –∫—ç—à]
    Redis[(üî¥ Redis –∫–ª–∞—Å—Ç–µ—Ä<br/>L2: distributed cache)]
    DB[(üóÑÔ∏è PostgreSQL<br/>Source of Truth)]
    
    Client --> Browser
    Browser --> CDN
    CDN --> Gateway
    Gateway --> Backend1
    Gateway --> Backend2
    Backend1 --> Redis
    Backend2 --> Redis
    Redis --> DB
    
    style Browser fill:#e1f5ff
    style CDN fill:#fff4e1
    style Backend1 fill:#ffe1f5
    style Backend2 fill:#ffe1f5
    style Redis fill:#ffe1e1
    style DB fill:#e1ffe1
```

**–ß—Ç–æ –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–µ—Ä–∂–∏–º –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ:**

| –°–ª–æ–π | –ß—Ç–æ –ª–µ–∂–∏—Ç | –¢–∏–ø–∏—á–Ω—ã–π TTL |
|------|-----------|--------------|
| **–ë—Ä–∞—É–∑–µ—Ä** | JS/CSS/–∫–∞—Ä—Ç–∏–Ω–∫–∏, –∫—É—Å–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ | 1 –¥–µ–Ω—å - 1 –Ω–µ–¥–µ–ª—è |
| **CDN** | –ú–µ–¥–∏–∞, —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤, —Å—Ç–∞—Ç–∏–∫–∞ | 5-60 –º–∏–Ω—É—Ç |
| **L1 (in-process)** | –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø—Ä–∞–≤–∞, —Ñ–∏—á–∞-—Ñ–ª–∞–≥–∏ | 30-60 —Å–µ–∫—É–Ω–¥ |
| **L2 (Redis)** | –°–µ—Å—Å–∏–∏, –∫–æ—Ä–∑–∏–Ω—ã, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, —Å—á—ë—Ç—á–∏–∫–∏ | 5 –º–∏–Ω—É—Ç - 1 —á–∞—Å |
| **–ë–î** | Source of Truth, –∏–Ω–¥–µ–∫—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤—å—é—Ö–∏ | - |

### 1.3. –ë–∞–∑–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: Cache-Aside

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω ‚Äî **Cache-Aside** (lazy loading).

**–ü—Å–µ–≤–¥–æ–∫–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ (PHP + Symfony):**

```php
<?php

use Doctrine\DBAL\Connection;
use Psr\Cache\CacheItemPoolInterface;

final class ProductService
{
    public function __construct(
        private Connection $connection,
        private CacheItemPoolInterface $cache, // Symfony Cache (Redis adapter)
    ) {}

    public function getProduct(int $productId): ?array
    {
        // –®–∞–≥ 1: –ø—Ä–æ–≤–µ—Ä—è–µ–º Redis (—á–µ—Ä–µ–∑ Symfony Cache)
        $cacheKey = sprintf('product.%d', $productId);
        $item = $this->cache->getItem($cacheKey);

        if ($item->isHit()) {
            // Cache HIT ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
            return $item->get();
        }

        // –®–∞–≥ 2: Cache MISS ‚Äî –∏–¥—ë–º –≤ PostgreSQL
        $product = $this->connection->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null; // –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
        }

        // –®–∞–≥ 3: –∫–ª–∞–¥—ë–º –≤ –∫—ç—à —Å TTL 5 –º–∏–Ω—É—Ç
        $item->set($product);
        $item->expiresAfter(300);
        $this->cache->save($item);

        return $product;
    }
}
```

**Flow –∑–∞–ø—Ä–æ—Å–∞ "—Ç–æ–≤–∞—Ä ID=123":**

```mermaid
sequenceDiagram
    participant Client as –ö–ª–∏–µ–Ω—Ç
    participant Backend as Backend —Å–µ—Ä–≤–µ—Ä
    participant L1 as L1 –∫—ç—à<br/>(in-process)
    participant Redis as Redis (L2)
    participant DB as PostgreSQL
    
    Client->>Backend: GET /products/123
    Backend->>L1: –ü—Ä–æ–≤–µ—Ä–∫–∞ L1
    L1-->>Backend: MISS
    Backend->>Redis: GET product:123
    Redis-->>Backend: MISS
    Backend->>DB: SELECT * FROM products WHERE id=123
    DB-->>Backend: {id: 123, name: "iPhone", price: 1000}
    Backend->>Redis: SET product:123, TTL=300s
    Backend->>L1: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ L1
    Backend-->>Client: 200 OK, –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
    
    Note over Backend,Redis: –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å
    Client->>Backend: GET /products/123
    Backend->>L1: –ü—Ä–æ–≤–µ—Ä–∫–∞ L1
    L1-->>Backend: HIT ‚úÖ (latency: 0.1ms)
    Backend-->>Client: 200 OK, –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
```

**–í–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:** –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç, –µ—Å–ª–∏ –ø–æ–∫–∞ –º—ã —á–∏—Ç–∞–ª–∏ –∏–∑ –ë–î, –∫—Ç–æ-—Ç–æ –æ–±–Ω–æ–≤–∏–ª —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞?

‚Üí –≠—Ç–æ –ø–æ–¥–≤–æ–¥–∫–∞ –∫ –Ω–∞—à–µ–π –≥–ª–∞–≤–Ω–æ–π —Ç–µ–º–µ: **Cache Coherence**

### 1.4. –ú–æ—Å—Ç –∫ —Å–ª–µ–¥—É—é—â–∏–º –±–ª–æ–∫–∞–º

–ò—Ç–∞–∫, —É –Ω–∞—Å —Ç–µ–ø–µ—Ä—å –Ω–µ –æ–¥–∏–Ω –∫—ç—à, –∞ –ø–∏—Ä–∞–º–∏–¥–∞ —Å–ª–æ—ë–≤. –í –∫–∞–∂–¥–æ–º —Å–ª–æ–µ –ª–µ–∂–∞—Ç –∫–æ–ø–∏–∏ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö.

**–¢—Ä–∏ –≥–ª–∞–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–∞:**

1. **–ö–∞–∫ –¥–µ—Ä–∂–∞—Ç—å —ç—Ç–∏ –∫–æ–ø–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏?**  
   ‚Üí –ë–ª–æ–∫ 2 (Cache Coherence)

2. **–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —É—Ä–æ–≤–Ω—è–º?**  
   ‚Üí –ë–ª–æ–∫ 3 (–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

3. **–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ –≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π?**  
   ‚Üí –ë–ª–æ–∫ 4 (–°–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)

–î–∞–ª—å—à–µ —É –Ω–∞—Å —Ç—Ä–∏ –ø–æ–¥–ø—É–Ω–∫—Ç–∞, –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

---

## –ë–õ–û–ö 2 (A). CACHE COHERENCE –í –†–ê–°–ü–†–ï–î–ï–õ–Å–ù–ù–´–• –°–ò–°–¢–ï–ú–ê–• (10-15 –º–∏–Ω—É—Ç)

### 2.1. –ò–Ω—Ü–∏–¥–µ–Ω—Ç: –ø–æ—á–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –≤ —Ç–æ–º –∂–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ –∏ —Å —Ç–µ–º –∂–µ —Ç–æ–≤–∞—Ä–æ–º, –ø—Ä–æ –∫–æ—Ç–æ—Ä—ã–π –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –≤ –±–ª–æ–∫–µ –ø—Ä–æ Cache-Aside:

**08:00** ‚Äî –í –∞–¥–º–∏–Ω–∫–µ –º–µ–Ω—è—é—Ç —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ —Å 900‚ÇΩ –Ω–∞ 1000‚ÇΩ  
**08:00:05** ‚Äî –¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Å–Ω–æ–≤–Ω–æ–º Redis-–∫—ç—à–µ ‚úÖ  
**08:00:10** ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞ –∏ –≤–∏–¥–∏—Ç –Ω–æ–≤—É—é —Ü–µ–Ω—É 1000‚ÇΩ  
**08:00:11** ‚Äî –¢–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É/–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞, –∞ —Ç–∞–º –ø–æ‚Äë–ø—Ä–µ–∂–Ω–µ–º—É 900‚ÇΩ ‚ùå

**–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?**

```mermaid
graph LR
    subgraph "–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        A["–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞: 1000‚ÇΩ ‚úÖ"]
        B["–ö–æ—Ä–∑–∏–Ω–∞/—á–µ–∫–∞—É—Ç: 900‚ÇΩ ‚ùå"]
    end

    subgraph "–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º"
        DB["–ë–î: price = 1000‚ÇΩ"]
        R1["Redis (product:123): 1000‚ÇΩ"]
        R2["L1 –∫—ç—à —á–µ–∫–∞—É—Ç–∞: 900‚ÇΩ (stale)"]
        CDN["CDN: 900‚ÇΩ (stale)"]
    end

    A -. —á–∏—Ç–∞–µ—Ç .-> R1
    A -. —á–∏—Ç–∞–µ—Ç .-> DB
    B -. —á–∏—Ç–∞–µ—Ç .-> R2
    B -. —á–∏—Ç–∞–µ—Ç .-> CDN

    classDef fresh fill:#e6f4ea,stroke:#2e7d32,color:#1b5e20;
    classDef stale fill:#ffebee,stroke:#c62828,color:#b71c1c;

    class DB,R1 fresh;
    class R2,CDN stale;
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –¶–µ–Ω–∞ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ç–æ–≤–∞—Ä–∞ –∂–∏–≤—ë—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–∏–ª–∞—Å—å)
- –ö–ª—é—á `product:123` –≤ Redis (–æ–±–Ω–æ–≤–∏–ª—Å—è)
- L1 –∫—ç—à –±—ç–∫–µ–Ω–¥–∞ —á–µ–∫–∞—É—Ç–∞ (–Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è!)
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ –≤ CDN (–Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å!)

–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ **cache coherence** ‚Äî –∫–æ–≥–¥–∞ –∫–æ–ø–∏–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –æ–±—ä–µ–∫—Ç–∞ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∫—ç—à–∞–º–∏.

### 2.2. –ß—Ç–æ —Ç–∞–∫–æ–µ Cache Coherence?

**Cache coherence** ‚Äî —ç—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –≤—Å–µ –∫–æ–ø–∏–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–Ω—ã—Ö –∫—ç—à–∞—Ö –æ—Å—Ç–∞—é—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–º–∏.

**–í–∞–∂–Ω–æ:** –≠—Ç–æ –Ω–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ:
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ë–î** (ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- **CAP-—Ç–µ–æ—Ä–µ–º–∞** (–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –ë–î)

Cache coherence ‚Äî —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ **–∫—ç—à–∏**, –∞ –Ω–µ –ø—Ä–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

**–£—Å–ª–æ–≤–∏–µ coherence:** –ù–µ—Ç –¥–≤—É—Ö –∫—ç—à–µ–π —Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.

–ù–æ —Ç—É—Ç –≤—Å—Ç–∞—ë—Ç –≤–æ–ø—Ä–æ—Å: **–∫–∞–∫ –±—ã—Å—Ç—Ä–æ** –º—ã —Ç—Ä–µ–±—É–µ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏?
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (strong coherence)? ‚Äî –¥–æ—Ä–æ–≥–æ
- –í —Ç–µ—á–µ–Ω–∏–µ —Å–µ–∫—É–Ω–¥—ã (eventual coherence)? ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ
- –í —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã? ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–∏–∑–Ω–µ—Å–∞

### 2.3. –ê–Ω–∞–ª–æ–≥–∏—è —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã–º–∏ –∫—ç—à–∞–º–∏

–í CPU –µ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∫—ç—à–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä **MESI**:
- **M**odified ‚Äî —è–¥—Ä–æ –∏–∑–º–µ–Ω–∏–ª–æ –¥–∞–Ω–Ω—ã–µ
- **E**xclusive ‚Äî —Ç–æ–ª—å–∫–æ —É –æ–¥–Ω–æ–≥–æ —è–¥—Ä–∞
- **S**hared ‚Äî –∫–æ–ø–∏–∏ —É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–¥–µ—Ä
- **I**nvalid ‚Äî –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–º—É —á—Ç–æ:
‚úÖ –ñ—ë—Å—Ç–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π  
‚úÖ –ù–∞–¥—ë–∂–Ω–∞—è —à–∏–Ω–∞ —Å–≤—è–∑–∏  
‚úÖ –ú–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏

–í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –≤—Å—ë —Ö—É–∂–µ:
‚ùå –ù–µ–Ω–∞–¥—ë–∂–Ω–∞—è —Å–µ—Ç—å (–ø–∞–∫–µ—Ç—ã —Ç–µ—Ä—è—é—Ç—Å—è)  
‚ùå –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (–æ—Ç 1ms –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã)  
‚ùå –ù–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —á–∞—Å–æ–≤ (—Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –î–¶)

**–í—ã–≤–æ–¥:** –ù–∞–º –Ω—É–∂–Ω—ã –¥—Ä—É–≥–∏–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ "–≥—Ä—è–∑–Ω–æ–º" –º–∏—Ä–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

### 2.4. Race Condition –≤ Cache-Aside

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –≥–æ–Ω–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.

**–ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (PHP + Symfony, DBAL + Redis):**

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class ProductPriceUpdater
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    public function updateProduct(int $productId, float $newPrice): void
    {
        // –®–∞–≥ 1: –æ–±–Ω–æ–≤–ª—è–µ–º –ë–î
        $this->connection->executeStatement(
            'UPDATE products SET price = :price WHERE id = :id',
            ['price' => $newPrice, 'id' => $productId],
        );

        // –®–∞–≥ 2: –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
        $cacheKey = sprintf('product.%d', $productId);
        $this->redis->del([$cacheKey]);
    }
}
```

**Timeline –≥–æ–Ω–∫–∏:**

```mermaid
sequenceDiagram
    participant A as Thread A<br/>(–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
    participant B as Thread B<br/>(—á—Ç–µ–Ω–∏–µ)
    participant Redis as Redis
    participant DB as PostgreSQL
    
    Note over A,DB: t=0: –¶–µ–Ω–∞ –≤ –ë–î = 900‚ÇΩ
    
    A->>DB: UPDATE price = 1000‚ÇΩ
    Note over DB: t=1: –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úÖ<br/>price = 1000‚ÇΩ
    
    B->>Redis: GET product:123
    Redis-->>B: MISS (–∫–ª—é—á –µ—â—ë –Ω–µ —É–¥–∞–ª—ë–Ω)
    
    B->>DB: SELECT price
    DB-->>B: price = 1000‚ÇΩ (–Ω–æ–≤–∞—è —Ü–µ–Ω–∞)
    
    A->>Redis: DELETE product:123
    Note over Redis: t=3: –ö–ª—é—á —É–¥–∞–ª—ë–Ω
    
    B->>Redis: SET product:123 = {price: 900}
    Note over Redis: t=4: –ó–∞–ø–∏—Å–∞–ª–∏ –°–¢–ê–†–£–Æ —Ü–µ–Ω—É! ‚ùå
    
    rect rgb(255, 200, 200)
        Note over Redis: –ö—ç—à —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ<br/>price = 900‚ÇΩ –≤–º–µ—Å—Ç–æ 1000‚ÇΩ
    end
```

**–ß–∏—Å–ª–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:**

–ü—Ä–∏ 10,000 RPS –∏ –æ–∫–Ω–µ –≥–æ–Ω–∫–∏ 100ms:
- ~1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ –æ–∫–Ω–æ
- –ò–∑ –Ω–∏—Ö ~1% –º–æ–≥—É—Ç –∑–∞–ø–∏—Å–∞—Ç—å stale –¥–∞–Ω–Ω—ã–µ
- **= 10 –±–∞–≥–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É** ‚ùå

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ü–µ–Ω—ã, –±–∞–ª–∞–Ω—Å—ã, –ª–∏–º–∏—Ç—ã) —ç—Ç–æ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ!

### 2.5. –¢–∏–ø–∏—á–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∫—ç—à–µ–π

–ì–¥–µ coherence –≤—Å–ø–ª—ã–≤–∞–µ—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö:

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 1: –û–¥–∏–Ω Redis-–∫–ª–∞—Å—Ç–µ—Ä**

```mermaid
graph TB
    B1["Backend 1"]
    B2["Backend 2"]
    B3["Backend 3"]
    Redis["Redis –∫–ª–∞—Å—Ç–µ—Ä (shared cache)"]
    DB["PostgreSQL (source of truth)"]
    
    B1 --> Redis
    B2 --> Redis
    B3 --> Redis
    Redis --> DB

    classDef backend fill:#eceff1,stroke:#607d8b,color:#263238;
    classDef cache fill:#fff3e0,stroke:#fb8c00,color:#4e342e;
    classDef db fill:#e3f2fd,stroke:#1976d2,color:#0d47a1;

    class B1,B2,B3 backend;
    class Redis cache;
    class DB db;
```

**–ü–ª—é—Å—ã:** Coherence –ø—Ä–æ—â–µ ‚Äî –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ  
**–ú–∏–Ω—É—Å—ã:** –ï—Å—Ç—å TTL, —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏ Redis, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 2: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (L1 + L2)**

```mermaid
graph TB
    B1["Backend 1 (L1 in-memory)"]
    B2["Backend 2 (L1 in-memory)"]
    B3["Backend 3 (L1 in-memory)"]
    Redis["Redis (L2 shared)"]
    DB["PostgreSQL"]
    
    B1 --> Redis
    B2 --> Redis
    B3 --> Redis
    Redis --> DB

    classDef backendL1 fill:#f3e5f5,stroke:#8e24aa,color:#4a148c;
    classDef cache fill:#fff3e0,stroke:#fb8c00,color:#4e342e;
    classDef db fill:#e3f2fd,stroke:#1976d2,color:#0d47a1;

    class B1,B2,B3 backendL1;
    class Redis cache;
    class DB db;
```

**–ü–ª—é—Å—ã:** –û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π L1 (–º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã)  
**–ú–∏–Ω—É—Å—ã:** –°–ª–æ–∂–Ω–µ–µ –¥–µ—Ä–∂–∞—Ç—å L1 –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ —Å L2 –∏ –ë–î

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 3: –° CDN/Edge**

```mermaid
graph TB
    CDN[CDN / Edge cache]
    API[API Gateway]
    Backend[Backend + L1]
    Redis[(Redis L2)]
    DB[(PostgreSQL)]
    
    CDN --> API
    API --> Backend
    Backend --> Redis
    Redis --> DB
    
    style CDN fill:#fff4e1
```

**–ü–ª—é—Å—ã:** –û—Ç–ª–∏—á–Ω–∞—è latency –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
**–ú–∏–Ω—É—Å—ã:** CDN –º–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —á–∞—Å—ã ‚Äî —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è coherence

### 2.6. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

–†–∞–∑–±–µ—Ä—ë–º 3 –±–∞–∑–æ–≤—ã—Ö –ø–æ–¥—Ö–æ–¥–∞ (–Ω–µ –≤–µ—Å—å –∑–æ–æ–ø–∞—Ä–∫, –∞ –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏).

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è A: TTL-only (–ª–µ–Ω–∏–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)

**–ò–¥–µ—è:** –ü—Ä–æ—Å—Ç–æ –∂–¥—ë–º, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç—É—Ö–Ω—É—Ç –ø–æ TTL.

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class TtlOnlyCache
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    public function getProduct(int $productId): ?array
    {
        $cacheKey = sprintf('product.%d', $productId);
        $cached = $this->redis->get($cacheKey);

        if ($cached !== null) {
            return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
        }

        $product = $this->connection->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null;
        }

        // –ó–∞–ø–∏—Å—å: –∫–ª–∞–¥—ë–º –≤ Redis —Å TTL 60 —Å–µ–∫—É–Ω–¥
        $this->redis->setex($cacheKey, 60, json_encode($product, JSON_THROW_ON_ERROR));

        return $product;
    }

    public function updateProduct(int $productId, float $newPrice): void
    {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ë–î ‚Äî –∫—ç—à –ø—Ä–æ—Ç—É—Ö–Ω–µ—Ç —Å–∞–º –ø–æ TTL
        $this->connection->executeStatement(
            'UPDATE products SET price = :price WHERE id = :id',
            ['price' => $newPrice, 'id' => $productId],
        );
    }
}
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ
- ‚úÖ –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚úÖ –ù–µ—Ç race conditions —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç stale –¥–∞–Ω–Ω—ã–µ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –õ–µ–Ω—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π
- –°—á—ë—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤/–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ TTL 30-60 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏–µ–º–ª–µ–º)

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è B: Event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ò–¥–µ—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—ã–ª–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö.

```php
<?php

use Doctrine\DBAL\Connection;
use Symfony\Component\Messenger\MessageBusInterface;
use Predis\Client as RedisClient;
use Psr\Cache\CacheItemPoolInterface;

final class ProductUpdatedEvent
{
    public function __construct(
        public readonly int $productId,
        public readonly \DateTimeImmutable $occurredAt,
    ) {}
}

final class ProductServiceWithEvents
{
    public function __construct(
        private Connection $connection,
        private MessageBusInterface $eventBus,
    ) {}

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    public function updateProduct(int $productId, array $data): void
    {
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
        $this->connection->update('products', $data, ['id' => $productId]);

        // 2. –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ
        $this->eventBus->dispatch(
            new ProductUpdatedEvent($productId, new \DateTimeImmutable()),
        );
    }
}

// –ù–∞ –í–°–ï–• backend-—Å–µ—Ä–≤–µ—Ä–∞—Ö —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è:
final class InvalidateProductCacheListener
{
    public function __construct(
        private RedisClient $redis,
        private CacheItemPoolInterface $localCache,
    ) {}

    public function __invoke(ProductUpdatedEvent $event): void
    {
        // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≤–æ –≤—Å–µ—Ö —Å–ª–æ—è—Ö
        $cacheKey = sprintf('product.%d', $event->productId);
        $this->redis->del([$cacheKey]);
        $this->localCache->deleteItem($cacheKey);
    }
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å Pub/Sub:**

```mermaid
graph TB
    DB[(PostgreSQL)]
    PubSub[Redis Pub/Sub<br/>–∏–ª–∏ Kafka]
    B1[Backend 1<br/>subscriber]
    B2[Backend 2<br/>subscriber]
    B3[Backend 3<br/>subscriber]
    Redis[(Redis –∫—ç—à)]
    
    DB -->|1. UPDATE| PubSub
    PubSub -->|2. event| B1
    PubSub -->|2. event| B2
    PubSub -->|2. event| B3
    B1 -->|3. DELETE| Redis
    B2 -->|3. DELETE| Redis
    B3 -->|3. DELETE| Redis
    
    style PubSub fill:#e1f5ff
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞ (<1 —Å–µ–∫—É–Ω–¥—ã –æ–±—ã—á–Ω–æ)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –∫—ç—à–µ–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ù—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Kafka, Redis Pub/Sub, RabbitMQ)
- ‚ùå –ß—Ç–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è? (–Ω—É–∂–µ–Ω fallback –Ω–∞ TTL)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ—Ä–∑–∏–Ω—ã –ø–æ–∫—É–ø–æ–∫
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
- Inventory (–æ—Å—Ç–∞—Ç–∫–∏) —Å –Ω–µ–≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è C: Lease-based –ø–æ–¥—Ö–æ–¥—ã

**–ò–¥–µ—è:** –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü "–ª–∏–∑–∏–Ω–≥–∞" –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤ –ë–î –≤—Å–µ –ª–∏–∑–∏–Ω–≥–∏ –∞–Ω–Ω—É–ª–∏—Ä—É—é—Ç—Å—è.

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class LeaseBasedCache
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    // –ó–∞–ø—Ä–æ—Å —Å "–ª–∏–∑–∏–Ω–≥–æ–º"
    public function getProductWithLease(int $productId): ?array
    {
        $cacheKey = sprintf('product.%d', $productId);
        $leaseKey = sprintf('product.%d.lease', $productId);

        // –ü–æ–ª—É—á–∞–µ–º lease token (–≤–µ—Ä—Å–∏—é)
        $leaseToken = (int) ($this->redis->get($leaseKey) ?? 0);
        $cached = $this->redis->get($cacheKey);

        if ($cached !== null) {
            return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
        }

        // Cache miss ‚Äî —á–∏—Ç–∞–µ–º –∏–∑ –ë–î
        $product = $this->connection->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null;
        }

        // –ü–∏—à–µ–º –≤ –∫—ç—à —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ lease –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
        $currentLease = (int) ($this->redis->get($leaseKey) ?? 0);
        if ($currentLease === $leaseToken) {
            $this->redis->setex(
                $cacheKey,
                300,
                json_encode($product, JSON_THROW_ON_ERROR),
            );
        }

        return $product;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ "–ª–∏–∑–∏–Ω–≥–∏"
    public function updateProduct(int $productId, array $newData): void
    {
        $this->connection->update('products', $newData, ['id' => $productId]);

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º lease –≤–µ—Ä—Å–∏—é: –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏
        $leaseKey = sprintf('product.%d.lease', $productId);
        $this->redis->incr($leaseKey);
    }
}
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç race condition
- ‚úÖ Strong coherence

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –í—ã—Å–æ–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ùå Overhead –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–∑–∏–Ω–≥–∞–º–∏
- ‚ùå –ú–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ë–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤
- –õ–∏–º–∏—Ç—ã (rate limiting, –∫–≤–æ—Ç—ã)
- Inventory —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
- –õ—é–±—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–°–≤—è–∑—å —Å distributed locks:**  
Lease-based –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ fencing tokens –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö.

### 2.7. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –û–∫–Ω–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ü—Ä–∏–º–µ—Ä—ã use-cases |
|-----------|------------------|-----------|-------------------|
| **TTL-only** | –î–æ TTL (—Å–µ–∫—É–Ω–¥—ã/–º–∏–Ω—É—Ç—ã) | –ù–∏–∑–∫–∞—è | –õ–µ–Ω—Ç—ã, —Å—á—ë—Ç—á–∏–∫–∏, –∫–∞—Ç–∞–ª–æ–≥–∏ |
| **Event-based** | <1 —Å–µ–∫—É–Ω–¥—ã | –°—Ä–µ–¥–Ω—è—è | –ü—Ä–æ—Ñ–∏–ª–∏, –∫–æ—Ä–∑–∏–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| **Lease-based** | –ù–µ—Ç (strong coherence) | –í—ã—Å–æ–∫–∞—è | –ë–∞–ª–∞–Ω—Å—ã, –ª–∏–º–∏—Ç—ã, —Ñ–∏–Ω–∞–Ω—Å—ã |

**Golden rule –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:**

> –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏–∏ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π (`DELETE`), –∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–π (`SET`)

–ü–æ—á–µ–º—É?
- `DELETE` –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ ‚Äî —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —Å–∞–º –ø–æ–¥–≥—Ä—É–∑–∏—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
- `SET new_value` —Ä–∏—Å–∫—É–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å stale –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≥–æ–Ω–∫–∞—Ö

**Push vs Pull:**
- **Push** (pub/sub): –∫—ç—à –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è ‚Üí –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ
- **Pull** (polling): –∫—ç—à —Å–∞–º –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ë–î ‚Üí –ø—Ä–æ—â–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

### 2.8. –ü—Ä–∏–º–µ—Ä—ã —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–æ–≤

#### –ö–µ–π—Å 1: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ (latency <10ms)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∫–∏–µ (—Ä–∞–∑ –≤ –¥–µ–Ω—å-–Ω–µ–¥–µ–ª—é)
- –î–æ–ø—É—Å—Ç–∏–º–æ eventual consistency –¥–æ 5 —Å–µ–∫—É–Ω–¥

**–†–µ—à–µ–Ω–∏–µ:**
```php
// L1 (in-process): TTL 30 —Å–µ–∫—É–Ω–¥
// L2 (Redis): TTL 5 –º–∏–Ω—É—Ç
// –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è: pub/sub –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
```

#### –ö–µ–π—Å 2: –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ö—Ä–∏—Ç–∏—á–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –í—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ —á—Ç–µ–Ω–∏–π –∏ –∑–∞–ø–∏—Å–µ–π
- Strong consistency

**–†–µ—à–µ–Ω–∏–µ:**
```php
// –ö—ç—à —Ç–æ–ª—å–∫–æ –¥–ª—è –°–ù–ò–ñ–ï–ù–ò–Ø –Ω–∞–≥—Ä—É–∑–∫–∏, –Ω–æ –ù–ï –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
// L2 (Redis): TTL 5 —Å–µ–∫—É–Ω–¥, lease-based
// –ü—Ä–∏ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ–Ω—å–≥–∞–º–∏ ‚Äî –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ë–î
```

#### –ö–µ–π—Å 3: –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ù–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (—Ç—ã—Å—è—á–∏ –ø–æ–∫—É–ø–æ–∫ –≤ —Å–µ–∫—É–Ω–¥—É)
- –î–æ–ø—É—Å—Ç–∏–º–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —á—É—Ç—å –∑–∞–≤—ã—à–µ–Ω–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```php
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑ –∫—ç—à–∞ (TTL 10 —Å–µ–∫—É–Ω–¥)
// –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ë–î
// –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ë–î —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
```

### 2.9. –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å coherence

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```php
<?php

// 1. –î–æ–ª—è stale reads (—á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
// Target: < 1% –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, < 0.01% –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö
$staleReadRate = $staleReads / $totalReads;

// 2. Hit rate –ø–æ —É—Ä–æ–≤–Ω—è–º
// Target: L1 = 60‚Äì80%, L2 = 80‚Äì95%
$l1HitRate = $l1Hits / $l1Requests;
$l2HitRate = $l2Hits / $l2Requests;

// 3. Latency –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
// Target: < 1 —Å–µ–∫—É–Ω–¥–∞
$invalidationLatency = $timeCacheCleared - $timeEventPublished;

// 4. –ß–∞—Å—Ç–æ—Ç–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–π
// –í–∞–∂–Ω—ã —Å–ø–∞–π–∫–∏ ‚Äî –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏–ª–∏ –¥–∞–Ω–Ω—ã–º–∏
$invalidationRate = $eventsPerSecond;
```

**Chaos testing:**

```bash
# –¢–µ—Å—Ç: –¥–æ–±–∞–≤–ª—è–µ–º 500ms –∑–∞–¥–µ—Ä–∂–∫—É –≤ pub/sub
tc qdisc add dev eth0 root netem delay 500ms

# –°–º–æ—Ç—Ä–∏–º: —Ä–∞—Å—Ç—ë—Ç –ª–∏ stale_read_rate?
# –ï—Å–ª–∏ –¥–∞ ‚Äî –Ω—É–∂–µ–Ω fallback –Ω–∞ TTL –∏–ª–∏ lease
```

**–¢–∏–ø–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–±–µ—Å–µ:**

**Q:** "–ö–∞–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ –≤—ã –¥–∞—ë—Ç–µ?"

**A (—Ö–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç):**
> "–î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî eventual consistency —Å –æ–∫–Ω–æ–º –¥–æ 60 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ TTL.  
> –î–ª—è –±–∞–ª–∞–Ω—Å–æ–≤ ‚Äî read-through —Å –ë–î –Ω–∞ –∫–∞–∂–¥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é, –∫—ç—à —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏.  
> –î–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π ‚Äî event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –æ–∫–Ω–æ–º –¥–æ 5 —Å–µ–∫—É–Ω–¥, fallback –Ω–∞ TTL 5 –º–∏–Ω—É—Ç."

**Q:** "–ö–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫—ç—à –∏ –ë–î –Ω–µ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è?"

**A (—Ö–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç):**
> "1. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π (–≤–∫–ª—é—á–∞–µ–º updated_at –≤ –∫–ª—é—á)
> 2. –ú–µ—Ç—Ä–∏–∫–∏ stale reads —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
> 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π reconciliation job ‚Äî –ø—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∫—ç—à—É –∏ —Å–≤–µ—Ä—è–µ—Ç —Å –ë–î
> 4. –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∞–Ω–æ–º–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç stale_read_rate"

### 2.10. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è Multi-level cache —Å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–æ–º

```mermaid
graph TB
    subgraph "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ UPDATE"
        Browser["üåê –ë—Ä–∞—É–∑–µ—Ä<br/>price: 900‚ÇΩ ‚ùå<br/>(TTL 1 –¥–µ–Ω—å)"]
        CDN["‚òÅÔ∏è CDN<br/>price: 900‚ÇΩ ‚ùå<br/>(TTL 5 –º–∏–Ω)"]
        L1["‚öôÔ∏è L1 –∫—ç—à<br/>price: 1000‚ÇΩ ‚úÖ<br/>(–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω)"]
        Redis["üî¥ Redis<br/>price: 1000‚ÇΩ ‚úÖ<br/>(–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω)"]
        DB["üóÑÔ∏è –ë–î<br/>price: 1000‚ÇΩ ‚úÖ<br/>(source of truth)"]
    end
    
    Browser -.->|—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ<br/>–¥–∞–Ω–Ω—ã–µ| CDN
    CDN -.->|–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ<br/>–æ–±–Ω–æ–≤—è—Ç—Å—è| L1
    L1 --> Redis
    Redis --> DB
    
    style Browser fill:#ffebee
    style CDN fill:#ffebee
    style L1 fill:#90EE90
    style Redis fill:#90EE90
    style DB fill:#90EE90
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë—Ä–∞—É–∑–µ—Ä –∏ CDN –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏!

**–†–µ—à–µ–Ω–∏—è:**
1. –ö–æ—Ä–æ—Ç–∫–∏–π TTL –Ω–∞ CDN (5-15 –º–∏–Ω—É—Ç)
2. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ URL: `/products/123?v=1702345678`
3. Cache-Control —Å `must-revalidate`
4. Webhook –¥–ª—è CDN purge (–¥–æ—Ä–æ–≥–æ, –Ω–æ –±—ã—Å—Ç—Ä–æ)

---

*[–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–∞–π–ª–µ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞]*
# –°—Ü–µ–Ω–∞—Ä–∏–π: –ß–∞—Å—Ç—å 1. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

## –ë–õ–û–ö 3 (B). –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–û–ï –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (10-15 –º–∏–Ω—É—Ç)

### 3.1. –ë–æ–ª—å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è


–ü—Ä–æ CDN –∑–¥–µ—Å—å –≤–∞–∂–Ω–æ –ø—Ä–æ–≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–µ—Ä–∂–∏—Ç –∫–æ–ø–∏–∏ –Ω–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ edge‚Äë—É–∑–ª–∞—Ö –ø–æ –º–∏—Ä—É ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞, –ë–µ—Ä–ª–∏–Ω–∞ –∏ –ú–æ—Å–∫–≤—ã –ø–æ–ø–∞–¥–∞—é—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –∫ –Ω–∏–º edge –∏ —á–∏—Ç–∞—é—Ç –∫—ç—à "–ª–æ–∫–∞–ª—å–Ω–æ", –Ω–µ –¥–æ–ª–µ—Ç–∞—è –¥–æ –Ω–∞—à–µ–≥–æ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–∞. –ó–∞ —ç—Ç–æ –ø–ª–∞—Ç–∏–º —Ç–µ–º, —á—Ç–æ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å–µ—Ç—å –¥–æ –≤—Å–µ—Ö edge‚Äë—É–∑–ª–æ–≤, –ø–æ—ç—Ç–æ–º—É CDN –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∂–∏–≤—ë—Ç —Å –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–º TTL –∏ –±–æ–ª–µ–µ —Å–ª–∞–±–æ–π —Å–≤–µ–∂–µ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö, —á–µ–º backend‚Äë–∫—ç—à.

–í–æ–ø—Ä–æ—Å: **–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–µ—Ä–∂–∞—Ç—å?**

### 3.2. Heatmap: —á—Ç–æ –≥–¥–µ –¥–µ—Ä–∂–∏–º

```mermaid
%%{init: {'theme':'base'}}%%
graph TB
    subgraph "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–ª–æ—è–º –∫—ç—à–∞"
        direction TB
        
        subgraph Browser["üåê –ë—Ä–∞—É–∑–µ—Ä (–∫–ª–∏–µ–Ω—Ç)"]
            B1[–°—Ç–∞—Ç–∏–∫–∞: JS, CSS, —à—Ä–∏—Ñ—Ç—ã]
            B2[–ö–∞—Ä—Ç–∏–Ω–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤]
            B3[Offline-–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Service Worker]
        end
        
        subgraph CDN["‚òÅÔ∏è CDN / Edge"]
            C1[–ú–µ–¥–∏–∞: —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ]
            C2[–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞]
            C3[API-–æ—Ç–≤–µ—Ç—ã —Å Cache-Control]
        end
        
        subgraph L1["‚öôÔ∏è L1 in-process"]
            L1_1[–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π <100KB]
            L1_2[–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
            L1_3[–§–∏—á–∞-—Ñ–ª–∞–≥–∏]
            L1_4[–ö–æ–Ω—Ñ–∏–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è]
        end
        
        subgraph L2["üî¥ L2 Redis"]
            L2_1[–°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π]
            L2_2[–ö–æ—Ä–∑–∏–Ω—ã –ø–æ–∫—É–ø–æ–∫]
            L2_3[–¢–æ–ø-1000 —Ç–æ–≤–∞—Ä–æ–≤]
            L2_4[–ê–≥—Ä–µ–≥–∞—Ç—ã: —Å—á—ë—Ç—á–∏–∫–∏, —Ä–µ–π—Ç–∏–Ω–≥–∏]
            L2_5[–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞]
        end
        
        subgraph DB["üóÑÔ∏è –ë–î"]
            DB1[Source of Truth]
            DB2[–ò–Ω–¥–µ–∫—Å—ã]
            DB3[–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤—å—é—Ö–∏]
        end
    end
    
    style Browser fill:#e1f5ff
    style CDN fill:#fff4e1
    style L1 fill:#ffe1f5
    style L2 fill:#ffe1e1
    style DB fill:#e1ffe1
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞ —Å–ª–æ—è:**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ë—Ä–∞—É–∑–µ—Ä | CDN | L1 | L2 | –ë–î |
|----------|---------|-----|----|----|-----|
| **–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö** | <10MB | <100MB | <100KB | <10MB | Any |
| **Latency** | 0ms | 10-50ms | 0.1ms | 2-5ms | 20-100ms |
| **–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** | –†–µ–¥–∫–æ | –†–µ–¥–∫–æ | –°—Ä–µ–¥–Ω–µ | –ß–∞—Å—Ç–æ | –ü–æ—Å—Ç–æ—è–Ω–Ω–æ |
| **–î–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å stale** | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è | N/A |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å** | Free | $$$ | $ | $$ | $$$ |

### 3.3. Read path —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à

**–ó–∞–ø—Ä–æ—Å –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ—Ö–æ–¥–æ–º:**

```mermaid
sequenceDiagram
    participant Client as üë§ –ö–ª–∏–µ–Ω—Ç
    participant Browser as üåê –ë—Ä–∞—É–∑–µ—Ä
    participant CDN as ‚òÅÔ∏è CDN
    participant Gateway as üö™ Gateway
    participant Backend as ‚öôÔ∏è Backend
    participant L1 as üì¶ L1 cache
    participant Redis as üî¥ Redis
    participant DB as üóÑÔ∏è PostgreSQL
    
    Client->>Browser: GET /products/123
    Browser->>Browser: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    Note over Browser: MISS (–ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç)
    
    Browser->>CDN: GET /products/123
    CDN->>CDN: –ü—Ä–æ–≤–µ—Ä–∫–∞ edge cache
    Note over CDN: MISS
    
    CDN->>Gateway: Proxy –∑–∞–ø—Ä–æ—Å
    Gateway->>Backend: GET /products/123
    
    Backend->>L1: –ü—Ä–æ–≤–µ—Ä–∫–∞ in-memory
    Note over L1: MISS (–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å<br/>–ø–æ—Å–ª–µ deploy)
    
    Backend->>Redis: GET product:123
    Note over Redis: MISS (—Ö–æ–ª–æ–¥–Ω—ã–π –∫—ç—à)
    
    Backend->>DB: SELECT * FROM products<br/>WHERE id=123
    Note over DB: ‚è±Ô∏è 50ms
    DB-->>Backend: {id:123, name:"iPhone",<br/>price:1000}
    
    Backend->>Redis: SET product:123<br/>TTL=300s
    Backend->>L1: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ<br/>TTL=60s
    Backend-->>CDN: 200 OK + Cache-Control
    CDN->>CDN: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ edge<br/>TTL=300s
    CDN-->>Browser: 200 OK + Cache-Control
    Browser->>Browser: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
    Browser-->>Client: –ü–æ–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞
    
    rect rgb(200, 255, 200)
        Note over Client,DB: –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Client->>Browser: GET /products/123
        Browser->>CDN: GET /products/123
        CDN-->>Browser: 200 OK (HIT ‚ö°)
        Note over CDN: Latency: 10ms
        Browser-->>Client: –ü–æ–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞
    end
```

**–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ —Å–ª–æ—è–º (—Ç–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è):**

```php
<?php

// –ü—Ä–∏–º–µ—Ä –º–µ—Ç—Ä–∏–∫ –∑–∞ 1 —á–∞—Å –¥–ª—è —Ç–æ–≤–∞—Ä–∞ #123
$totalRequests = 100_000;

// –ë—Ä–∞—É–∑–µ—Ä (—Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
$browserHits = 0; // –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–æ–π –±—Ä–∞—É–∑–µ—Ä

// CDN
$cdnRequests = 100_000;
$cdnHits     = 95_000;  // 95% hit rate
$cdnMisses   = 5_000;

// L1 (–Ω–∞ –æ–¥–Ω–æ–º –∏–∑ 10 backend-—Å–µ—Ä–≤–µ—Ä–æ–≤)
$l1Requests = 500;  // 5000 / 10 —Å–µ—Ä–≤–µ—Ä–æ–≤
$l1Hits     = 400;  // 80% hit rate
$l1Misses   = 100;

// L2 Redis
$l2Requests = 100 + 4_900; // misses –æ—Ç –≤—Å–µ—Ö L1 + —Å–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã
$l2Hits     = 4_500;       // 90% hit rate
$l2Misses   = 500;

// DB
$dbRequests = 500; // –¢–æ–ª—å–∫–æ —Ö–æ–ª–æ–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

// –°—Ä–µ–¥–Ω—è—è latency (—É—Å–ª–æ–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
$avgLatencyMs = (
    95_000 * 10  + // CDN hits
    4_500 * 3   + // Redis hits
    500   * 50    // DB queries
) / $totalRequests; // ‚âà 12.9ms ‚úÖ
```

**–ë–µ–∑ –∫—ç—à–∞:** 100k * 50ms = 5000 —Å–µ–∫—É–Ω–¥ CPU –≤—Ä–µ–º–µ–Ω–∏ –ë–î  
**–° –∫—ç—à–µ–º:** 500 * 50ms = 25 —Å–µ–∫—É–Ω–¥ CPU –≤—Ä–µ–º–µ–Ω–∏ –ë–î  
**–í—ã–∏–≥—Ä—ã—à:** 200x —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î! üéâ

### 3.4. Write path: –∫–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à

**–ü–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**

```mermaid
graph LR
    A["1. UPDATE –ë–î"] --> B["2. Publish —Å–æ–±—ã—Ç–∏–µ"]
    B --> C["3. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è L2 Redis"]
    B --> D["3. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è L1 –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤"]
    B --> E["3. Purge CDN (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"]

    classDef step fill:#fafafa,stroke:#b0bec5,color:#263238;
    class A,B,C,D,E step;
```

**–ü—Å–µ–≤–¥–æ–∫–æ–¥ (PHP + Symfony):**

```php
<?php

use Doctrine\DBAL\Connection;
use Symfony\Component\Messenger\MessageBusInterface;
use Predis\Client as RedisClient;
use Psr\Cache\CacheItemPoolInterface;

final class ProductPriceUpdatedEvent
{
    public function __construct(
        public readonly int $productId,
        public readonly float $newPrice,
        public readonly ?float $oldPrice = null,
    ) {}
}

final class ProductPriceService
{
    public function __construct(
        private Connection $connection,
        private MessageBusInterface $eventBus,
    ) {}

    public function updateProductPrice(int $productId, float $newPrice): void
    {
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º source of truth
        $oldPrice = (float) $this->connection->fetchOne(
            'SELECT price FROM products WHERE id = :id',
            ['id' => $productId],
        );

        $this->connection->executeStatement(
            'UPDATE products SET price = :price, updated_at = NOW() WHERE id = :id',
            ['price' => $newPrice, 'id' => $productId],
        );

        // 2. –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        $this->eventBus->dispatch(
            new ProductPriceUpdatedEvent($productId, $newPrice, $oldPrice),
        );
    }
}

// –ù–∞ –∫–∞–∂–¥–æ–º backend-—Å–µ—Ä–≤–µ—Ä–µ:
final class ProductCacheInvalidationListener
{
    public function __construct(
        private CacheItemPoolInterface $l1Cache,
        private RedisClient $redis,
        private CdnApiClient $cdnApi,
    ) {}

    public function __invoke(ProductPriceUpdatedEvent $event): void
    {
        $productId = $event->productId;

        // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è L1 (–ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
        $this->l1Cache->deleteItem(sprintf('product.%d', $productId));

        // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è L2 (Redis, shared)
        $this->redis->del([
            sprintf('product.%d', $productId),
            sprintf('product.card.%d', $productId),
        ]);

        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: CDN purge –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if ($event->oldPrice !== null && $event->newPrice < $event->oldPrice) {
            // –¶–µ–Ω–∞ —É–ø–∞–ª–∞ ‚Äî –≤–∞–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ!
            $this->cdnApi->purgeUrl(sprintf('/products/%d', $productId));
        }
    }
}
```

**–í–∞–∂–Ω–æ:** –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `DELETE`, –∞ –Ω–µ —á–µ—Ä–µ–∑ `SET new_value`!

–ü–æ—á–µ–º—É?
- `DELETE` + lazy load –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –æ—Ç –≥–æ–Ω–æ–∫
- –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —Å–∞–º –ø–æ–¥–≥—Ä—É–∑–∏—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
- `SET` –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å stale –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ race condition

### 3.5. –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–º–µ–Ω–∏–ª–∞—Å—å —Ü–µ–Ω–∞ –≤—Å–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞" (10,000 —Ç–æ–≤–∞—Ä–æ–≤). –ö–∞–∫ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å?

**–ù–∞–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
```php
<?php

// ‚ùå –ü–ª–æ—Ö–æ: 10,000 DELETE –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Redis –ø–æ–¥—Ä—è–¥
foreach ($electronicsProducts as $productId) {
    $redis->del([sprintf('product.%d', $productId)]);
}
```

**–õ—É—á—à–µ: —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π**

```php
<?php

// –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
$redis->set(sprintf('product.%d', $productId), json_encode($data, JSON_THROW_ON_ERROR));
$redis->sadd('tag:category:electronics', [sprintf('product.%d', $productId)]);

// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function updateCategoryPrices(int $categoryId, float $discountPercent, Connection $db, RedisClient $redis): void {
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
    $db->executeStatement(
        'UPDATE products SET price = price * (1 - :discount) WHERE category_id = :category_id',
        ['discount' => $discountPercent, 'category_id' => $categoryId],
    );

    // 2. –ú–∞—Å—Å–æ–≤–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ç–µ–≥—É
    $tagKey = sprintf('tag:category:%d', $categoryId);
    $taggedKeys = $redis->smembers($tagKey);

    if (\count($taggedKeys) < 1000) {
        // –ú–∞–ª–æ –∫–ª—é—á–µ–π ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É
        if ($taggedKeys !== []) {
            $redis->del($taggedKeys);
        }
    } else {
        // –ú–Ω–æ–≥–æ –∫–ª—é—á–µ–π ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é —Ç–µ–≥–∞
        $redis->incr(sprintf('%s:version', $tagKey));
        // –°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –ø—Ä–æ—Ç—É—Ö–Ω—É—Ç –ø–æ TTL
    }
}
```

**–°—Ö–µ–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤:**

```php
<?php

// –ß—Ç–µ–Ω–∏–µ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
function getProductWithTag(int $productId, int $categoryId, Connection $db, RedisClient $redis): ?array {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é —Ç–µ–≥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    $tagVersion = $redis->get(sprintf('tag:category:%d:version', $categoryId)) ?? '0';

    // –ö–ª—é—á –≤–∫–ª—é—á–∞–µ—Ç –≤–µ—Ä—Å–∏—é
    $cacheKey = sprintf('product.%d.v%s', $productId, $tagVersion);

    $cached = $redis->get($cacheKey);
    if ($cached !== null) {
        return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
    }

    // Cache miss
    $product = $db->fetchAssociative(
        'SELECT * FROM products WHERE id = :id',
        ['id' => $productId],
    );

    if ($product === false) {
        return null;
    }

    $redis->setex($cacheKey, 300, json_encode($product, JSON_THROW_ON_ERROR));

    return $product;
}

// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é
$redis->incr(sprintf('tag:category:%d:version', $categoryId));
// –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ —Å v0 —Å—Ç–∞–Ω—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å v1
```

### 3.6. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –¥–µ–ø–ª–æ—è—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ–ø–ª–æ–∏–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞, –º–µ–Ω—è–µ—Ç—Å—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ.

**–ü—Ä–∏–º–µ—Ä:**
```php
<?php

// –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞
$productV1 = [
    'id'    => 123,
    'name'  => 'iPhone',
    'price' => 1000,
];

// –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ (–¥–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–µ discount)
$productV2 = [
    'id'       => 123,
    'name'     => 'iPhone',
    'price'    => 1000,
    'discount' => 0.1,
];
```

**–†–µ—à–µ–Ω–∏–µ: –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π**

```php
<?php

// –í–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ
const CACHE_SCHEMA_VERSION = 'v2';

function getProductWithSchemaVersion(int $productId, Connection $db, RedisClient $redis): ?array {
    $cacheKey = sprintf('product.%d.%s', $productId, CACHE_SCHEMA_VERSION);

    $cached = $redis->get($cacheKey);
    if ($cached !== null) {
        return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
    }

    $product = $db->fetchAssociative(
        'SELECT * FROM products WHERE id = :id',
        ['id' => $productId],
    );

    if ($product === false) {
        return null;
    }

    $redis->setex($cacheKey, 300, json_encode($product, JSON_THROW_ON_ERROR));

    return $product;
}
```

**Blue-Green deploy —Å –∫—ç—à–µ–º:**

```mermaid
sequenceDiagram
    participant Old as –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è<br/>(v1)
    participant New as –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è<br/>(v2)
    participant Redis as Redis
    participant LB as Load Balancer
    
    Note over Old,Redis: –î–æ –¥–µ–ø–ª–æ—è: 100% —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ v1
    
    Old->>Redis: –†–∞–±–æ—Ç–∞ —Å –∫–ª—é—á–∞–º–∏<br/>product:123:v1
    
    Note over New: Deploy v2 –Ω–∞ 10% —Å–µ—Ä–≤–µ—Ä–æ–≤
    
    LB->>LB: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º 10% —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ v2
    
    New->>Redis: –†–∞–±–æ—Ç–∞ —Å –∫–ª—é—á–∞–º–∏<br/>product:123:v2
    Old->>Redis: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å<br/>product:123:v1
    
    Note over Old,New: –í–µ—Ä—Å–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!
    
    LB->>LB: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ 50% ‚Üí 100% –Ω–∞ v2
    
    Note over Old: –°—Ç–∞—Ä—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –≤—ã–∫–ª—é—á–∞–µ–º
    Note over Old,Redis: –ö–ª—é—á–∏ v1 –ø—Ä–æ—Ç—É—Ö–Ω—É—Ç –ø–æ TTL
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç race conditions –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –±–µ–∑ —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –î–≤–æ–π–Ω–æ–π —Ä–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏ Redis (–≤—Ä–µ–º–µ–Ω–Ω–æ)
- ‚ùå –ù—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—Ä–∞–Ω–µ–µ

### 3.7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ñ–∏–∫–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Hot Keys (–≥–æ—Ä—è—á–∏–µ –∫–ª—é—á–∏)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** "–¢–æ–≤–∞—Ä –¥–Ω—è" ‚Äî 100,000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É –Ω–∞ –æ–¥–∏–Ω –∫–ª—é—á.

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ Redis –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å —Ç–∞–∫–∏–º QPS –Ω–∞ –æ–¥–∏–Ω –∫–ª—é—á.

```mermaid
graph TB
    subgraph "100k RPS –Ω–∞ –æ–¥–∏–Ω –∫–ª—é—á"
        Client1[–ö–ª–∏–µ–Ω—Ç 1]
        Client2[–ö–ª–∏–µ–Ω—Ç 2]
        ClientN[–ö–ª–∏–µ–Ω—Ç N...]
    end
    
    Redis[(Redis<br/>Master)]
    
    Client1 -->|33k RPS| Redis
    Client2 -->|33k RPS| Redis
    ClientN -->|34k RPS| Redis

    classDef cacheHot fill:#212121,stroke:#000000,color:#ffffff;
    class Redis cacheHot;

    Note[Redis master<br/>–ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω! üî•]
```

**–†–µ—à–µ–Ω–∏–µ A: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –≤ L1**

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class HotKeysProductService
{
    private const HOT_KEYS = ['product:12345']; // –¢–æ–≤–∞—Ä –¥–Ω—è

    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
        private \Psr\SimpleCache\CacheInterface $l1Cache, // in-memory L1 (–Ω–∞–ø—Ä–∏–º–µ—Ä, ArrayCache)
    ) {}

    public function getProduct(int $productId): ?array
    {
        $cacheKey = sprintf('product:%d', $productId);

        // –î–ª—è hot keys ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º L1 –ø–µ—Ä–≤—ã–º
        if (\in_array($cacheKey, self::HOT_KEYS, true)) {
            $data = $this->l1Cache->get($cacheKey);
            if ($data !== null) {
                return $data;
            }

            // L1 miss ‚Äî –∏–¥—ë–º –≤ Redis, –Ω–æ —Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL
            $cached = $this->redis->get($cacheKey);
            if ($cached !== null) {
                $product = json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ L1 —Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL (30 —Å–µ–∫—É–Ω–¥)
                $this->l1Cache->set($cacheKey, $product, 30);

                return $product;
            }
        }

        // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–µ-hot keys
        $product = $this->connection->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null;
        }

        $this->redis->setex($cacheKey, 300, json_encode($product, JSON_THROW_ON_ERROR));

        return $product;
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100k RPS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ 10 backend-—Å–µ—Ä–≤–µ—Ä–∞–º = 10k RPS –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–∑ L1 (–ª–µ–≥–∫–æ).

**–†–µ—à–µ–Ω–∏–µ B: Separate tier –¥–ª—è hot keys**

–ü–æ–¥ `separate tier` –∑–¥–µ—Å—å –∏–º–µ–µ—Ç—Å—è –≤ –≤–∏–¥—É –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∫—ç—à–∞, —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ—Ç–¥–µ–ª—ë–Ω–Ω—ã–π –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Redis:
- –ª–∏–±–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä/–ø—É–ª Redis —Ç–æ–ª—å–∫–æ –ø–æ–¥ hot keys;
- –ª–∏–±–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–µ—Ü‚Äë–Ω–æ–¥, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ —Ç—Ä–∞—Ñ–∏–∫ –∫ ¬´—Ç–æ–≤–∞—Ä—É –¥–Ω—è¬ª –∏ –ø–æ—Ö–æ–∂–∏–º –∫–ª—é—á–∞–º.

–ò–¥–µ—è: –æ–±—ã—á–Ω—ã–µ –∫–ª—é—á–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –∂–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º Redis, –∞ –∑–∞–ø—Ä–æ—Å—ã –∫ ¬´—Ä–∞–∑–æ–≥—Ä–µ—Ç—ã–º¬ª –∫–ª—é—á–∞–º —Ä–∞–∑–º–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É —Å–ª–æ—é. –¢–∞–∫ –º—ã –Ω–µ –∑–∞–±–∏–≤–∞–µ–º –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å Redis 100k RPS, –∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –∏ –∑–∞—â–∏—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫—ç—à –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–∏–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –∫–ª—é—á–æ–º.

```mermaid
graph TB
    Clients["–ö–ª–∏–µ–Ω—Ç—ã (100k RPS)"]
    
    subgraph "Hot Keys Tier"
        Hot1["Hot Cache 1"]
        Hot2["Hot Cache 2"]
        Hot3["Hot Cache 3"]
    end
    
    Redis["Redis (regular keys)"]
    DB["PostgreSQL"]
    
    Clients -->|hot keys| Hot1
    Clients -->|hot keys| Hot2
    Clients -->|hot keys| Hot3
    Clients -->|regular keys| Redis
    
    Hot1 --> DB
    Hot2 --> DB
    Hot3 --> DB
    Redis --> DB

    classDef client fill:#eceff1,stroke:#607d8b,color:#263238;
    classDef cache fill:#e6f4ea,stroke:#2e7d32,color:#1b5e20;
    classDef db fill:#e3f2fd,stroke:#1976d2,color:#0d47a1;

    class Clients client;
    class Hot1,Hot2,Hot3,Redis cache;
    class DB db;
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: Cache Stampede (thundering herd)

–†–∞–∑–±–µ—Ä—ë–º –ø–æ–¥—Ä–æ–±–Ω–æ –≤ –ë–ª–æ–∫–µ 4.

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: Cold Start (—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –î–µ–ø–ª–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ ‚Üí –≤–µ—Å—å in-memory –∫—ç—à —Å–±—Ä–æ—Å–∏–ª—Å—è ‚Üí –ë–î –ø–æ–ª—É—á–∞–µ—Ç 10x –Ω–∞–≥—Ä—É–∑–∫—É.

**–†–µ—à–µ–Ω–∏–µ: Batch pre-warming**

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;
use Psr\Log\LoggerInterface;

final class CacheWarmupCommand
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
        private LoggerInterface $logger,
    ) {}

    // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞ / –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
    public function warmup(): void
    {
        $this->logger->info('Starting cache warmup...');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ø-1000 —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ë–î
        $topProducts = $this->connection->fetchAllAssociative(
            'SELECT * FROM products 
             ORDER BY views_last_24h DESC 
             LIMIT 1000',
        );

        // –ö–ª–∞–¥—ë–º –≤ –∫—ç—à –±–∞—Ç—á–∞–º–∏ –ø–æ 100
        foreach (array_chunk($topProducts, 100) as $batch) {
            $this->redis->pipeline(function (RedisClient $pipe) use ($batch): void {
                foreach ($batch as $product) {
                    $key = sprintf('product:%d', $product['id']);
                    $pipe->setex($key, 300, json_encode($product, JSON_THROW_ON_ERROR));
                }
            });

            usleep(100_000); // 0.1s ‚Äî –Ω–µ —É–±–∏–≤–∞–µ–º Redis
        }

        $this->logger->info(sprintf('Warmed up %d products', \count($topProducts)));
    }
}
```

**–ú–µ—Ç—Ä–∏–∫–∏ warmup:**

```php
<?php

// –¶–µ–ª—å: –¥–æ—Å—Ç–∏—á—å 80% hit rate –∑–∞ 2 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
$timeTo80PercentHitRate = measureWarmup(); // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–µ—Ç—Ä–∏–∫–∞
// –•–æ—Ä–æ—à–æ: < 2 –º–∏–Ω—É—Ç—ã
// –ü–ª–æ—Ö–æ: > 5 –º–∏–Ω—É—Ç ‚Äî –Ω—É–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å warmup
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 4: Request Coalescing (single flight)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –æ–¥–∏–Ω –∫–ª—é—á, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –∫—ç—à–µ.

**–ù–∞–∏–≤–Ω—ã–π –∫–æ–¥ (PHP):**
```php
<?php

// ‚ùå –ü–ª–æ—Ö–æ: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–π–¥—É—Ç –≤ –ë–î –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
function getProductNaive(int $productId, Connection $db, RedisClient $redis): ?array {
    $cacheKey = sprintf('product:%d', $productId);
    $cached = $redis->get($cacheKey);

    if ($cached === null) {
        // 100 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î –ø—Ä–∏ stampede
        $product = $db->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null;
        }

        $redis->setex($cacheKey, 300, json_encode($product, JSON_THROW_ON_ERROR));

        return $product;
    }

    return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
}
```

**–° request coalescing (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, PHP):**

```php
<?php

final class SingleFlightCache
{
    /** @var array<string, \React\Promise\PromiseInterface> */
    private array $inFlight = [];

    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    public function getProduct(int $productId): \React\Promise\PromiseInterface
    {
        $cacheKey = sprintf('product:%d', $productId);

        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –ª–µ—Ç–∏—Ç –≤ –ë–î ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ—Ç –∂–µ Promise
        if (isset($this->inFlight[$cacheKey])) {
            return $this->inFlight[$cacheKey];
        }

        $this->inFlight[$cacheKey] = \React\Promise\resolve()->then(function () use ($cacheKey, $productId) {
            $cached = $this->redis->get($cacheKey);
            if ($cached !== null) {
                return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
            }

            // –ò–¥—ë–º –≤ –ë–î —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            $product = $this->connection->fetchAssociative(
                'SELECT * FROM products WHERE id = :id',
                ['id' => $productId],
            );

            if ($product !== false) {
                $this->redis->setex($cacheKey, 300, json_encode($product, JSON_THROW_ON_ERROR));
            }

            unset($this->inFlight[$cacheKey]);

            return $product === false ? null : $product;
        });

        return $this->inFlight[$cacheKey];
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –ø–æ—Ö–æ–¥ –≤ –ë–î ‚úÖ

### 3.8. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

**Dashboard –¥–ª—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∫—ç—à–∞: —á—Ç–æ –Ω–∞ –Ω—ë–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å**

```mermaid
graph TB
    subgraph "Caching dashboard"
        HR["Hit rate –ø–æ —Å–ª–æ—è–º\n(L1, L2, CDN)"]
        LAT["P99 latency –ø–æ —Å–ª–æ—è–º"]
        DBQ["DB QPS –ø—Ä–∏ cache miss"]
        STALE["Stale read rate\n(—á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)"]
    end
```

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –æ–±—ã—á–Ω–æ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫ (Prometheus / Grafana):

```php
<?php

// –ü—Ä–∏–º–µ—Ä—ã –∏–º—ë–Ω –º–µ—Ç—Ä–∏–∫
// cache_hit_rate{layer="l1"}
// cache_hit_rate{layer="l2"}
// cache_hit_rate{layer="cdn"}

// cache_latency_p99{layer="l1"}
// cache_latency_p99{layer="l2"}
// cache_latency_p99{layer="cdn"}
// db_latency_p99

// cache_invalidations_per_sec
// cache_hot_keys_detected
// stale_read_rate
```

**–ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å —Å–ª–æ–π –∫—ç—à–∞ (–∫–∞–∫ —á–∏—Ç–∞—Ç—å –¥—ç—à–±–æ—Ä–¥):**

- –ï—Å–ª–∏ `cache_hit_rate{layer="l2"}` –≤—ã—Å–æ–∫–∏–π (>80%), –Ω–æ `cache_latency_p99{layer="l2"}` –≤—Å—ë —Ä–∞–≤–Ω–æ –±–æ–ª—å—à–∞—è ‚Üí –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –¥–æ–±–∞–≤–∏—Ç—å L1 in-process.
- –ï—Å–ª–∏ `cache_hit_rate{layer="l1"}` —Å—Ç–∞–±–∏–ª—å–Ω–æ <50% –∏ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ—Ç –æ—Å–æ–±–æ–π –≤—ã–≥–æ–¥—ã –ø–æ latency ‚Üí L1 –¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –µ–≥–æ –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–ª–∏ —É–±—Ä–∞—Ç—å.
- –ï—Å–ª–∏ `db_qps` —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ hit rate CDN –∏ `cache_latency_p99{layer="cdn"}` –∑–∞–º–µ—Ç–Ω–æ –Ω–∏–∂–µ, —á–µ–º —É backend ‚Üí –ø–æ—Ä–∞ –¥—É–º–∞—Ç—å –æ CDN.
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—á–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∫ —Å–≤–µ–∂–µ—Å—Ç–∏ (stale_read_rate —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –ª—é–±—ã—Ö –∑–∞–¥–µ—Ä–∂–∫–∞—Ö) ‚Üí —Å–ª–æ–π —Å –¥–ª–∏–Ω–Ω—ã–º TTL (—á–∞—Å—Ç–æ CDN) –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —ç—Ç–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.

---

## –ë–õ–û–ö 4 (C). –°–õ–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –ü–†–ê–ö–¢–ò–ö–ê (10-15 –º–∏–Ω—É—Ç)

### 4.1. Thundering Herd / Cache Stampede

**–°–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.**

**–°—Ü–µ–Ω–∞—Ä–∏–π:**

```mermaid
graph TB
    subgraph "t=0: –í—Å—ë —Ö–æ—Ä–æ—à–æ"
        C1[1000 –∫–ª–∏–µ–Ω—Ç–æ–≤/—Å–µ–∫]
        Redis1[(Redis<br/>product:123<br/>TTL: 5 —Å–µ–∫)]
        DB1[(–ë–î<br/>QPS: 100)]
    end
    
    C1 --> Redis1
    Redis1 -.->|—Ä–µ–¥–∫–∏–µ miss| DB1

    classDef nodeDark fill:#212121,stroke:#000000,color:#ffffff;
    class Redis1,DB1 nodeDark;
```

```mermaid
graph TB
    subgraph "t=5min: TTL –∏—Å—Ç—ë–∫"
        C2[1000 –∫–ª–∏–µ–Ω—Ç–æ–≤/—Å–µ–∫]
        Redis2[(Redis<br/>product:123<br/>EXPIRED ‚ùå)]
        DB2[(–ë–î<br/>QPS: 1000! üî•)]
    end
    
    C2 --> Redis2
    Redis2 -->|–í–°–ï –∑–∞–ø—Ä–æ—Å—ã| DB2

    classDef nodeDark fill:#212121,stroke:#000000,color:#ffffff;
    class Redis2,DB2 nodeDark;
```

**Timeline –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞:**

```
08:00:00 ‚Äî –¢–æ–≤–∞—Ä –¥–Ω—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, QPS 1000/—Å–µ–∫
08:00:30 ‚Äî –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫–ª–∞–¥—ë—Ç —Ç–æ–≤–∞—Ä –≤ –∫—ç—à, TTL 300 —Å–µ–∫
08:00:31 ‚Äî 08:05:29 ‚Äî –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –∏–∑ –∫—ç—à–∞ ‚úÖ
08:05:30 ‚Äî TTL –∏—Å—Ç—ë–∫, –∫–ª—é—á —É–¥–∞–ª—ë–Ω –∏–∑ Redis
08:05:30 ‚Äî 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–¥—É—Ç –≤ –ë–î üî•
08:05:31 ‚Äî –ë–î –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞, latency 5 —Å–µ–∫—É–Ω–¥
08:05:35 ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –æ—à–∏–±–∫–∏ 500
08:06:00 ‚Äî –ö—Ç–æ-—Ç–æ –ø–æ–ª–æ–∂–∏–ª —Ç–æ–≤–∞—Ä –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫—ç—à
08:06:01 ‚Äî –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å
```

**–ì—Ä–∞—Ñ–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏:**

```
–ë–î QPS
  ^
  |
1k|     *
  |    * *
  |   *   *
  |  *     *_______________
  | *
100|*
  +-----|-----|-----|------> –≤—Ä–µ–º—è
     08:00  08:05  08:10
            ‚Üë
         stampede!
```

#### –†–µ—à–µ–Ω–∏–µ 1: Single Flight (request coalescing)

–£–∂–µ —Ä–∞–∑–æ–±—Ä–∞–ª–∏ –≤—ã—à–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç –≤ –ë–î.

–í–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–∫:

```mermaid
sequenceDiagram
    participant C1 as –ö–ª–∏–µ–Ω—Ç 1
    participant C2 as –ö–ª–∏–µ–Ω—Ç 2
    participant Cn as –ö–ª–∏–µ–Ω—Ç—ã N...
    participant S as Backend —Å single flight
    participant DB as –ë–î

    Note over C1,Cn: 100 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ product:123

    C1->>S: GET /products/123
    C2->>S: GET /products/123
    Cn->>S: GET /products/123

    Note over S: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª—é—á—É product:123

    S->>DB: SELECT * FROM products WHERE id=123
    DB-->>S: –û—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞

    S-->>C1: –û—Ç–≤–µ—Ç (shared)
    S-->>C2: –û—Ç–≤–µ—Ç (shared)
    S-->>Cn: –û—Ç–≤–µ—Ç (shared)
```

#### –†–µ—à–µ–Ω–∏–µ 2: Early Refresh (–∑–∞–≥–ª—è–¥—ã–≤–∞–Ω–∏–µ –≤–ø–µ—Ä—ë–¥)

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class EarlyRefreshCache
{
    private const TTL = 300; // 5 –º–∏–Ω—É—Ç
    private const EARLY_REFRESH_WINDOW = 30; // 30 —Å–µ–∫—É–Ω–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è

    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    public function getProductWithEarlyRefresh(int $productId): ?array
    {
        $cacheKey = sprintf('product:%d', $productId);

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ + timestamp –∏—Ö –∑–∞–ø–∏—Å–∏ (—Ö—Ä–∞–Ω–∏–º –∫–∞–∫ JSON-–æ–±—ä–µ–∫—Ç)
        $cached = $this->redis->get($cacheKey);

        if ($cached !== null) {
            $payload = json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
            $data = $payload['data'];
            $cachedAt = $payload['cached_at'];

            $age = time() - $cachedAt;

            // –ï—Å–ª–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL –æ—Å—Ç–∞–ª–æ—Å—å < 30 —Å–µ–∫—É–Ω–¥ ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä–∏–º refresh –≤ —Ñ–æ–Ω–µ (—á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å/–≤–æ—Ä–∫–µ—Ä)
            if ($age > (self::TTL - self::EARLY_REFRESH_WINDOW)) {
                // –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ refresh
                // e.g. $this->refreshQueue->dispatch(new RefreshProductCache($productId));
            }

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (–ø—É—Å—Ç—å —á—É—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ)
            return $data;
        }

        // Cache miss ‚Äî –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        $product = $this->connection->fetchAssociative(
            'SELECT * FROM products WHERE id = :id',
            ['id' => $productId],
        );

        if ($product === false) {
            return null;
        }

        $payload = [
            'data'      => $product,
            'cached_at' => time(),
        ];

        $this->redis->setex($cacheKey, self::TTL, json_encode($payload, JSON_THROW_ON_ERROR));

        return $product;
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL, stampede –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

#### –†–µ—à–µ–Ω–∏–µ 3: Jittered TTL (—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è)

```php
<?php

use Predis\Client as RedisClient;

// ‚ùå –ü–ª–æ—Ö–æ: –≤—Å–µ –∫–ª—é—á–∏ –∏—Å—Ç–µ–∫–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
// $redis->setex($key, 300, $data);  // –†–æ–≤–Ω–æ 300 —Å–µ–∫—É–Ω–¥

// ‚úÖ –•–æ—Ä–æ—à–æ: –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π jitter ¬±10%
$baseTtl = 300;
$jitter  = random_int(-30, 30); // ¬±10%
$ttl     = $baseTtl + $jitter;

$redis->setex($key, $ttl, $data);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–ª—é—á–∏ –∏—Å—Ç–µ–∫–∞—é—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ stampede.

### 4.2. Stale Data (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ)

**–ì–¥–µ –º–æ–∂–Ω–æ –∂–∏—Ç—å —Å stale –¥–∞–Ω–Ω—ã–º–∏:**

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | –î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ–∫–Ω–æ | –°—Ç—Ä–∞—Ç–µ–≥–∏—è |
|------------|-----------------|-----------|
| –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π | 1-5 –º–∏–Ω—É—Ç | TTL-only |
| –°—á—ë—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤ | 10-60 —Å–µ–∫—É–Ω–¥ | TTL-only |
| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | 1-10 –º–∏–Ω—É—Ç | TTL + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç |
| –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ | 30-60 —Å–µ–∫—É–Ω–¥ | Event-based + fallback TTL |

**–ì–¥–µ –ù–ï–õ–¨–ó–Ø –∂–∏—Ç—å —Å stale –¥–∞–Ω–Ω—ã–º–∏:**

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç—Ä–∞—Ç–µ–≥–∏—è |
|------------|------------|-----------|
| –ë–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞ | <1 —Å–µ–∫—É–Ω–¥—ã | Read-through —Å –ë–î, lease-based |
| –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ | <5 —Å–µ–∫—É–Ω–¥ | Short TTL + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ checkout |
| –õ–∏–º–∏—Ç—ã (rate limiting) | Real-time | Distributed counter, no cache |
| –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (ACL) | <10 —Å–µ–∫—É–Ω–¥ | Event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è |

**–ü—Ä–∏–º–µ—Ä: –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class BalanceService
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    // –ö—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏, –ù–û –Ω–µ –∫–∞–∫ source of truth
    public function getUserBalance(int $userId, bool $isFinancialOperation): float
    {
        $cacheKey = sprintf('balance:%d', $userId);
        $cachedBalance = $this->redis->get($cacheKey);

        // –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º –ë–î
        if ($isFinancialOperation) {
            return (float) $this->queryBalance($userId, true);
        }

        // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
        if ($cachedBalance !== null) {
            return (float) $cachedBalance;
        }

        // Cache miss
        $balance = $this->queryBalance($userId, false);

        // –ö–æ—Ä–æ—Ç–∫–∏–π TTL ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
        $this->redis->setex($cacheKey, 5, (string) $balance);

        return $balance;
    }

    public function withdrawMoney(int $userId, float $amount): float
    {
        // –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –∏–∑ –ë–î —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
        $this->connection->beginTransaction();
        try {
            $balance = (float) $this->connection->fetchOne(
                'SELECT balance FROM accounts WHERE user_id = :id FOR UPDATE',
                ['id' => $userId],
            );

            if ($balance < $amount) {
                throw new \RuntimeException('Insufficient funds');
            }

            $newBalance = $balance - $amount;

            $this->connection->executeStatement(
                'UPDATE accounts SET balance = :balance WHERE user_id = :id',
                ['balance' => $newBalance, 'id' => $userId],
            );

            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
            $this->redis->del([sprintf('balance:%d', $userId)]);

            $this->connection->commit();

            return $newBalance;
        } catch (\Throwable $e) {
            $this->connection->rollBack();
            throw $e;
        }
    }

    private function queryBalance(int $userId, bool $forUpdate): float
    {
        if ($forUpdate) {
            return (float) $this->connection->fetchOne(
                'SELECT balance FROM accounts WHERE user_id = :id FOR UPDATE',
                ['id' => $userId],
            );
        }

        return (float) $this->connection->fetchOne(
            'SELECT balance FROM accounts WHERE user_id = :id',
            ['id' => $userId],
        );
    }
}
```

### 4.3. –ü—Ä–æ–¥–∞–∫—à–µ–Ω-–∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã (—Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏)

#### –ò–Ω—Ü–∏–¥–µ–Ω—Ç 1: –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –≤ –∫—ç—à–µ

**–ö–æ–º–ø–∞–Ω–∏—è:** –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å (–∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)  
**–î–∞—Ç–∞:** –ß—ë—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞ 2023

**–°–∏–º–ø—Ç–æ–º—ã:**
- 12:00 ‚Äî –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞, —Ü–µ–Ω—ã –Ω–∞ 10k —Ç–æ–≤–∞—Ä–æ–≤ —Å–Ω–∏–∂–µ–Ω—ã –Ω–∞ 50%
- 12:05 ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è: "–í –∫–∞—Ç–∞–ª–æ–≥–µ —Ü–µ–Ω–∞ 500‚ÇΩ, –≤ –∫–æ—Ä–∑–∏–Ω–µ 1000‚ÇΩ"
- 12:10 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–∞–ª–µ–Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏

**Root cause:**
```php
<?php

// –ë–∞–≥ –≤ –∫–æ–¥–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω
function updatePricesForSale(array $productIds, float $discount, Connection $db, RedisClient $redis): void {
    foreach ($productIds as $productId) {
        // –û–±–Ω–æ–≤–∏–ª–∏ –ë–î ‚úÖ
        $db->executeStatement(
            'UPDATE products SET price = price * (1 - :discount) WHERE id = :id',
            ['discount' => $discount, 'id' => $productId],
        );

        // –ó–∞–±—ã–ª–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à! ‚ùå
        // $redis->del([sprintf("product:%d", $productId)]);
    }
}
```

**Timeline:**
```
11:50 ‚Äî –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫–∏–¥–∫–∏ —á–µ—Ä–µ–∑ admin-–ø–∞–Ω–µ–ª—å
11:55 ‚Äî –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞, —Ü–µ–Ω—ã —Å–Ω–∏–∂–µ–Ω—ã
12:00 ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞—Ö–æ–¥—è—Ç
12:01 ‚Äî –ö–∞—Ç–∞–ª–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ü–µ–Ω—ã –∏–∑ –∫—ç—à–∞ (TTL 5 –º–∏–Ω—É—Ç)
12:05 ‚Äî –ü–µ—Ä–≤—ã–µ –∂–∞–ª–æ–±—ã
12:10 ‚Äî –ò–Ω–∂–µ–Ω–µ—Ä—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É
12:11 ‚Äî FLUSHALL –≤ Redis (—Å–±—Ä–æ—Å –≤—Å–µ–≥–æ –∫—ç—à–∞)
12:12 ‚Äî –ë–î –ø–æ–ª—É—á–∏–ª–∞ 10x –Ω–∞–≥—Ä—É–∑–∫—É (—Ö–æ–ª–æ–¥–Ω—ã–π –∫—ç—à)
12:15 ‚Äî –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å, —Ü–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ
```

**–§–∏–∫—Å:**
```php
<?php

function updatePricesForSaleFixed(array $productIds, float $discount, Connection $db, RedisClient $redis, MessageBusInterface $eventBus): void {
    // –ë–∞—Ç—á–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
    $db->executeStatement(
        'UPDATE products SET price = price * (1 - :discount) WHERE id IN (:ids)',
        ['discount' => $discount, 'ids' => $productIds],
        ['ids' => Connection::PARAM_INT_ARRAY],
    );

    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ
    $eventBus->dispatch(new PricesBulkUpdatedEvent($productIds, new \DateTimeImmutable()));

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ Redis
    if (\count($productIds) < 1000) {
        $keys = array_map(fn (int $id): string => sprintf('product:%d', $id), $productIds);
        if ($keys !== []) {
            $redis->del($keys);
        }
    } else {
        // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–ª—é—á–µ–π ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é —Ç–µ–≥–∞
        $redis->incr('tag:sale:version');
    }
}
```

**–£—Ä–æ–∫–∏:**
1. –í—Å–µ–≥–¥–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ò–º–µ—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –∫—ç—à vs –ë–î
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å bulk-–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

#### –ò–Ω—Ü–∏–¥–µ–Ω—Ç 2: Split-brain –≤ Redis –∫–ª–∞—Å—Ç–µ—Ä–µ

**–ö–æ–º–ø–∞–Ω–∏—è:** SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞  
**–î–∞—Ç–∞:** 2024

**–°–∏–º–ø—Ç–æ–º—ã:**
- 03:00 ‚Äî –°–µ—Ç–µ–≤–æ–π —Å–±–æ–π –≤ –î–¶
- 03:05 ‚Äî –ü–æ–ª–æ–≤–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–∏–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª–æ–≤–∏–Ω–∞ ‚Äî —Å—Ç–∞—Ä—ã–µ
- 03:10 ‚Äî –°–∏—Å—Ç–µ–º–∞ "—Ä–∞–∑–¥–≤–æ–∏–ª–∞—Å—å"

**Root cause:**

```mermaid
graph TB
    subgraph "–î–¶ 1 (–ú–æ—Å–∫–≤–∞)"
        B1[Backend 1-5]
        R1[(Redis Master)]
    end
    
    subgraph "–î–¶ 2 (–°–ü–±)"
        B2[Backend 6-10]
        R2[(Redis Replica<br/>promoted to Master)]
    end
    
    B1 --> R1
    B2 --> R2
    
    R1 -.->|—Å–µ—Ç—å —É–ø–∞–ª–∞| R2

    classDef redisDark fill:#212121,stroke:#000000,color:#ffffff;
    class R1,R2 redisDark;
```

**Timeline:**
```
03:00 ‚Äî –°–µ—Ç–µ–≤–æ–π —Å–±–æ–π, Redis replica –≤ –°–ü–± –ø–æ—Ç–µ—Ä—è–ª–∞ —Å–≤—è–∑—å —Å master
03:01 ‚Äî Redis Sentinel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–Ω—É–ª replica –≤ master
03:02 ‚Äî –¢–µ–ø–µ—Ä—å –¥–≤–∞ master'–∞ (split-brain!)
03:05 ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–∏—à—É—Ç –≤ —Ä–∞–∑–Ω—ã–µ Redis
03:10 ‚Äî –û–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É
03:15 ‚Äî –í—Ä—É—á–Ω—É—é –æ—Ç–∫–ª—é—á–∏–ª–∏ –æ–¥–∏–Ω –∏–∑ master'–æ–≤
03:20 ‚Äî –†–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
03:30 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
```

**–§–∏–∫—Å:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Redis Sentinel quorum
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ split-brain —Å–∏—Ç—É–∞—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ "–º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞" –ø—Ä–∏ partition

#### –ò–Ω—Ü–∏–¥–µ–Ω—Ç 3: Cache –≤—Å–µ–≥–¥–∞ —Ö–æ–ª–æ–¥–Ω—ã–π

**–ö–æ–º–ø–∞–Ω–∏—è:** E-commerce  
**–î–∞—Ç–∞:** 2023

**–°–∏–º–ø—Ç–æ–º—ã:**
- Hit rate –ø–æ—Å—Ç–æ—è–Ω–Ω–æ < 30%
- –ë–î –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞
- Latency P99 = 500ms (–ø—Ä–∏ –Ω–æ—Ä–º–µ 100ms)

**Root cause:**

```php
<?php

// –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Redis eviction
// redis.conf:
// maxmemory-policy allkeys-random  # ‚ùå –°–ª—É—á–∞–π–Ω–∞—è —ç–≤–∏–∫—Ü–∏—è!
```

Redis –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª —Å–ª—É—á–∞–π–Ω—ã–µ –∫–ª—é—á–∏, –≤–∫–ª—é—á–∞—è –≥–æ—Ä—è—á–∏–µ —Ç–æ–≤–∞—Ä—ã.

**–§–∏–∫—Å:**
```php
<?php

// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ redis.conf:
// maxmemory-policy allkeys-lru  # ‚úÖ LRU eviction
// maxmemory 10gb

// + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ eviction rate (–ø—Å–µ–≤–¥–æ–∫–æ–¥)
$evictedKeysPerSec = getRedisMetric('evicted_keys_per_sec');
if ($evictedKeysPerSec > 1000) {
    alert('Redis evicting too much! Increase memory.');
}
```

### 4.4. –ö—ç—à –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ (–ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä)

**–ó–∞–¥–∞—á–∞ –æ—Ç –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞:**

> "–°–ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ —Å 100k RPS.  
> –ï—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥ (1M —Ç–æ–≤–∞—Ä–æ–≤), –∫–æ—Ä–∑–∏–Ω—ã (500k –∞–∫—Ç–∏–≤–Ω—ã—Ö), –∑–∞–∫–∞–∑—ã (10k/–¥–µ–Ω—å).  
> –ö–∞–∫ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à?"

**‚ùå –ü–ª–æ—Ö–æ–π –æ—Ç–≤–µ—Ç (Junior/Middle –±–µ–∑ –æ–ø—ã—Ç–∞):**

> "–ü–æ—Å—Ç–∞–≤–ª—é Redis. –ë—É–¥—É –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë —Å TTL 60 —Å–µ–∫—É–Ω–¥.  
> –ï—Å–ª–∏ –±–∞–∑–∞ —É–ø–∞–¥—ë—Ç, –∫—ç—à –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç."

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- "–í—Å—ë" ‚Äî –ø–ª–æ—Ö–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–ø–∞–º—è—Ç—å, coherence)
- Redis –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ë–î

**‚úÖ –•–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç (Senior/Lead):**

*–®–∞–≥ 1: –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã*

> "–û—Ç–ª–∏—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω—é –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–º–µ–Ω—Ç–æ–≤:
>
> 1. **–ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–º—ã–µ –≥–æ—Ä—è—á–∏–µ?**
     >    - –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤? –ö–æ—Ä–∑–∏–Ω—ã? –°–µ—Å—Å–∏–∏?
>    - –ï—Å—Ç—å –ª–∏ "—Ç–æ–≤–∞—Ä—ã –¥–Ω—è" —Å –∞–Ω–æ–º–∞–ª—å–Ω—ã–º QPS?
>
> 2. **SLA –ø–æ latency?**
     >    - P99 < 100ms? P50 < 50ms?
>    - –†–∞–∑–Ω—ã–µ SLA –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü?
>
> 3. **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö?**
     >    - –¶–µ–Ω—ã ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ?
>    - –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ ‚Äî –º–æ–∂–µ–º –ª–∏ oversell?
>    - –ö–æ—Ä–∑–∏–Ω–∞ ‚Äî eventual consistency –æ–∫–µ–π?
>
> 4. **–ë—é–¥–∂–µ—Ç –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É?**
     >    - –ú–æ–∂–µ–º –ª–∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å CDN?
>    - –°–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –ø–æ–¥ Redis?
>
> 5. **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ?**
     >    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –†–§ –∏–ª–∏ worldwide?"

*–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –¥–∞—ë—Ç –æ—Ç–≤–µ—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä:*
- –ì–æ—Ä—è—á–∏–µ: —Ç–æ–ø-10k —Ç–æ–≤–∞—Ä–æ–≤ (80% —Ç—Ä–∞—Ñ–∏–∫–∞), –∫–æ—Ä–∑–∏–Ω—ã, —Å–µ—Å—Å–∏–∏
- SLA: P99 < 100ms –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞, <50ms –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
- –¶–µ–Ω—ã: eventual consistency –¥–æ 30 —Å–µ–∫ –æ–∫–µ–π
- –û—Å—Ç–∞—Ç–∫–∏: –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–µ–ª—å–∑—è oversell
- –ë—é–¥–∂–µ—Ç: —Å—Ä–µ–¥–Ω–∏–π, CDN –º–æ–∂–µ–º
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: –†–§ + –°–ù–ì

*–®–∞–≥ 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ*

```
–ü—Ä–µ–¥–ª–∞–≥–∞—é –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ö–µ–º—É:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 1: CDN (CloudFlare)             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - –°—Ç–∞—Ç–∏–∫–∞ (JS/CSS/images): TTL 1 –¥–µ–Ω—å   ‚îÇ
‚îÇ - –°—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞: TTL 5 –º–∏–Ω—É—Ç        ‚îÇ
‚îÇ - Hit rate —Ü–µ–ª—å: >95%                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì 5% miss
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 2: L1 in-process –∫—ç—à            ‚îÇ
‚îÇ (–Ω–∞ –∫–∞–∂–¥–æ–º –∏–∑ 20 backend-—Å–µ—Ä–≤–µ—Ä–æ–≤)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: TTL 1 –º–∏–Ω      ‚îÇ
‚îÇ - –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: TTL 30 —Å–µ–∫             ‚îÇ
‚îÇ - –¢–æ–ø-100 —Ç–æ–≤–∞—Ä–æ–≤: TTL 30 —Å–µ–∫           ‚îÇ
‚îÇ - –†–∞–∑–º–µ—Ä: 100 MB/—Å–µ—Ä–≤–µ—Ä, LRU            ‚îÇ
‚îÇ - Hit rate —Ü–µ–ª—å: >70%                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì 30% miss
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 3: Redis –∫–ª–∞—Å—Ç–µ—Ä (6 –Ω–æ–¥)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - –ì–æ—Ä—è—á–∏–µ —Ç–æ–≤–∞—Ä—ã (top-10k): TTL 5 –º–∏–Ω   ‚îÇ
‚îÇ - –ö–æ—Ä–∑–∏–Ω—ã: TTL 1 —á–∞—Å                     ‚îÇ
‚îÇ - –°–µ—Å—Å–∏–∏: TTL –ø–æ —Ç–æ–∫–µ–Ω—É                  ‚îÇ
‚îÇ - –ê–≥—Ä–µ–≥–∞—Ç—ã (—Å—á—ë—Ç—á–∏–∫–∏): TTL 30 —Å–µ–∫       ‚îÇ
‚îÇ - –†–∞–∑–º–µ—Ä: 64 GB, LRU eviction           ‚îÇ
‚îÇ - Hit rate —Ü–µ–ª—å: >90%                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì 10% miss
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 4: PostgreSQL                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - Source of Truth                        ‚îÇ
‚îÇ - Master-Replica setup                   ‚îÇ
‚îÇ - Reads: replica, Writes: master         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

*–®–∞–≥ 3: –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏*

> "**–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** (–æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞):
> - –í –∫—ç—à–µ —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, TTL 10 —Å–µ–∫—É–Ω–¥
> - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ë–î
> - –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ: SELECT FOR UPDATE (–ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
> - –ü–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏: event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è
>
> **–î–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–Ω—è** (hot keys):
> - –†–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º –≤ L1 –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
> - –û—Ç–¥–µ–ª—å–Ω—ã–π tier Redis –¥–ª—è —Å—É–ø–µ—Ä-–≥–æ—Ä—è—á–∏—Ö –∫–ª—é—á–µ–π
> - Request coalescing —á–µ—Ä–µ–∑ singleflight
>
> **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º:**
> - Thundering herd: jittered TTL + early refresh
> - Cold start: batch pre-warming —Ç–æ–ø-1000 —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ deploy
> - Coherence: event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Kafka"

*–®–∞–≥ 4: –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å*

> "**–ú–µ—Ç—Ä–∏–∫–∏:**
> - Hit rate –ø–æ –∫–∞–∂–¥–æ–º—É —Å–ª–æ—é (CDN/L1/L2)
> - P99 latency breakdown
> - Stale read rate (—á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
> - Redis memory usage & eviction rate
> - Hot keys detection (>10k RPS)
>
> **Alerts:**
> - Hit rate < 80% ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å TTL, –ø–∞–º—è—Ç—å
> - QPS –Ω–∞ –ë–î > 2x baseline ‚Üí stampede?
> - Eviction rate > 1000/sec ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å
>
> **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
> - Load test: 100k RPS, P99 < 100ms ‚úÖ
> - Chaos: Redis restart, –ø—Ä–æ–≤–µ—Ä–∫–∞ graceful degradation
> - Deploy: –ø—Ä–æ–≤–µ—Ä–∫–∞ cache warming < 2 –º–∏–Ω—É—Ç—ã"

*–®–∞–≥ 5: Trade-offs*

> "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
> - ‚úÖ –ù–∏–∑–∫–∞—è latency (90% –∑–∞–ø—Ä–æ—Å–æ–≤ < 20ms)
> - ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –≤ 100x
> - ‚úÖ –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ stampede
> - ‚úÖ Geographical distribution —á–µ—Ä–µ–∑ CDN
>
> **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
> - ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∫—ç—à–∞
> - ‚ùå Eventual consistency (–¥–æ 30 —Å–µ–∫)
> - ‚ùå –°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (CDN + Redis)
>
> **–ö–æ–≥–¥–∞ —ç—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:**
> - Strong consistency –∫—Ä–∏—Ç–∏—á–Ω–∞ (—Ñ–∏–Ω—Ç–µ—Ö)
> - –î–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
> - –ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (<1k RPS)"

**–ß—Ç–æ –≤–∏–¥–∏—Ç –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ (–≤–æ–ø—Ä–æ—Å—ã ‚Üí –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Üí –¥–µ—Ç–∞–ª–∏)
- ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ trade-offs
- ‚úÖ –ó–Ω–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (stampede, hot keys, coherence)
- ‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–ø—ã—Ç (–º–µ—Ç—Ä–∏–∫–∏, —Ç–µ—Å—Ç—ã, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

### 4.5. Tricky –∫–µ–π—Å—ã

#### –ö–µ–π—Å 1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç "–∞—Å–¥—Ñ–∞—Å–¥—Ñ" ‚Üí –ø—É—Å—Ç–∞—è –≤—ã–¥–∞—á–∞ ‚Üí –∑–∞–ø—Ä–æ—Å –≤ –ë–î. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç 100 —Ä–∞–∑ ‚Üí 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î.

**–†–µ—à–µ–Ω–∏–µ:**

```php
<?php

use Doctrine\DBAL\Connection;
use Predis\Client as RedisClient;

final class SearchService
{
    public function __construct(
        private Connection $connection,
        private RedisClient $redis,
    ) {}

    public function searchProducts(string $query): array
    {
        $cacheKey = sprintf('search:%s', $query);

        $cached = $this->redis->get($cacheKey);
        if ($cached !== null) {
            return json_decode($cached, true, flags: JSON_THROW_ON_ERROR);
        }

        // –ü–æ–∏—Å–∫ –≤ –ë–î
        $products = $this->connection->fetchAllAssociative(
            'SELECT * FROM products WHERE name ILIKE :q',
            ['q' => '%'.$query.'%'],
        );

        if ($products === []) {
            // –ö—ç—à–∏—Ä—É–µ–º –ü–£–°–¢–û–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL
            $this->redis->setex($cacheKey, 60, '[]'); // 60 —Å–µ–∫—É–Ω–¥
        } else {
            $this->redis->setex($cacheKey, 300, json_encode($products, JSON_THROW_ON_ERROR));
        }

        return $products;
    }
}
```

**–í–∞–∂–Ω–æ:** TTL –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—á–µ!

#### –ö–µ–π—Å 2: Multi-tenant —Å–∏—Å—Ç–µ–º—ã

**–ë–∞–≥:**

```php
<?php

// ‚ùå –ó–∞–±—ã–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å tenant_id –≤ –∫–ª—é—á!
function getUserSettingsBroken(int $userId, RedisClient $redis): array {
    $key = sprintf('settings:%d', $userId);  // –ë–ê–ì!
    // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** User #123 –≤ tenant A –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ user #123 –∏–∑ tenant B!

**–§–∏–∫—Å:**

```php
<?php

// ‚úÖ –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º tenant_id
function getUserSettings(string $tenantId, int $userId, RedisClient $redis): array {
    $key = sprintf('settings:%s:%d', $tenantId, $userId);
    // ...
}
```

#### –ö–µ–π—Å 3: –ö—ç—à –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

**–û–ø–∞—Å–Ω–æ—Å—Ç—å:**

```php
<?php

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª admin, –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–∞–≤–∞
$cache->set(sprintf('acl:%d', $userId), ['role' => 'admin'], 3600); // 1 —á–∞—Å!

// –ß–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –ø–æ–Ω–∏–∑–∏–ª–∏ –¥–æ user
$connection->executeStatement(
    'UPDATE users SET role = :role WHERE id = :id',
    ['role' => 'user', 'id' => $userId],
);

// –ù–æ –∫—ç—à –µ—â—ë 50 –º–∏–Ω—É—Ç –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å admin! ‚ùå
```

**–†–µ—à–µ–Ω–∏–µ:**

```php
<?php

// –ö–æ—Ä–æ—Ç–∫–∏–π TTL –¥–ª—è –ø—Ä–∞–≤
const ACL_TTL = 60; // 1 –º–∏–Ω—É—Ç–∞

// + Event-based –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤
final class UserRoleChangedEvent
{
    public function __construct(
        public readonly int $userId,
    ) {}
}

final class AclCacheInvalidationListener
{
    public function __construct(private RedisClient $redis) {}

    public function __invoke(UserRoleChangedEvent $event): void
    {
        $this->redis->del([sprintf('acl:%d', $event->userId)]);
    }
}
```

### 4.6. –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

–ü—Ä–æ—Ö–æ–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:

‚úÖ **1. Source of truth –æ–ø—Ä–µ–¥–µ–ª—ë–Ω**
```
–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏—Å—Ç–∏–Ω–∞? PostgreSQL
–î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞?
- –ö–∞—Ç–∞–ª–æ–≥: 60 —Å–µ–∫—É–Ω–¥
- –ö–æ—Ä–∑–∏–Ω–∞: 5 —Å–µ–∫—É–Ω–¥  
- –ë–∞–ª–∞–Ω—Å: 1 —Å–µ–∫—É–Ω–¥–∞
```

‚úÖ **2. –ß—Ç–æ –∫—ç—à–∏—Ä—É–µ–º / —á—Ç–æ –ù–ï –∫—ç—à–∏—Ä—É–µ–º**
```
–ö–≠–®–ò–†–£–ï–ú:
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (TTL 5 –º–∏–Ω)
- –ö–∞—Ç–∞–ª–æ–≥ (TTL 1 –º–∏–Ω)
- –ê–≥—Ä–µ–≥–∞—Ç—ã (TTL 30 —Å–µ–∫)

–ù–ï –ö–≠–®–ò–†–£–ï–ú:
- –û—Å—Ç–∞—Ç–∫–∏ (read-through —Å –ë–î)
- –ë–∞–ª–∞–Ω—Å (read-through —Å –ë–î)
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```

‚úÖ **3. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**
```
–ú–µ—Ö–∞–Ω–∏–∑–º: Kafka events + fallback TTL
–¢–µ—Å—Ç: –í–Ω–æ—Å–∏–º 500ms –∑–∞–¥–µ—Ä–∂–∫—É ‚Üí stale rate < 1% ‚úÖ
Fallback: –ü—Ä–∏ –æ—Ç–∫–∞–∑–µ Kafka ‚Äî –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ TTL
```

‚úÖ **4. –ó–∞—â–∏—Ç–∞ –æ—Ç stampede**
```
- Single-flight: ‚úÖ (singleflight.Group)
- Jittered TTL: ‚úÖ (¬±10% —Ä–∞–Ω–¥–æ–º)
- Early refresh: ‚úÖ (–∑–∞ 30 —Å–µ–∫ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
```

‚úÖ **5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω**
```
–ú–µ—Ç—Ä–∏–∫–∏:
- cache_hit_rate{layer} > 80%
- cache_latency_p99{layer} < 10ms
- db_qps < 1000 (baseline: 500)
- stale_read_rate < 0.01

Alerts:
- Hit rate drop >20% –∑–∞ 5 –º–∏–Ω
- QPS spike >2x
- Hot key detected (>10k RPS)
```

‚úÖ **6. Load tests –ø—Ä–æ–π–¥–µ–Ω—ã**
```
–¢–µ—Å—Ç 1: 100k RPS ‚Üí P99 < 100ms ‚úÖ
–¢–µ—Å—Ç 2: FLUSHALL Redis ‚Üí recovery < 2 min ‚úÖ
–¢–µ—Å—Ç 3: Deploy —Å cache warming ‚Üí hit rate 80% –∑–∞ 1 –º–∏–Ω ‚úÖ
```

‚úÖ **7. Runbook –≥–æ—Ç–æ–≤**
```
–ï—Å–ª–∏ hit rate < 50%:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis memory (redis-cli INFO memory)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å eviction rate (evicted_keys)
3. –ï—Å–ª–∏ eviction >1000/sec ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å
4. Escalate –∫ SRE –µ—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ

–ï—Å–ª–∏ stampede:
1. –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å TTL (—Å–Ω–∏–∑–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è)
2. –í–∫–ª—é—á–∏—Ç—å early refresh
3. –î–æ–±–∞–≤–∏—Ç—å jitter –µ—Å–ª–∏ –Ω–µ—Ç
4. –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ ‚Äî FLUSHALL –∏ –ø—Ä–æ–≥—Ä–µ–≤ –ø–æ –±–∞—Ç—á–∞–º
```

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (2-3 –º–∏–Ω—É—Ç—ã)

–ú—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏ —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **Cache Coherence** ‚Äî –∫–∞–∫ –¥–µ—Ä–∂–∞—Ç—å –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏
    - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏: TTL-only, event-based, lease-based
    - Trade-off –º–µ–∂–¥—É consistency –∏ performance

2. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    - –ë—Ä–∞—É–∑–µ—Ä ‚Üí CDN ‚Üí L1 ‚Üí L2 ‚Üí –ë–î
    - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: hot keys, request coalescing, cache warming

3. **–°–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** ‚Äî —á—Ç–æ –ª–æ–º–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
    - Thundering herd, stale data, split-brain
    - –ö–∞–∫ —ç—Ç–æ —Ä–µ—à–∞—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å

**–ö–ª—é—á–µ–≤—ã–µ takeaways:**

- –ö—ç—à ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ "—É—Å–∫–æ—Ä–∏—Ç–µ–ª—å", –∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å trade-off –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å—é
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è (race conditions, events, TTL)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω (hit rate, latency, stale reads)
- –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ –≤–∞–∂–Ω–µ–µ –∑–∞–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á–µ–º –¥–∞–≤–∞—Ç—å "–≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ"

**–ß—Ç–æ –¥–∞–ª—å—à–µ:**

–í —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö –º—ã —Ä–∞–∑–±–µ—Ä—ë–º:
- –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (2PC, Saga, Outbox pattern)
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (consistent hashing, rebalancing)
- Performance optimization (tail latency, throughput scaling)

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

1. –í–æ–∑—å–º–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç ‚Äî –Ω–∞—Ä–∏—Å—É–π—Ç–µ —Å—Ö–µ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
2. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 7 –≤–æ–ø—Ä–æ—Å–æ–≤ —á–µ–∫–ª–∏—Å—Ç–∞
3. –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ hit rate –∏ stale reads
4. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ load test —Å —Å–∏–º—É–ª—è—Ü–∏–µ–π stampede

–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ! –í–æ–ø—Ä–æ—Å—ã?

---

## –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´

### –î–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è –∑–∞–º–µ—Ç–æ–∫

```mermaid
mindmap
  root((–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ))
    –°—Ç—Ä–∞—Ç–µ–≥–∏–∏
      TTL-only
      Event-based
      Lease-based
    –°–ª–æ–∏
      –ë—Ä–∞—É–∑–µ—Ä
      CDN
      L1 in-process
      L2 Redis
      –ë–î
    –ü—Ä–æ–±–ª–µ–º—ã
      Thundering herd
      Stale data
      Coherence
      Split-brain
    –†–µ—à–µ–Ω–∏—è
      Single flight
      Jittered TTL
      Early refresh
      –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    –ú–µ—Ç—Ä–∏–∫–∏
      Hit rate
      Latency
      Stale reads
      Eviction rate
```

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

**–¢–µ–æ—Ä–∏—è:**
- Designing Data-Intensive Applications (Martin Kleppmann) ‚Äî Chapter 5
- "Cache made consistent" ‚Äî Meta Engineering
- "Distributed Caching Woes" ‚Äî Medium

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**
- Redis documentation: Caching patterns
- Memcached documentation
- singleflight package (Golang)

**–î–æ–∫–ª–∞–¥—ã:**
- "Effective Caching Strategies" (YouTube)
- "Thundering Herd Problem" (conf talks)
- Highload++ –¥–æ–∫–ª–∞–¥—ã –ø–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é

---

**–ö–æ–Ω–µ—Ü —Å—Ü–µ–Ω–∞—Ä–∏—è**
