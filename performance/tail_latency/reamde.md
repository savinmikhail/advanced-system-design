# Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹: Tail Latency Ð² Production
## ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð²Ð¸Ð´ÐµÐ¾ (35-40 Ð¼Ð¸Ð½ÑƒÑ‚)

---

## ðŸŽ¬ Ð’Ð’Ð•Ð”Ð•ÐÐ˜Ð•

ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð’Ñ‹ ÐºÐ¾Ð³Ð´Ð°-Ð½Ð¸Ð±ÑƒÐ´ÑŒ ÑÑ‚Ð°Ð»ÐºÐ¸Ð²Ð°Ð»Ð¸ÑÑŒ Ñ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÐµÐ¹: Ð²Ð°Ñˆ ÑÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾, Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð² Ð½Ð¾Ñ€Ð¼Ðµ, ÑÑ€ÐµÐ´Ð½ÑÑ latency â€” 20 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´... Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð²Ð½ÐµÐ·Ð°Ð¿Ð½Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð½Ð° Ñ‚Ð¾Ñ€Ð¼Ð¾Ð·Ð°? Ð’Ñ‹ ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð½Ð° Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ñ‹ â€” Ð²Ñ€Ð¾Ð´Ðµ Ð²ÑÑ‘ Ð¾Ðº. ÐÐ¾ Ð¶Ð°Ð»Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽÑ‚ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°Ñ‚ÑŒ.

Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¼Ð¸Ñ€ **tail latency** â€” Ñ‚Ð¾Ð¹ ÑÐ°Ð¼Ð¾Ð¹ ÑˆÑ‚ÑƒÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð´ÐµÐ»Ð°ÐµÑ‚ Ð²Ð¸Ð´, Ñ‡Ñ‚Ð¾ Ñƒ Ð²Ð°Ñ "Ð²ÑÑ‘ Ð±Ñ‹ÑÑ‚Ñ€Ð¾", Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð² ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ ÑƒÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ð°Ð¿Ð¾ÐºÐ°Ð»Ð¸Ð¿ÑÐ¸Ñ.

Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ Ñ€Ð°ÑÑÐºÐ°Ð¶Ñƒ Ð²Ð°Ð¼ Ð½Ðµ Ñ‚ÐµÐ¾Ñ€ÐµÑ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ†Ð¸ÑŽ Ð¸Ð· ÑƒÑ‡ÐµÐ±Ð½Ð¸ÐºÐ¾Ð², Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð±Ð¾Ð»ÑŒ production-ÑÐ¸ÑÑ‚ÐµÐ¼. ÐœÑ‹ Ñ€Ð°Ð·Ð±ÐµÑ€Ñ‘Ð¼:
- ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ ÑÑ€ÐµÐ´Ð½ÑÑ latency â€” ÑÑ‚Ð¾ Ð»Ð¾Ð¶ÑŒ
- ÐšÐ°Ðº Ð¾Ð´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð²Ð°Ð»Ð¸Ñ‚ Ð²ÑÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
- Ð˜ ÑÐ°Ð¼Ð¾Ðµ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ â€” ÐºÐ°Ðº Ñ ÑÑ‚Ð¸Ð¼ Ð±Ð¾Ñ€Ð¾Ñ‚ÑŒÑÑ Ð½Ð° Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐµ

Ð­Ñ‚Ð¾ ÐºÑƒÑ€Ñ Ð´Ð»Ñ middle+ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑƒÐ¶Ðµ ÑÑ‚Ð°Ð»ÐºÐ¸Ð²Ð°Ð»Ð¸ÑÑŒ Ñ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ñ‹Ð¼Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ð¼Ð¸. ÐŸÐ¾ÐµÑ…Ð°Ð»Ð¸!

---

## ðŸ“Š Ð‘Ð›ÐžÐš 1: ÐŸÐ ÐžÐ‘Ð›Ð•ÐœÐ

### Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ tail latency

Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð½Ð°Ñ‡Ð½Ñ‘Ð¼ Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð³Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ. **Latency** â€” ÑÑ‚Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ. Ð˜ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¼Ñ‹ ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð½Ð° ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¼ÐµÐ´Ð¸Ð°Ð½Ñƒ. Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð·Ð° 20 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´ â€” ÐºÑ€ÑƒÑ‚Ð¾, Ð´Ð°?

ÐÐ¾ ÐµÑÑ‚ÑŒ Ð½ÑŽÐ°Ð½Ñ. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ latency.

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ Ð“Ð ÐÐ¤Ð˜Ðš: histogram Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ]**

Ð’Ð¸Ð´Ð¸Ñ‚Ðµ? Ð‘Ð¾Ð»ÑŒÑˆÐ°Ñ Ñ‡Ð°ÑÑ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ â€” 10-30 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´. ÐÐ¾ ÐµÑÑ‚ÑŒ Ñ…Ð²Ð¾ÑÑ‚. Ð¢Ð¾Ñ‚ ÑÐ°Ð¼Ñ‹Ð¹ tail. Ð˜ Ð²Ð¾Ñ‚ Ð² ÑÑ‚Ð¾Ð¼ Ñ…Ð²Ð¾ÑÑ‚Ðµ:
- p95 (95-Ð¹ Ð¿ÐµÑ€Ñ†ÐµÐ½Ñ‚Ð¸Ð»ÑŒ) â€” 95% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ ÑÑ‚Ð¾Ð³Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
- p99 â€” 99% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ
- p999 â€” 99.9% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ

Ð˜ Ð²Ð¾Ñ‚ Ñ‚ÑƒÑ‚ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ð¼Ð°Ð³Ð¸Ñ. Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ:
- ÐœÐµÐ´Ð¸Ð°Ð½Ð° (p50) = 20 Ð¼Ñ
- p99 = 1 ÑÐµÐºÑƒÐ½Ð´Ð°
- p999 = 5 ÑÐµÐºÑƒÐ½Ð´

ÐžÐ´Ð¸Ð½ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¼ÐµÐ´Ð»ÐµÐ½Ð½ÐµÐµ **Ð² 50 Ñ€Ð°Ð·**. ÐžÐ´Ð¸Ð½ Ð¸Ð· Ñ‚Ñ‹ÑÑÑ‡Ð¸ â€” Ð¼ÐµÐ´Ð»ÐµÐ½Ð½ÐµÐµ Ð² 250 Ñ€Ð°Ð·!

Ð˜ Ð²Ð¾Ñ‚ ÑÑ‚Ð¸ Ñ€ÐµÐ´ÐºÐ¸Ðµ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ â€” Ð¾Ð½Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ "Ñ€ÐµÐ´ÐºÐ¸Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸". ÐžÐ½Ð¸ **Ð»Ð¾Ð¼Ð°ÑŽÑ‚ Ð²ÑÑ‘**.

### ÐžÑ‚ÐºÑƒÐ´Ð° Ð±ÐµÑ€ÑƒÑ‚ÑÑ Ñ…Ð²Ð¾ÑÑ‚Ñ‹

Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾, Ð½Ð¾ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ°ÐµÑ‚ ÑÑ‚Ð° Ð¸Ð·Ð¼ÐµÐ½Ñ‡Ð¸Ð²Ð¾ÑÑ‚ÑŒ? ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ð´Ñ€ÑƒÐ³ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ Ñ‚Ð¾Ñ€Ð¼Ð¾Ð·Ð¸Ñ‚ÑŒ?

ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÑŒ Ð½Ð° Ñ‚Ñ€Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:

#### ÐÐ¿Ð¿Ð°Ñ€Ð°Ñ‚Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹

**GC Ð¿Ð°ÑƒÐ·Ñ‹** â€” ÑÑ‚Ð¾ ÐºÐ»Ð°ÑÑÐ¸ÐºÐ°. Ð’Ð°Ñˆ Java-ÑÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¸ Ð±Ð°Ñ† â€” Stop The World ÑÐ±Ð¾Ñ€ÐºÐ° Ð¼ÑƒÑÐ¾Ñ€Ð° Ð½Ð° 200 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´. Ð’ÑÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð² ÑÑ‚Ð¾Ñ‚ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚, Ð²Ð¸ÑÑÑ‚.

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ Ð“Ð ÐÐ¤Ð˜Ðš: spike latency Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ GC]**

**CPU preemption** â€” Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ€ÐµÑˆÐ¸Ð»Ð°, Ñ‡Ñ‚Ð¾ Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑƒ ÑÑ€Ð¾Ñ‡Ð½Ð¾ Ð½ÑƒÐ¶ÐµÐ½ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€. Ð’Ð°Ñˆ Ð²Ð¾Ñ€ÐºÐµÑ€ Ð¶Ð´Ñ‘Ñ‚ ÑÐ²Ð¾ÐµÐ¹ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸.

**Disk I/O** â€” Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð»Ð¾Ð³, flush Ð½Ð° Ð´Ð¸ÑÐº, Ð²Ð½ÐµÐ·Ð°Ð¿Ð½Ð°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¾Ñ‚ ÑÐ¾ÑÐµÐ´Ð½ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð½Ð° Ñ‚Ð¾Ð¹ Ð¶Ðµ Ð¼Ð°ÑˆÐ¸Ð½Ðµ.

**Memory paging** â€” ÐµÑÐ»Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð±Ñ‹Ð»Ð° Ð²Ñ‹Ñ‚ÐµÑÐ½ÐµÐ½Ð° Ð½Ð° Ð´Ð¸ÑÐº, Ñ‚Ð¾ Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸ Ðº Ð½ÐµÐ¹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ page fault Ð¸ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð² Ð´ÐµÑÑÑ‚ÐºÐ¸ Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´.

**NUMA ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹** â€” Ð½Ð° ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼Ð½Ð¾Ð³Ð¾Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€Ð½Ñ‹Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð°Ñ… Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº "Ñ‡ÑƒÐ¶Ð¾Ð¹" Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½ÐµÐµ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð·.

#### Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹

**ÐŸÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ð¹ Ñ€Ð¾ÑƒÑ‚ÐµÑ€** â€” Ð¿Ð°ÐºÐµÑ‚ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ñ‡ÐµÑ€ÐµÐ· switch, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð² ÑÑ‚Ð¾Ñ‚ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ burst Ñ‚Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°.

**Packet retransmission** â€” Ð¾Ð´Ð¸Ð½ Ð¿Ð°ÐºÐµÑ‚ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ»ÑÑ, TCP ÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÐ¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ â€” Ð´Ð¾Ð±Ð°Ð²Ð¸Ð»Ð¸ 100-200 Ð¼Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸.

**ÐÐµÑ€Ð°Ð²Ð½Ð¾Ð¼ÐµÑ€Ð½Ð°Ñ Ñ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð³Ð¸Ñ** â€” Ð¾Ð´Ð¸Ð½ Ð²Ð°Ñˆ instance Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð°Ð»ÑŒÑˆÐµ Ð¾Ñ‚ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‡ÐµÐ¼ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ.

#### ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ°

**Hot key** â€” Ð²ÑÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¸Ð´ÑƒÑ‚ Ð·Ð° Ð¾Ð´Ð½Ð¸Ð¼ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¼ ÐºÐ»ÑŽÑ‡Ð¾Ð¼, ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ contention.

**Lock contention** â€” Ð¾Ð´Ð¸Ð½ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´ÐµÑ€Ð¶Ð¸Ñ‚ lock Ð´Ð¾Ð»ÑŒÑˆÐµ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾, Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¶Ð´ÑƒÑ‚.

**Ð¡ÐµÑ€Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²** â€” Ð¿Ñ€Ð¸ÑˆÑ‘Ð» Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ 5MB JSON, Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð²Ñ€ÐµÐ¼Ñ.

**ÐœÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ shard** â€” Ð² Ð²Ð°ÑˆÐµÐ¹ sharded Ð±Ð°Ð·Ðµ Ð¾Ð´Ð¸Ð½ shard Ñ‚Ð¾Ñ€Ð¼Ð¾Ð·Ð¸Ñ‚, Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ð½Ð° Ð½Ñ‘Ð¼ Ð¾ÐºÐ°Ð·Ð°Ð»Ð¸ÑÑŒ Ð³Ð¾Ñ€ÑÑ‡Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.

ÐŸÐ¾Ð½Ð¸Ð¼Ð°ÐµÑ‚Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½? Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸ tail latency â€” ÑÑ‚Ð¾ Ð½Ðµ Ð±Ð°Ð³Ð¸. Ð­Ñ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ, Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð² ÑÐ»Ð¾Ð¶Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ. ÐžÐ½Ð¸ ÑÐ»ÑƒÑ‡Ð°ÑŽÑ‚ÑÑ **Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð¾**.

### Ð­Ñ„Ñ„ÐµÐºÑ‚ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: The Tail at Scale

Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑÐ°Ð¼Ð¾Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ. Google Ð² ÑÐ²Ð¾ÐµÐ¹ ÐºÑƒÐ»ÑŒÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚ÑŒÐµ "The Tail at Scale" Ð¿Ð¾ÐºÐ°Ð·Ð°Ð» ÑÑ‚Ñ€Ð°ÑˆÐ½ÑƒÑŽ Ð²ÐµÑ‰ÑŒ.

ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ: Ñƒ Ð²Ð°Ñ Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°. Frontend Ð´ÐµÐ»Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹:
- Ð˜Ð´Ñ‘Ñ‚ Ð² Auth ÑÐµÑ€Ð²Ð¸Ñ
- ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð² Profile
- ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð² Recommendations (ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð´Ñ‘Ñ€Ð³Ð°ÐµÑ‚ 5 Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²)
- ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð² Cart
- ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð² Pricing

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ ÑÐ°Ð¼ Ð¿Ð¾ ÑÐµÐ±Ðµ Ñ…Ð¾Ñ€Ð¾Ñˆ. Ð£ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ p99 = 100 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´. ÐšÑ€ÑƒÑ‚Ð¾ Ð¶Ðµ?

Ð’Ð¾Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ð² p99 **Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð½Ð¾Ð³Ð¾** ÑÐµÑ€Ð²Ð¸ÑÐ° Ð¿Ñ€Ð¸ Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÐµ Ð¸Ð· N Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð² Ñ€Ð°ÑÑ‚Ñ‘Ñ‚ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ ÐºÐ°Ðº:

```
P(Ñ…Ð¾Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹) â‰ˆ 1 - (0.99)^N
```

Ð”Ð»Ñ 5 ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²: 1 - 0.99^5 â‰ˆ 5% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð¾Ð¿Ð°Ð´ÑƒÑ‚ Ð² Ñ‡ÐµÐ¹-Ñ‚Ð¾ p99.

Ð ÐµÑÐ»Ð¸ Ð¾Ð´Ð¸Ð½ ÑÐµÑ€Ð²Ð¸Ñ Ð´ÐµÐ»Ð°ÐµÑ‚ 100 Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² backend (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…)? Google Ð¿Ð¾ÐºÐ°Ð·Ð°Ð»: Ð²Ð¼ÐµÑÑ‚Ð¾ Ð²Ð°ÑˆÐµÐ³Ð¾ p99 Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚Ðµ p99^100. ÐœÐ°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ñ…Ð²Ð¾ÑÑ‚ Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ð² **Ñ‡ÑƒÐ´Ð¾Ð²Ð¸Ñ‰Ðµ**.

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ DIAGRAM: Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ñ latency Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸ÐµÐ¼]**

### ÐšÐ°ÑÐºÐ°Ð´Ð½Ñ‹Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹: ÐºÐ°Ðº Ð¾Ð´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð»Ð¾Ð¼Ð°ÐµÑ‚ Ð²ÑÑ‘

Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾, Ð¾Ð´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ â€” Ð½Ñƒ Ð¸ Ñ‡Ñ‚Ð¾? Ð­Ñ‚Ð¾ Ð¶Ðµ 1%, Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ 99% Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ!

Ð’Ð¾Ñ‚ Ñ‚ÑƒÑ‚ Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ ÑÐ°Ð¼Ð¾Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ€Ð°Ð·Ð±ÐµÑ€Ñ‘Ð¼, **Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð¾Ð´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‚ÑÐ½ÐµÑ‚ Ð·Ð° ÑÐ¾Ð±Ð¾Ð¹ Ð»Ð°Ð²Ð¸Ð½Ñƒ**.

#### Ð­Ñ„Ñ„ÐµÐºÑ‚ 1: Queueing delay

Ð£ Ð²Ð°ÑˆÐµÐ³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ° 20 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð². ÐžÐ´Ð¸Ð½ Ð²Ð¾Ñ€ÐºÐµÑ€ Ð·Ð°Ð²Ð¸Ñ Ð½Ð° 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ. ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ 19 Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾.

Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚?
- Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²ÑÑ‚Ð°ÑŽÑ‚ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ
- Ð¢Ð¾Ñ‚ Ð¾Ð´Ð¸Ð½ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ ÑÐ»Ð¾Ñ‚
- Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¶Ð´Ñ‘Ñ‚ Ñ‡ÑƒÑ‚ÑŒ Ð´Ð¾Ð»ÑŒÑˆÐµ
- Ð˜ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð¶Ðµ
- ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚

Ð­Ñ‚Ð¾ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ **queueing delay**. Ð˜ Ð²Ð¾Ñ‚ Ñ‡Ñ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾: ÐµÑÐ»Ð¸ Ð²Ð°Ñˆ RPS Ð±Ð»Ð¸Ð·Ð¾Ðº Ðº Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ½Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸, Ð´Ð°Ð¶Ðµ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ ÑÐºÑÐ¿Ð¾Ð½ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ñ€Ð°ÑÑ‚ÑƒÑ‰ÑƒÑŽ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ.

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ Ð“Ð ÐÐ¤Ð˜Ðš: Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ queue time Ð¾Ñ‚ load]**

Ð­Ñ‚Ð¾ Ð·Ð°ÐºÐ¾Ð½ Ð›Ð¸Ñ‚Ñ‚Ð»Ð° Ð² Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸. ÐŸÑ€Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð»ÑŽÐ±Ð¾Ð¹ spike latency ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¾Ð³Ñ€Ð¾Ð¼Ð½ÑƒÑŽ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ.

#### Ð­Ñ„Ñ„ÐµÐºÑ‚ 2: Load Balancer Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð±Ð¾Ð»ÑŒ

Ð£ Ð²Ð°Ñ 10 ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð². Load balancer Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ round-robin:
- 9 ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð² Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽÑ‚ Ð·Ð° 20 Ð¼Ñ
- ÐžÐ´Ð¸Ð½ ÑÐµÑ€Ð²ÐµÑ€ Ñ‚Ð¾Ñ€Ð¼Ð¾Ð·Ð¸Ñ‚ â€” 800 Ð¼Ñ

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ 10-Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð½Ð° Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€. **ÐšÐ°Ð¶Ð´Ñ‹Ð¹ 10-Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ð¸Ð´Ð¸Ñ‚ Ð»Ð°Ð³ Ð² 40 Ñ€Ð°Ð· Ð±Ð¾Ð»ÑŒÑˆÐµ**.

Ð ÐµÑÐ»Ð¸ Ð²Ð°Ñˆ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð´ÐµÐ»Ð°ÐµÑ‚ 5 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð¾Ð´Ñ€ÑÐ´? Ð’ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ñ€Ð°Ð· Ð½Ð° Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ instance ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ 40%.

Ð‘Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº Ñ‡ÐµÑÑ‚Ð½Ð¾ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ñ‚Ñ€Ð°Ñ„Ð¸Ðº. Ð˜ **Ñ‡ÐµÑÑ‚Ð½Ð¾ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð±Ð¾Ð»ÑŒ**.

#### Ð­Ñ„Ñ„ÐµÐºÑ‚ 3: Timeout â†’ Retry Storm

Ð¡Ð°Ð¼Ñ‹Ð¹ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚. Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ:

1. Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð²Ð¸Ñ Ð½Ð° 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹
2. ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¶Ð´Ñ‘Ñ‚... timeout (Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ)
3. ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð´ÐµÐ»Ð°ÐµÑ‚ retry
4. Retry Ñ‚Ð¾Ð¶Ðµ Ð¸Ð´Ñ‘Ñ‚ Ð½Ð° Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ
5. Ð•Ñ‰Ñ‘ Ð¾Ð´Ð¸Ð½ timeout
6. Ð•Ñ‰Ñ‘ Ð¾Ð´Ð¸Ð½ retry

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ SEQUENCE DIAGRAM: cascading timeouts]**

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñƒ Ð²Ð°Ñ:
- 3-4 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¾Ñ‚ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
- ÐÐ°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²Ñ‹Ñ€Ð¾ÑÐ»Ð° Ð² 3-4 Ñ€Ð°Ð·Ð°
- Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ‚Ð¾Ð¶Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¸Ñ‚ÑŒ
- ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ **retry storm**
- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ

Ð­Ñ‚Ð¾ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ **cascading failure**. Ð˜ ÑÑ‚Ð¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ð°Ð»Ð¸Ñ‚ production.

#### Ð­Ñ„Ñ„ÐµÐºÑ‚ 4: Backpressure Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑÑ…

Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (RabbitMQ, Kafka):

1. Consumer Ð½Ð°Ñ‡Ð°Ð» Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾
2. ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚
3. ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹
4. Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð½Ð°ÐºÐ°Ð¿Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ
5. Ð”ÐµÐ´Ð»Ð°Ð¹Ð½Ñ‹ Ð½Ð°Ñ€ÑƒÑˆÐ°ÑŽÑ‚ÑÑ
6. ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ÑÑ Ñ€ÐµÑ‚Ñ€Ð°Ð¸
7. Ð•Ñ‰Ñ‘ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
8. Ð•Ñ‰Ñ‘ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸

**Ð¡Ð½ÐµÐ¶Ð½Ñ‹Ð¹ ÐºÐ¾Ð¼**.

#### Ð­Ñ„Ñ„ÐµÐºÑ‚ 5: Cache Miss Avalanche

ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹:

1. Hot key Ð² ÐºÑÑˆÐµ
2. ÐžÐ´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ refresh ÑÑ‚Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°
3. Ð”ÐµÑÑÑ‚ÐºÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ cache miss
4. Ð’ÑÐµ Ð¸Ð´ÑƒÑ‚ Ð² Ð±Ð°Ð·Ñƒ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾
5. Ð‘Ð°Ð·Ð° Ð½Ðµ Ð²Ñ‹Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚
6. Ð›Ð°Ñ‚ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ Ð±Ð°Ð·Ñ‹ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚
7. ÐšÑÑˆ Ð½Ðµ ÑƒÑÐ¿ÐµÐ²Ð°ÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒÑÑ
8. Ð•Ñ‰Ñ‘ Ð±Ð¾Ð»ÑŒÑˆÐµ miss
9. **Ð‘Ð°Ð·Ð° Ð¿Ð°Ð´Ð°ÐµÑ‚**

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ DIAGRAM: cache avalanche]**

### Ð˜Ñ‚Ð¾Ð³Ð¾ Ð¿Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ðµ

Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼:

**Tail latency Ð¾Ð¿Ð°ÑÐ½Ð° Ð½Ðµ Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ, Ñ‡Ñ‚Ð¾ "Ð¾Ð´Ð¸Ð½ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹".**

Tail latency Ð¾Ð¿Ð°ÑÐ½Ð°, Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾:
- Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° **ÑƒÑÐ¸Ð»Ð¸Ð²Ð°ÐµÑ‚** Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
- ÐžÑ‡ÐµÑ€ÐµÐ´Ð¸ **Ñ€Ð°Ð·Ð¼Ð½Ð¾Ð¶Ð°ÑŽÑ‚** Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
- Ð ÐµÑ‚Ñ€Ð°Ð¸ **ÑƒÐ¼Ð½Ð¾Ð¶Ð°ÑŽÑ‚** Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ
- Ð‘Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ¸ **Ñ€Ð°Ð²Ð½Ð¾Ð¼ÐµÑ€Ð½Ð¾ Ñ€Ð°Ð·Ð´Ð°ÑŽÑ‚** Ð±Ð¾Ð»ÑŒ
- Ð¦ÐµÐ¿Ð¾Ñ‡ÐºÐ¸ Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² **Ð½Ð°ÐºÑ€ÑƒÑ‡Ð¸Ð²Ð°ÑŽÑ‚** Ñ…Ð²Ð¾ÑÑ‚Ñ‹
- ÐšÑÑˆÐ¸ Ð¸ Ð±Ð°Ð·Ñ‹ **Ð½Ðµ Ð²Ñ‹Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚** Ð»Ð°Ð²Ð¸Ð½Ñƒ

> Tail latency â€” ÑÑ‚Ð¾ ÑÑ„Ñ„ÐµÐºÑ‚ Ð´Ð¾Ð¼Ð¸Ð½Ð¾. ÐžÐ´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð¾Ð»ÐºÐ°ÐµÑ‚ Ð²ÑÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð² Ð·Ð¾Ð½Ñƒ Ñ…Ð°Ð¾ÑÐ°.

Ð˜ ÑÑ‚Ð¾ Ð½Ðµ edge case. Ð­Ñ‚Ð¾ **Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ production-ÑÐ¸ÑÑ‚ÐµÐ¼**.

ÐžÐºÐµÐ¹, Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð¾Ð¹ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ð»Ð¸ÑÑŒ. Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑÐ°Ð¼Ð¾Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ â€” ÐºÐ°Ðº Ñ ÑÑ‚Ð¸Ð¼ Ð±Ð¾Ñ€Ð¾Ñ‚ÑŒÑÑ?

---

## ðŸ›  Ð‘Ð›ÐžÐš 2: Ð Ð•Ð¨Ð•ÐÐ˜Ð¯

Ð¥Ð¾Ñ€Ð¾ÑˆÐ°Ñ Ð½Ð¾Ð²Ð¾ÑÑ‚ÑŒ: ÐµÑÑ‚ÑŒ ÐºÑƒÑ‡Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ñ‚ÐµÑ…Ð½Ð¸Ðº Ð´Ð»Ñ Ð±Ð¾Ñ€ÑŒÐ±Ñ‹ Ñ tail latency. ÐŸÐ»Ð¾Ñ…Ð°Ñ Ð½Ð¾Ð²Ð¾ÑÑ‚ÑŒ: Ð½ÐµÑ‚ silver bullet. ÐÑƒÐ¶Ð½Ð° ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð².

Google Ð² ÑÐ²Ð¾ÐµÐ¹ ÑÑ‚Ð°Ñ‚ÑŒÐµ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ð» Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð½Ð° Ð´Ð²Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:
1. **Ð˜Ð·Ð±ÐµÐ³Ð°Ð½Ð¸Ðµ Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð²** (short-term) â€” ÐºÐ°Ðº Ð½Ðµ Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ð² Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
2. **ÐœÐ°ÑÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð²** (long-term) â€” ÐºÐ°Ðº ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ ÑƒÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾Ð¹ Ðº Ñ…Ð²Ð¾ÑÑ‚Ð°Ð¼

ÐÐ°Ñ‡Ð½Ñ‘Ð¼ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸.

### Ð¢ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð¸Ð·Ð±ÐµÐ³Ð°Ð½Ð¸Ñ Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð²

#### Hedged Requests (Ñ…ÐµÐ´Ð¶Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²)

Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¹ Ð»ÑŽÐ±Ð¸Ð¼Ñ‹Ð¹ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½. Ð˜Ð´ÐµÑ Ð³ÐµÐ½Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ:

1. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ #1
2. Ð–Ð´Ñ‘Ð¼, ÑÐºÐ°Ð¶ÐµÐ¼, 50 Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´ (ÑÑ‚Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ p95)
3. Ð•ÑÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½ÐµÑ‚ â€” Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ **Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚** Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ #2
4. ÐŸÐ¾Ð±ÐµÐ¶Ð´Ð°ÐµÑ‚ Ñ‚Ð¾Ñ‚, ÐºÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» Ð¿ÐµÑ€Ð²Ñ‹Ð¼
5. Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ SEQUENCE DIAGRAM: hedged requests flow]**

```
Client â†’ Server #1: request (t=0)
  â± wait 50ms...
Client â†’ Server #2: request (t=50ms)
  
Server #2 â†’ Client: response (t=80ms) âœ…
Server #1 â†’ Client: response (t=200ms) âŒ ignored
```

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚?**

Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ñ‡Ð°ÑÑ‚Ð¾ **Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½ Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð¼**. Ð­Ñ‚Ð¾ Ð¿Ð¾Ð¼ÐµÑ…Ð¸:
- GC Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ
- Ð¡ÐµÑ‚ÐµÐ²Ð¾Ð¹ glitch
- Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ·ÐºÐ° CPU

Ð”Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€ ÑÐºÐ¾Ñ€ÐµÐµ Ð²ÑÐµÐ³Ð¾ Ð½Ðµ ÑÑ‚Ñ€Ð°Ð´Ð°ÐµÑ‚ Ð¾Ñ‚ Ñ‚Ð¾Ð¹ Ð¶Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð² Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚.

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Google:**

Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€Ðº: Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ 1000 ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð¸Ð· BigTable (100 ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²):
- Ð‘ÐµÐ· hedging: p999 = 1800 Ð¼Ñ
- Ð¡ hedging (Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° 10 Ð¼Ñ): p999 = 74 Ð¼Ñ
- Overhead: Ð²ÑÐµÐ³Ð¾ +2% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

**Ð’ 24 Ñ€Ð°Ð·Ð° Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ** Ð¿Ñ€Ð¸ 2% Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸!

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… Ð Ð°Ð´Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ ÑÐ½Ð¸Ð¶Ð°ÐµÑ‚ p99/p999
- âœ… ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ overhead (2-5%)
- âœ… ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
- âœ… ÐÐµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² ÑÐµÑ€Ð²Ð¸ÑÐ°Ñ…

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¾Ð±Ñ‰ÑƒÑŽ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ
- âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ idempotency Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð¾ Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÐ¼Ð¸, Ð¸Ð¼ÐµÑŽÑ‰Ð¸Ð¼Ð¸ side effects (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´ÐµÐ½ÐµÐ³)
- âŒ ÐÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸

**ÐšÐ°Ðº Ð²Ð½ÐµÐ´Ñ€ÑÑ‚ÑŒ:**

1. ÐœÐ°Ñ€ÐºÐ¸Ñ€ÑƒÐ¹Ñ‚Ðµ hedged Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ ÐºÐ°Ðº **Ð½Ð¸Ð·ÐºÐ¾Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ðµ**
2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ p95-p97
3. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€ÑŒÑ‚Ðµ cancellation rate
4. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ read Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ð¸Ð»Ð¸ ÑÑ‚Ñ€Ð¾Ð³Ð¾ idempotent writes

**Ð’Ð°Ð¶Ð½Ð¾:** Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð¼ÐµÑ‡ÐµÐ½ ÐºÐ°Ðº Ð¼ÐµÐ½ÐµÐµ Ð²Ð°Ð¶Ð½Ñ‹Ð¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð° Ð¿Ð¸ÐºÐ°Ñ….

#### Tied Requests (ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹)

Ð­Ñ‚Ð¾ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ð¸Ð´ÐµÐ¸ hedging Ð´Ð»Ñ ÐµÑ‰Ñ‘ Ð±Ð¾Ð»ÐµÐµ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ñ… ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÐµÐ².

**ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:**

1. ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð´Ð²Ð° ÑÐµÑ€Ð²ÐµÑ€Ð° **Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾** (Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ 1-2 Ð¼Ñ)
2. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ID Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð° ("ÑÐ²ÑÐ·Ð°Ð½Ð½Ð¾Ð³Ð¾")
3. ÐšÐ¾Ð³Ð´Ð° Ð¾Ð´Ð¸Ð½ ÑÐµÑ€Ð²ÐµÑ€ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ â†’ ÑˆÐ»Ñ‘Ñ‚ **cancellation** Ð²Ñ‚Ð¾Ñ€Ð¾Ð¼Ñƒ
4. Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð»Ð¸Ð±Ð¾ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ, Ð»Ð¸Ð±Ð¾ Ð´ÐµÐ¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ ÐµÐ³Ð¾

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ DIAGRAM: tied requests Ñ cross-server communication]**

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° 1-2 Ð¼Ñ?**

Ð•ÑÐ»Ð¸ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ Ð¾Ð±Ð¾Ð¸Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð² Ð¿ÑƒÑÑ‚Ñ‹, Ð¾Ð±Ð° Ð¼Ð¾Ð³ÑƒÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾. Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð² 2x ÑÑ€ÐµÐ´Ð½ÑŽÑŽ network latency (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ 0.5-1 Ð¼Ñ) Ð´Ð°Ñ‘Ñ‚ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° cancellation message.

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… Ð•Ñ‰Ñ‘ Ð»ÑƒÑ‡ÑˆÐµ Ñ‡ÐµÐ¼ hedging Ð´Ð»Ñ Ð¾Ñ‡ÐµÐ½ÑŒ Ð³Ð¾Ñ€ÑÑ‡Ð¸Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð° Ð»Ð¸ÑˆÐ½ÐµÐ¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
- âœ… ÐœÐ¸Ð½Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¸Ð»Ð¸Ð¹

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð¡Ð»Ð¾Ð¶Ð½ÐµÐµ Ð² Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð½ÑƒÐ¶Ð½Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼Ð¸)
- âŒ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ network overhead Ð½Ð° cancellation
- âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð°

**ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:**

Tied requests Ð»ÑƒÑ‡ÑˆÐµ hedging, ÐºÐ¾Ð³Ð´Ð°:
- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð¿Ñ€ÐµÐ´ÐµÐ»Ðµ capacity
- ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð° ÐºÐ°Ð¶Ð´Ð°Ñ Ð»Ð¸ÑˆÐ½ÑÑ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
- ÐœÐ¾Ð¶ÐµÑ‚Ðµ ÑÐµÐ±Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÑÐµÑ€Ð²ÐµÑ€Ð°Ñ…

#### Request Coalescing (Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²)

Ð”Ñ€ÑƒÐ³Ð¾Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ â€” Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸ÐµÑÑ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹.

**Ð˜Ð´ÐµÑ:**

1. ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡
2. Gateway Ð²Ð¸Ð´Ð¸Ñ‚: ÑÑ‚Ð¾Ñ‚ ÐºÐ»ÑŽÑ‡ ÑƒÐ¶Ðµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ÑÑ
3. ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ **Ð½Ðµ ÑƒÑ…Ð¾Ð´Ð¸Ñ‚** Ð² backend
4. Ð’Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
5. ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð²ÐµÑ€Ð½Ñ‘Ñ‚ÑÑ â€” Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ **Ð²ÑÐµ** Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ðµ

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… Ð¡Ð½Ð¸Ð¶Ð°ÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð° hot keys Ð² Ñ€Ð°Ð·Ñ‹
- âœ… ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ gateway/proxy)
- âœ… Ð­Ñ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ Ð´Ð»Ñ read-heavy Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº
- âœ… Ð—Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑ‚ backend Ð¾Ñ‚ thundering herd

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ ÐÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð»Ñ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- âŒ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ latency Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð¿Ñ€Ð¸ÑˆÐµÐ´ÑˆÐ¸Ñ… Ð¿ÐµÑ€Ð²Ñ‹Ð¼Ð¸ Ð² batch
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ñ TTL Ð¸ cache invalidation
- âŒ ÐÑƒÐ¶Ð½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ "Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ñ…" Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

**Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€:**

Ð’Ñ‹ ÐºÑÑˆÐ¸Ñ€ÑƒÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ. ÐšÑÑˆ Ð¿Ñ€Ð¾Ñ‚ÑƒÑ…. ÐŸÑ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð·Ð° ÑÑ‚Ð¸Ð¼ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼:

Ð‘ÐµÐ· coalescing:
- 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð±Ð°Ð·Ñƒ
- Ð‘Ð°Ð·Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ Ð²Ñ‹Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ
- Latency Ñ€Ð°ÑÑ‚Ñ‘Ñ‚

Ð¡ coalescing:
- 1 Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð±Ð°Ð·Ñƒ
- 99 Ð¶Ð´ÑƒÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
- Ð‘Ð°Ð·Ð° ÑÑ‡Ð°ÑÑ‚Ð»Ð¸Ð²Ð°

**Ð“Ð´Ðµ Ð²Ð½ÐµÐ´Ñ€ÑÑ‚ÑŒ:**

- API Gateway (Kong, Envoy)
- Application-level proxy
- Ð’ ÑÐ°Ð¼Ð¾Ð¼ ÑÐµÑ€Ð²Ð¸ÑÐµ Ð´Ð»Ñ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ñ… Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð²

### Ð¢ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð¼Ð°ÑÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð²

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¾ Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸ â€” ÐºÐ°Ðº ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ ÑƒÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾Ð¹.

#### Latency-Aware Load Balancing

ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° round-robin Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²ÐºÐ¸: Ð¾Ð½Ð° Ñ‡ÐµÑÑ‚Ð½Ð¾ Ñ€Ð°Ð·Ð´Ð°Ñ‘Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð´Ð¸Ð½ instance ÑÐ²Ð½Ð¾ Ñ‚Ð¾Ñ€Ð¼Ð¾Ð·Ð¸Ñ‚.

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**

1. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¼ latency ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ instance (ÑÐºÐ¾Ð»ÑŒÐ·ÑÑ‰ÐµÐµ Ð¾ÐºÐ½Ð¾)
2. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ health score Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ latency
3. Ð˜ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ðµ instances Ð¸Ð· Ð¿ÑƒÐ»Ð°
4. ÐŸÐ¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ (Ñ exponential backoff)

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð°:**

```
score = 1.0
if p99 > threshold:
    score *= 0.5
if error_rate > 1%:
    score *= 0.5
if score < 0.1:
    exclude from pool for 10s
```

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ DIAGRAM: health score calculation]**

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð°Ð´Ð°Ð¿Ñ‚Ð°Ñ†Ð¸Ñ Ðº Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ð¼
- âœ… Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ Ð»ÑŽÐ±Ñ‹Ð¼ Ñ‚Ð¸Ð¿Ð¾Ð¼ ÑÐµÑ€Ð²Ð¸ÑÐ°
- âœ… Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ Ð¾Ð±Ñ‰ÑƒÑŽ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
- âœ… Ð”Ð°Ñ‘Ñ‚ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ð¼ instances Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
- âŒ ÐœÐ¾Ð¶ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ hot spots Ð½Ð° "Ð·Ð´Ð¾Ñ€Ð¾Ð²Ñ‹Ñ…" ÑÐµÑ€Ð²ÐµÑ€Ð°Ñ…
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²
- âŒ Ð Ð¸ÑÐº false positives (Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ð»Ð¸ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€)

**Best practices:**

1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼ÐµÑ‚Ñ€Ð¸Ðº (latency + error rate + active connections)
2. Exponential backoff Ð´Ð»Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°
3. ÐŸÐ»Ð°Ð²Ð½Ð¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð²ÐµÑÐ¾Ð² (Ð½Ðµ Ñ€ÐµÐ·ÐºÐ¾Ðµ on/off)
4. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²ÐºÐ¸ ÑÐ°Ð¼Ð¾Ð¹ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²ÐºÐ¸

#### Deadline Propagation (Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¾Ð²)

Ð­Ñ‚Ð¾ about ÑƒÐ¼Ð½Ñ‹Ñ… timeout'Ð¾Ð².

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:**

Service A Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ B Ñ timeout 1s. B Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ C Ñ timeout 1s. C Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ D Ñ timeout 1s.

Ð•ÑÐ»Ð¸ A ÑƒÐ¶Ðµ Ð¿Ð¾Ñ‚Ñ€Ð°Ñ‚Ð¸Ð» 900 Ð¼Ñ:
- B Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ 100 Ð¼Ñ Ð´Ð¾ timeout
- ÐÐ¾ B Ð½Ðµ Ð·Ð½Ð°ÐµÑ‚ Ð¾Ð± ÑÑ‚Ð¾Ð¼
- B Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ C Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ timeout 1s
- C Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ, Ñ…Ð¾Ñ‚Ñ A ÑƒÐ¶Ðµ ÑÐ´Ð°Ð»ÑÑ

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**

ÐŸÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ **time budget** (Ð¾ÑÑ‚Ð°Ð²ÑˆÐµÐµÑÑ Ð²Ñ€ÐµÐ¼Ñ) Ð¿Ð¾ Ð²ÑÐµÐ¹ Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÐµ:

```
A â†’ B: deadline = now() + 1s
B â†’ C: deadline = (received deadline - elapsed time)
C â†’ D: deadline = (received deadline - elapsed time)
```

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ Ð·Ð½Ð°ÐµÑ‚, ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ **Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾** Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ.

**Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ñ deadline:**

1. Ð•ÑÐ»Ð¸ deadline Ð¸ÑÑ‚Ñ‘Ðº â†’ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ abort, Ð½Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ
2. Ð•ÑÐ»Ð¸ Ð±Ð»Ð¸Ð·ÐºÐ¾ Ðº Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸ÑŽ â†’ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð±Ð¾Ð»ÐµÐµ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ (Ð½Ð¾ Ð¼ÐµÐ½ÐµÐµ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹) Ð¼ÐµÑ‚Ð¾Ð´
3. ÐŸÐµÑ€ÐµÐ´Ð°Ñ‘Ð¼ Ð² backend Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ Ð¾ÑÑ‚Ð°Ð²ÑˆÐµÐ³Ð¾ÑÑ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‚ Ñ€ÐµÑÑƒÑ€ÑÑ‹ Ð½Ð° Ð±ÐµÐ·Ð½Ð°Ð´Ñ‘Ð¶Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ñ…
- âœ… Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ graceful degradation
- âœ… ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ñ debugging (Ð²Ð¸Ð´Ð½Ð¾, Ð³Ð´Ðµ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ»Ð¾ÑÑŒ Ð²Ñ€ÐµÐ¼Ñ)
- âœ… ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð±ÐµÑÐ¿Ð¾Ð»ÐµÐ·Ð½ÑƒÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð²Ð¾ **Ð²ÑÐµÑ…** ÑÐµÑ€Ð²Ð¸ÑÐ°Ñ…
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ legacy ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ð¼Ð¸
- âŒ ÐÑƒÐ¶Ð½Ð° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (NTP)
- âŒ Overhead Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ñƒ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ deadline

**Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ:**

Ð’ HTTP: custom header `X-Deadline` Ð¸Ð»Ð¸ `Timeout` header
Ð’ gRPC: Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· context deadline
Ð’ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑÑ…: TTL Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ…

#### Priority Queues (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ðµ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸)

ÐÐµ Ð²ÑÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ð¾ Ð²Ð°Ð¶Ð½Ñ‹.

**Ð˜Ð´ÐµÑ:**

1. Ð Ð°Ð·Ð´ÐµÐ»ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñƒ (high/medium/low)
2. Critical path Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚
3. Background tasks â€” Ð½Ð¸Ð·ÐºÐ¸Ð¹
4. ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð°Ð¶Ð½Ð¾Ðµ

**ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð¾Ð²:**

**High:**
- User-facing Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (checkout, Ð»Ð¾Ð³Ð¸Ð½)
- Real-time Ð´Ð°Ð½Ð½Ñ‹Ðµ
- Health checks

**Medium:**
- Analytics
- ÐÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ API calls

**Low:**
- Batch processing
- ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹
- Prefetching

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… Ð—Ð°Ñ‰Ð¸Ñ‚Ð° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
- âœ… ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð¸Ñ€ÑƒÐµÐ¼Ð°Ñ Ð´ÐµÐ³Ñ€Ð°Ð´Ð°Ñ†Ð¸Ñ (low priority Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¶Ð´Ñ‘Ñ‚ Ð´Ð¾Ð»ÑŒÑˆÐµ)
- âœ… Ð“Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹
- âœ… Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ UX Ð² Ð¿Ð¸ÐºÐ¾Ð²Ñ‹Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð Ð¸ÑÐº starvation Ð½Ð¸Ð·ÐºÐ¾Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð¾Ð²
- âŒ ÐœÐ¾Ð¶ÐµÑ‚ Ð¼Ð°ÑÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ capacity
- âŒ ÐÑƒÐ¶Ð½Ñ‹ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ñ‹ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð² starvation

**Ð’Ð°Ð¶Ð½Ð¾:**

ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ:
- Aging (Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð° Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡)
- Min throughput Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð´Ð»Ñ low priority
- ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ queue depths Ð¿Ð¾ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð°Ð¼

#### Circuit Breaker

ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ cascading failures.

**ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:**

Circuit Breaker Ð¸Ð¼ÐµÐµÑ‚ 3 ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ:

**Closed (Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°):**
- Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚
- Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸

**Open (ÑÐ»Ð¾Ð¼Ð°Ð½Ð¾):**
- Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ **Ð½Ðµ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚**
- Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾ (fail fast)
- Ð”Ð°Ñ‘Ð¼ ÑÐµÑ€Ð²Ð¸ÑÑƒ Ð²Ñ€ÐµÐ¼Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ

**Half-Open (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°):**
- ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
- Ð•ÑÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹ â†’ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Closed
- Ð•ÑÐ»Ð¸ fail â†’ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² Open

**[ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ•Ðœ STATE DIAGRAM: circuit breaker states]**

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:**

- Failure threshold: ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð² Open
- Timeout: ÐºÐ°Ðº Ð´Ð¾Ð»Ð³Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð°Ñ‚ÑŒÑÑ Ð² Open
- Success threshold: ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑƒÑÐ¿ÐµÑ…Ð¾Ð² Ð´Ð»Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð² Closed

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ°ÑÐºÐ°Ð´Ð½Ñ‹Ðµ Ð¾Ñ‚ÐºÐ°Ð·Ñ‹
- âœ… Ð”Ð°Ñ‘Ñ‚ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ð¾Ð¼Ñƒ ÑÐµÑ€Ð²Ð¸ÑÑƒ Ð½Ð° recovery
- âœ… Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ user experience (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ fail Ð»ÑƒÑ‡ÑˆÐµ Ð´Ð¾Ð»Ð³Ð¾Ð³Ð¾ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°)
- âœ… Ð¡Ð½Ð¸Ð¶Ð°ÐµÑ‚ Ð±ÐµÑÐ¿Ð¾Ð»ÐµÐ·Ð½ÑƒÑŽ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ fallback Ð»Ð¾Ð³Ð¸ÐºÐ¸ (Ñ‡Ñ‚Ð¾ Ð¾Ñ‚Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ Open?)
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²
- âŒ ÐœÐ¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¼ (Ð»Ð¾Ð¶Ð½Ñ‹Ðµ ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ)
- âŒ ÐÑƒÐ¶ÐµÐ½ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ breaker'Ð¾Ð²

**Best practices:**

1. ÐžÐ´Ð¸Ð½ circuit breaker Ð½Ð° dependency (Ð½Ðµ Ð¾Ð±Ñ‰Ð¸Ð¹)
2. Ð­ÐºÑÐ¿Ð¾Ð½ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ backoff Ð´Ð»Ñ reopening
3. ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸: % Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Open, latency Ð´Ð¾ trip
4. ÐÐ»ÐµÑ€Ñ‚Ñ‹ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°Ñ… Open/Closed

**Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸:**

- Netflix Hystrix (deprecated, Ð½Ð¾ Ð¸Ð´ÐµÐ¸ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹)
- Resilience4j (Java)
- Polly (.NET)
- PyBreaker (Python)

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹.

#### Local Caching (L1/L2)

Ð›ÑƒÑ‡ÑˆÐ¸Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ tail latency â€” Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½Ðµ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ.

**L1 ÐºÑÑˆ:**
- In-process memory (HashMap, LRU cache)
- Latency ~1 Ð¼ÐºÑ
- ÐÐµÑ‚ ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð²

**L2 ÐºÑÑˆ:**
- Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Redis/Memcached Ð½Ð° Ñ‚Ð¾Ð¼ Ð¶Ðµ Ñ…Ð¾ÑÑ‚Ðµ
- Latency ~1 Ð¼Ñ
- Ð˜Ð·Ð±ÐµÐ³Ð°ÐµÑ‚ network hop

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ latency
- âœ… Ð¡Ð½Ð¸Ð¶Ð°ÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð° backend
- âœ… ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
- âœ… Ð—Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚ network issues

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Consistency Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ (stale data)
- âŒ Memory overhead (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ instance Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ ÐºÐ¾Ð¿Ð¸ÑŽ)
- âŒ Cache invalidation â€” ÑÐ»Ð¾Ð¶Ð½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°
- âŒ Cold start Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°

**ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:**

- Reference data (ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸, ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¸)
- Frequently accessed data Ñ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ð¼ staleness
- ÐÐµÐ¸Ð·Ð¼ÐµÐ½ÑÐµÐ¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

**ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½: write-through + TTL:**

```
write:
  update DB
  invalidate local cache
  
read:
  check L1 (in-memory)
  if miss â†’ check L2 (local Redis)
  if miss â†’ check remote cache/DB
  populate caches with TTL
```

#### Micro-Sharding

Ð’Ð¼ÐµÑÑ‚Ð¾ ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ñ… shards Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ»ÐºÐ¸Ñ….

**Ð¢Ñ€Ð°Ð´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ sharding:**
- 10 shards
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ shard = 10% Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð•ÑÐ»Ð¸ Ð¾Ð´Ð¸Ð½ shard Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ â†’ 10% Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ÑÑ‚Ñ€Ð°Ð´Ð°ÑŽÑ‚

**Micro-sharding:**
- 1000 micro-shards
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ shard = 0.1% Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐœÐ¾Ð¶ÐµÐ¼ Ð³Ð¸Ð±ÐºÐ¾ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ

**ÐŸÐ»ÑŽÑÑ‹:**
- âœ… ÐžÐ´Ð¸Ð½ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¹ shard Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ð¼ÐµÐ½ÑŒÑˆÐµÐµ Ñ‡Ð¸ÑÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- âœ… Ð“Ð¸Ð±ÐºÐ°Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²ÐºÐ° (Ð¼Ð¾Ð¶ÐµÐ¼ split Ð³Ð¾Ñ€ÑÑ‡Ð¸Ðµ shards)
- âœ… Ð›ÑƒÑ‡ÑˆÐ°Ñ Ð¸Ð·Ð¾Ð»ÑÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
- âœ… Ð›ÐµÐ³Ñ‡Ðµ rebalancing

**ÐœÐ¸Ð½ÑƒÑÑ‹:**
- âŒ Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ (Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‚Ð¾Ñ‡ÐµÐº Ð¾Ñ‚ÐºÐ°Ð·Ð°)
- âŒ Overhead Ð½Ð° coordination
- âŒ Ð‘Ð¾Ð»ÑŒÑˆÐµ connections, Ð±Ð¾Ð»ÑŒÑˆÐµ metadata
- âŒ Ð¡Ð»Ð¾Ð¶Ð½ÐµÐµ monitoring

**ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:**

- Google Spanner: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ split Ð³Ð¾Ñ€ÑÑ‡Ð¸Ñ… shards
- Cassandra: virtual nodes
- MongoDB: chunk splitting

#### Queue-Based Load Leveling

ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ÑÑ‚ÑŒ ÐºÐ°Ðº Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ spikes.

**ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½:**

```
Client â†’ Queue â†’ Worker Pool â†’ Backend
```

**ÐšÐ°Ðº Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚:**

1. Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð°ÐºÐ°Ð¿Ð»Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
2. Workers Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ Ñ controlled rate
3. Backend Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½ Ð¾Ñ‚ burst'Ð¾Ð²
4. Ð•ÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ backpressure

**ÐŸÐ»ÑŽÑÑ‹:**
-