# –í–í–ï–î–ï–ù–ò–ï (2‚Äì3 –º–∏–Ω—É—Ç—ã)

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é. –í–∞—à —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ, –∫—Ä–∞—Å–∏–≤–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ. –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ, –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–æ–≤–Ω—ã–µ.
–ò –≤–¥—Ä—É–≥ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ—Ä–∞ –≤—ã–±—Ä–æ—Å–∏—Ç—å –≤–∞—Å –∏–∑ –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞.

–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ 999 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏ –∑–∞ 20‚Äì30 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.
–û–¥–∏–Ω ‚Äî –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã.

–ö—Ç–æ-—Ç–æ —Å–∫–∞–∂–µ—Ç: ¬´–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è, —á—Ç–æ —Ç–∞–∫–æ–≥–æ?¬ª
–ù—É –¥–∞, —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç–ª–∏—á–Ω—ã–π. p50 –æ—Ç–ª–∏—á–Ω—ã–π. –ê –≤–æ—Ç **p99** –≤–Ω–µ–∑–∞–ø–Ω–æ –∂–∏–≤—ë—Ç —Å–≤–æ–µ–π —Ç—ë–º–Ω–æ–π –∂–∏–∑–Ω—å—é.

–ò –≤–æ—Ç —ç—Ç–∞ –æ–¥–Ω–∞ —Å–µ–∫—É–Ω–¥–∞ ‚Äî —ç—Ç–æ –Ω–µ –±–∞–≥. –≠—Ç–æ –Ω–µ ‚Äú—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π‚Äù.
–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º.

–ß–µ–º –±–æ–ª—å—à–µ —Å–∏—Å—Ç–µ–º–∞, —Ç–µ–º –¥–ª–∏–Ω–Ω–µ–µ —Ö–≤–æ—Å—Ç.
–ò —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–±–ª–µ–º –æ–Ω –ø—Ä–∏–Ω–æ—Å–∏—Ç:

* –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã
* —Ç–∞–π–º–∞—É—Ç—ã
* –ª–∞–≤–∏–Ω—ã —Ä–µ—Ç—Ä–∞–µ–≤
* –≤–Ω–µ–∑–∞–ø–Ω—ã–µ –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
* —Ü–µ–ø–æ—á–∫–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–π –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö

–ú—ã —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ–º **tail latency** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –∫—Ä–∞—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.

–ß—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ä–º–∏–Ω—ã ‚Äî –≤–æ—Ç –ø—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫:

```mermaid
graph LR
A[p50<br/>–ù–æ—Ä–º–∞–ª—å–Ω–∞—è, –æ–∂–∏–¥–∞–µ–º–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å]:::normal --> B[p95<br/>—Ä–µ–¥–∫–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã]:::warn --> C[p99<br/>—Ö–≤–æ—Å—Ç —Å–∏—Å—Ç–µ–º—ã]:::bad --> D[p99.9<br/>–∞–¥—Å–∫–∞—è –∑–æ–Ω–∞]:::hell
classDef normal fill:#b5e8b0,stroke:#333,stroke-width:1px;
classDef warn fill:#fff3a2,stroke:#333,stroke-width:1px;
classDef bad fill:#f5c3c3,stroke:#333,stroke-width:1px;
classDef hell fill:#ff8b8b,stroke:#333,stroke-width:1px;
```

–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–¥–µ—Å—å –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç.
–û–¥–Ω–∞ –ø–∞—É–∑–∞ –Ω–∞ —Å–µ–∫—É–Ω–¥—É ¬´—Å—ä–µ–¥–∞–µ—Ç¬ª —Ç—ã—Å—è—á–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.

–í —ç—Ç–æ–º –≤–∏–¥–µ–æ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º –Ω–µ —Ç–µ–æ—Ä–∏—é, –∞ –Ω–∞—Å—Ç–æ—è—â—É—é –ø—Ä–∞–∫—Ç–∏–∫—É ‚Äî
–æ—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è —Ö–≤–æ—Å—Ç, –ø–æ—á–µ–º—É –æ–Ω —Ä–∞—Å—Ç—ë—Ç, –∏ —á—Ç–æ —Å —ç—Ç–∏–º —Ä–µ–∞–ª—å–Ω–æ –¥–µ–ª–∞—é—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---

## üìä –ë–õ–û–ö 1: –ü–†–û–ë–õ–ï–ú–ê (10‚Äì12 –º–∏–Ω—É—Ç)

---

## 1.1 –ß—Ç–æ —Ç–∞–∫–æ–µ tail latency —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏

Tail latency ‚Äî —ç—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã **–Ω–∞ –∫—Ä–∞—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫**.
–≠—Ç–æ –Ω–µ ¬´–º–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å¬ª. –≠—Ç–æ —Ü–µ–ª–∞—è –∑–æ–Ω–∞ –∞–¥—Å–∫–æ–π –∂–∏–∑–Ω–∏.

–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

* **p95** ‚Äî 5% —Å–∞–º—ã—Ö –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* **p99** ‚Äî 1% –º–µ–¥–ª–µ–Ω–Ω–µ–π—à–∏—Ö
* **p999** ‚Äî 0.1% –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ã—á–Ω–æ –ª–æ–º–∞—é—Ç –≤–µ—Å—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω

–ü–æ—á–µ–º—É —Å—Ä–µ–¥–Ω–µ–µ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ:

* –ï—Å–ª–∏ 999 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω–∏–ª–∏—Å—å –∑–∞ 20ms
* –ò 1 –∑–∞–ø—Ä–æ—Å ‚Äî –∑–∞ 2000ms
* –°—Ä–µ–¥–Ω–µ–µ ‚âà **18ms**

–ü–æ —Å—Ä–µ–¥–Ω–µ–º—É –≤—ã –≤—ã–≥–ª—è–¥–∏—Ç–µ –∫–∞–∫ –±–æ–≥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏,
–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∫–∞–∫ –∞–ª—å—Ñ–∞-—Ç–µ—Å—Ç–µ—Ä.

---

### 1.2 The Tail at Scale (—Ö–≤–æ—Å—Ç —Ä–∞—Å—Ç—ë—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ)

–≠—Ç–æ —Ç–∞ —á–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ**, –∏–Ω–∞—á–µ –ª—é–¥–∏ –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞—é—Ç.

–ï—Å–ª–∏ —É –≤–∞—Å:

* API Gateway
* Service A
* Service B
* Database
* Redis
* gRPC external

–ò –≤ –∫–∞–∂–¥–æ–º p99 = 200ms, —Ç–æ:

```
–æ–±—â–∏–π p99 = 200ms ^ N
```

N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ.

–ù–µ –±—É–∫–≤–∞–ª—å–Ω–æ –≤ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–º—ã—Å–ª–µ, –Ω–æ **—ç—Ñ—Ñ–µ–∫—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ç—ã** —Ä–µ–∞–ª—å–Ω—ã–π.

–í–æ—Ç –¥–∏–∞–≥—Ä–∞–º–º–∞:

```mermaid
sequenceDiagram
participant Client
participant API
participant ServiceA
participant ServiceB
participant DB

Client->>API: –ó–∞–ø—Ä–æ—Å
API->>ServiceA: –∑–∞–ø—Ä–æ—Å
ServiceA->>ServiceB: –∑–∞–ø—Ä–æ—Å
ServiceB->>DB: SELECT
DB-->>ServiceB: –æ—Ç–≤–µ—Ç (p99 = 200ms)
ServiceB-->>ServiceA: –æ—Ç–≤–µ—Ç (+ 200ms)
ServiceA-->>API: –æ—Ç–≤–µ—Ç (+ 200ms)
API-->>Client: –∏—Ç–æ–≥ (+ 200ms)
```

–ö–∞–∂–¥—ã–π ‚Äú–ø–æ—á—Ç–∏ –±—ã—Å—Ç—Ä—ã–π‚Äù —Å–µ—Ä–≤–∏—Å –¥–æ–±–∞–≤–ª—è–µ—Ç –∫ —Ö–≤–æ—Å—Ç—É.
–ò –≤ –∏—Ç–æ–≥–µ p99 –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥—ã, –∞ —Ç–æ –∏ –º–∏–Ω—É—Ç—ã.

---

## 1.3 –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è —Ö–≤–æ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã)

### –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ

* GC —Å—Ç–æ–ø—ã (–≤ JVM/Go)
* CPU preemption
* I/O spikes (¬´–¥–∏—Å–∫ –≤–Ω–µ–∑–∞–ø–Ω–æ —Ä–µ—à–∏–ª –ø–æ–¥—É–º–∞—Ç—å¬ª)
* Memory paging
* NUMA –ø–µ—Ä–µ–∫–æ—Å—ã

–ï—Å–ª–∏ —Ç—ã –Ω–∞ –æ–±–ª–∞–∫–µ, —Ö–≤–æ—Å—Ç ‚Äî —ç—Ç–æ –Ω–µ –±–∞–≥, —ç—Ç–æ –ø–ª–∞–Ω:

> ‚Äú–°–æ—Å–µ–¥ –∂—Ä—ë—Ç CPU ‚Üí —Ç–≤–æ–π pod —Ç–æ—Ä–º–æ–∑–∏—Ç‚Äù.

### –°–µ—Ç–µ–≤—ã–µ

* –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞
* packet loss ‚Üí TCP retransmit
* –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è —Ç–æ–ø–æ–ª–æ–≥–∏—è –≤ DC (east-west/cross-rack)

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ

* –≥–æ—Ä—è—á–∏–µ –∫–ª—é—á–∏ –≤ Redis
* –≥–ª–æ–±–∞–ª—å–Ω—ã–µ lock-–∏
* –±–æ–ª—å—à–∏–µ JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
* —Ç—è–∂–µ–ª—ã–µ shard'—ã

–°–∏–º–ø–∞—Ç–∏—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ‚Äú–æ—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞‚Äù:

```mermaid
graph TD
A[–ó–∞–ø—Ä–æ—Å] --> B[–ö–æ–¥]
B --> C[Lock-–∏ / —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è]
C --> D[–°–µ—Ç—å]
D --> E[–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã]
E --> F[–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö]
```

–õ—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ö–≤–æ—Å—Ç.

---

## 1.4 –ö–∞—Å–∫–∞–¥–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

–í–æ—Ç –≥–¥–µ –Ω–∞—Å—Ç–æ—è—â–∏–π –∞–¥ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è.

### 1) –û—á–µ—Ä–µ–¥–∏ —Ä–∞—Å—Ç—É—Ç ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∏ —Ä–∞—Å—Ç—É—Ç

Little‚Äôs Law:

```
W = L / Œª
```

–ï—Å–ª–∏ —É —Ç–µ–±—è —á—É—Ç—å-—á—É—Ç—å –≤—ã—Ä–æ—Å–ª–æ L (–¥–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏) ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ —É–ª–µ—Ç–∞–µ—Ç.

### 2) –¢–∞–π–º–∞—É—Ç ‚Üí —Ä–µ—Ç—Ä–∞–π ‚Üí –ª–∞–≤–∏–Ω–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç —Ä–µ—Ç—Ä–∞–∏—Ç
–≥–µ–π—Ç–≤–µ–π —Ä–µ—Ç—Ä–∞–∏—Ç
PHP —Ä–µ—Ç—Ä–∞–∏—Ç
–≤—Å—ë —Ä–µ—Ç—Ä–∞–∏—Ç

–ò –æ–¥–∏–Ω —Ö–≤–æ—Å—Ç–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤:

> RETRY STORM

### 3) Cache-miss avalanche

–µ—Å–ª–∏ –∫–ª—é—á –≥–æ—Ä—è—á–∏–π ‚Üí TTL –∏—Å—Ç—ë–∫ ‚Üí 5000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–¥—É—Ç –≤ –±–∞–∑—É ‚Üí –±–∞–∑–∞ —É–º–∏—Ä–∞–µ—Ç ‚Üí API —É–º–∏—Ä–∞–µ—Ç ‚Üí Redis —É–º–∏—Ä–∞–µ—Ç ‚Üí –≤—Å—ë

### 4) Load balancer —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–æ–ª—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ

–û–Ω –Ω–µ ‚Äú–ª–µ—á–∏—Ç‚Äù —Ö–≤–æ—Å—Ç—ã ‚Äî –æ–Ω –∏—Ö —Ä–∞–∑–º–∞–∑—ã–≤–∞–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω—Å—Ç–∞–Ω—Å–∞–º,
–¥–µ–ª–∞—è —Ö–≤–æ—Å—Ç **—Å–∏—Å—Ç–µ–º–Ω—ã–º**, –∞ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–º.

–í–æ—Ç –¥–∏–∞–≥—Ä–∞–º–º–∞:

```mermaid
sequenceDiagram
participant Client
participant LB
participant S1
participant S2
participant S3

Client->>LB: –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
LB->>S1: —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—á–µ—Ä–µ–¥—å ‚Üë)
LB->>S2: —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—á–µ—Ä–µ–¥—å ‚Üë)
LB->>S3: —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—á–µ—Ä–µ–¥—å ‚Üë)

Note over S1,S3: –û–¥–∏–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å ‚Üí –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä —Ç–æ—Ä–º–æ–∑–∏—Ç
```

---

# üõ† –ë–õ–û–ö 2: –†–ï–®–ï–ù–ò–Ø TAIL LATENCY (15‚Äì18 –º–∏–Ω—É—Ç)

> –ü—Ä–µ–∂–¥–µ —á–µ–º –±–µ–∂–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –Ω–∞–¥–æ –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–æ—Å—Ç—É—é –º—ã—Å–ª—å:
> **–•–≤–æ—Å—Ç—ã –Ω–µ–∏–∑–±–µ–∂–Ω—ã.**
> –£–º–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ ‚Äú–∏—Å–∫–æ—Ä–µ–Ω—è—é—Ç‚Äù tail latency, –æ–Ω–∏ **–∂–∏–≤—É—Ç —Å –Ω–∏–º**.

–ï—Å—Ç—å –¥–≤–∞ —Ç–∏–ø–∞ —Ç–µ—Ö–Ω–∏–∫:

1. **–£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ö–≤–æ—Å—Ç–∞** ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã–ª–æ –º–µ–Ω—å—à–µ
2. **–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞/–æ–±—Ö–æ–¥ —Ö–≤–æ—Å—Ç–∞** ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ª–æ–º–∞–ª–∏ –≤—Å—ë –ø–æ–¥—Ä—è–¥

Google –ø—Ä—è–º–æ —Ç–∞–∫ –¥–µ–ª–∏—Ç –ø–æ–¥—Ö–æ–¥—ã: short-term –∏ long-term.

---

# üîπ 2.1. SHORT-TERM: —Ç–µ—Ö–Ω–∏–∫–∏ —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ö–≤–æ—Å—Ç–∞

–≠—Ç–æ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å **–±—ã—Å—Ç—Ä–æ**, –∏ –æ–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å—Ä–∞–∑—É —Å–Ω–∏–∂–∞—Ç—å p99/p999.

---

## ‚úî Hedged Requests

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ Google –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–∏—Å–µ.
–î–∞, –≤ PHP –æ–Ω–æ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å–ª–∏ —Ç—ã –Ω–µ –∂–∏–≤—ë—à—å –≤ –º–∏—Ä–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∞–¥—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–æ —É —Ç–µ–±—è –µ—Å—Ç—å –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ async-–≤–æ—Ä–∫–µ—Ä—ã).

### –°—É—Ç—å

–û—Ç–ø—Ä–∞–≤–ª—è–µ–º **–≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å** —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É, —Ä–∞–≤–Ω—É—é p95.
–ü–µ—Ä–≤—ã–π, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç ‚Äî –≤—ã–∏–≥—Ä–∞–ª.

–í–æ—Ç –ø—Ä–∏–º–µ—Ä:

```mermaid
sequenceDiagram
participant Client
participant ServerA
participant ServerB

Client->>ServerA: –ó–∞–ø—Ä–æ—Å
Client-->>Client: –ñ–¥—ë–º p95 (–Ω–∞–ø—Ä–∏–º–µ—Ä 80ms)
Client->>ServerB: –î—É–±–ª–∏–∫–∞—Ç –∑–∞–ø—Ä–æ—Å–∞

ServerB-->>Client: –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç (90ms)
Client-->>ServerA: –û—Ç–º–µ–Ω–∞ –∏–ª–∏ –∏–≥–Ω–æ—Ä
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–ü–æ—Ç–æ–º—É —á—Ç–æ ‚Äú—Ö–≤–æ—Å—Ç–æ–≤–æ–π‚Äù —Å–µ—Ä–≤–µ—Ä ‚Äî —ç—Ç–æ **—Ä–µ–¥–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**.
–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞—ë—Ç —à–∞–Ω—Å –ø–æ–ø–∞—Å—Ç—å –Ω–∞ –±—ã—Å—Ç—Ä—ã–π –∏–Ω—Å—Ç–∞–Ω—Å.

### –ü–ª—é—Å—ã

* p99 –ø–∞–¥–∞–µ—Ç –≤ **—Ä–∞–∑—ã**
* p999 –ø–∞–¥–∞–µ—Ç –≤ **–¥–µ—Å—è—Ç–∫–∏ —Ä–∞–∑**
* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ 2‚Äì5%
* –ø–æ—á—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ú–∏–Ω—É—Å—ã

* –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å *idempotent*
* –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å —Ç–∞–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–±–æ—á–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
* PHP-–∫–æ–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π PHP –ø—Ä–∏–º–µ—Ä (Symfony + HTTP Client)

```php
public function hedgedRequest(HttpClientInterface $http, string $url)
{
    $primary = $http->request('GET', $url);

    // –ñ–¥–µ–º p95 ‚Äì –Ω–∞–ø—Ä–∏–º–µ—Ä 80 –º—Å
    usleep(80_000);

    $secondary = $http->request('GET', $url);

    // –ü–µ—Ä–≤—ã–º –ø—Ä–∏—à—ë–ª ‚Äî –ø–æ–±–µ–¥–∏–ª
    $responses = [$primary, $secondary];

    foreach ($responses as $res) {
        try {
            return $res->getContent();
        } catch (\Throwable $e) {
            // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        }
    }

    throw new \RuntimeException('Both hedged requests failed');
}
```

–ü–æ–Ω—è—Ç–Ω–æ, –¥–∞?
–ù–∏—á–µ–≥–æ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞.

---

# ‚úî Tied Requests (–°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

–≠—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–∞ –Ω–∞–¥ hedging.
–¢–µ—Ö–Ω–∏–∫–∞ –º–æ—â–Ω–∞—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–æ–≤.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä **A**
2. –ß–µ—Ä–µ–∑ ~2 RTT (–æ–±—ã—á–Ω–æ ‚â§1ms –≤ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–µ) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ø–∏—é –Ω–∞ **B**
3. –°–µ—Ä–≤–µ—Ä **A**, –Ω–∞—á–∞–≤ –æ–±—Ä–∞–±–æ—Ç–∫—É, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ‚Äúcancel‚Äù –Ω–∞ **B**
4. –ï—Å–ª–∏ **B** –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫—É ‚Üí –æ–Ω –æ—Ç–º–µ–Ω—è–µ—Ç
5. –ï—Å–ª–∏ –Ω–∞—á–∞–ª ‚Üí –ø–æ–Ω–∏–∂–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–ª–∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç

### –î–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
sequenceDiagram
participant Client
participant A
participant B

Client->>A: –ó–∞–ø—Ä–æ—Å (id=123)
Client-->>Client: –ó–∞–¥–µ—Ä–∂–∫–∞ 1‚Äì2 RTT
Client->>B: –ó–∞–ø—Ä–æ—Å (id=123, peer=A)

A-->>B: CANCEL 123
B-->>A: CANCELLED
```

### –í —á—ë–º —Å–∏–ª–∞?

* –ø–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ **–æ–±–∞** —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞—á–∏–Ω–∞—é—Ç —Ä–∞–±–æ—Ç—É
* —Ö–≤–æ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –≥–ª—É—à–∞—Ç—Å—è —É–∂–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—á–µ—Ä–µ–¥–µ–π
* –Ω–µ –Ω—É–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ü–ª—é—Å—ã

* –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏, —á–µ–º —É hedging
* –°–∏–ª—å–Ω–µ–µ —É–º–µ–Ω—å—à–∞–µ—Ç p999
* –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö API

### –ú–∏–Ω—É—Å—ã

* —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å—Ç–æ–º PHP
* –Ω—É–∂–Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏
* –Ω—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–∞–Ω–∞–ª

–≠—Ç–æ —É–∂–µ —É—Ä–æ–≤–µ–Ω—å ‚Äú–∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è‚Äù, –Ω–æ –µ—Å–ª–∏ —É —Ç–µ–±—è –±–æ–ª—å—à–∞—è —Å–∏—Å—Ç–µ–º–∞ ‚Äî –º–∞—Å—Ç—Ö–µ–≤.

---

# ‚úî Request Coalescing

–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ, –Ω–æ –≥–µ–Ω–∏–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

### –ü—Ä–æ–±–ª–µ–º–∞

–ï—Å–ª–∏ 5000 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ö–æ—Ç—è—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ ‚Äî
–æ–Ω–∏ –∏–¥—É—Ç —Ç–æ–ª–ø–æ–π –≤–Ω–∏–∑, –≤—ã–∑—ã–≤–∞—è:

* k8s queue spike
* Redis hot key
* DB overload

### –†–µ—à–µ–Ω–∏–µ

–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å ‚Äú–∑–∞–±–∏—Ä–∞–µ—Ç –±–∏–ª–µ—Ç‚Äù –∏ –∏–¥—ë—Ç –≤–Ω–∏–∑.
–û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç –∏ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

### –ü—Ä–∏–º–µ—Ä (Symfony Gateway)

```php
$key = 'coalesce:' . md5($url);

if ($result = $cache->get($key)) {
    return $result;
}

$lock = $lockFactory->createLock($key);

if (!$lock->acquire()) {
    // –ö—Ç–æ-—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–¥–æ–∂–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return $cache->get($key, 2.0);
}

try {
    $response = $http->request('GET', $url)->getContent();
    $cache->set($key, $response, 2);
    return $response;
} finally {
    $lock->release();
}
```

### –ü–ª—é—Å—ã

* —Å–ø–∞—Å–∞–µ—Ç Redis –æ—Ç —Å–º–µ—Ä—Ç–∏ –Ω–∞ hot key
* —É–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î
* —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —è–∑—ã–∫–µ

### –ú–∏–Ω—É—Å—ã

* –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* –¥–æ–±–∞–≤–ª—è–µ—Ç ‚Äú–º–∏–∫—Ä–æ-–∑–∞–¥–µ—Ä–∂–∫—É‚Äù –ø–µ—Ä–≤—ã–º –≤ batch

---

# üîπ 2.2 LONG-TERM: –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –∏ –æ–±—Ö–æ–¥ —Ö–≤–æ—Å—Ç–æ–≤

–≠—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ ‚Äî –Ω–µ ‚Äú—Ñ–∏—á–∏‚Äù, –∞ –ø–æ–¥—Ö–æ–¥—ã.

---

# ‚úî Latency-aware Load Balancing

–û–±—ã—á–Ω—ã–π load balancer:

> —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã ‚Äú—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ‚Äù.

Latency-aware LB:

> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã.

–û–Ω –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Å—ã –ø–æ **health score**:

```mermaid
graph LR
A[Latency] --> S[Health Score]
B[Error Rate] --> S
C[Queue Length] --> S
S --> LB[Routing Decision]
```

–ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ node ‚Äú–±—É–∫—Å—É–µ—Ç‚Äù, LB –µ–≥–æ **–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–∫–ª—é—á–∞–µ—Ç**, –ø–æ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–µ—Ä–µ–∑ exponential backoff.

### –ü–ª—é—Å—ã

* —É–º–µ–Ω—å—à–∞–µ—Ç —Ö–≤–æ—Å—Ç **–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞**
* —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

### –ú–∏–Ω—É—Å—ã

* –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –º–µ—Ç—Ä–∏–∫ (Prometheus + exporters)
* –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å ‚Äú–≥–æ—Ä—è—á–∏–µ —Ç–æ—á–∫–∏‚Äù

---

# ‚úî Deadline Propagation

–ö–æ–≥–¥–∞ —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å ‚Äú—Ç–∞–π–º-–±—é–¥–∂–µ—Ç‚Äù, –Ω–æ –Ω–∏–∫—Ç–æ –≤ —Ü–µ–ø–æ—á–∫–µ –æ –Ω—ë–º –Ω–µ –∑–Ω–∞–µ—Ç ‚Äî
—ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ö–≤–æ—Å—Ç–∞–º.

Deadline propagation ‚Äî —ç—Ç–æ:

* –∫–ª–∏–µ–Ω—Ç ‚Üí API: ‚Äú—É –º–µ–Ω—è 200–º—Å –Ω–∞ –æ—Ç–≤–µ—Ç‚Äù
* API ‚Üí —Å–µ—Ä–≤–∏—Å—ã: ‚Äú—É –º–µ–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å 150–º—Å‚Äù
* —Å–µ—Ä–≤–∏—Å—ã ‚Üí –±–∞–∑–∞: ‚Äú—É –º–µ–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å 100–º—Å‚Äù

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç?

–ï—Å–ª–∏ deadline –≤—ã—à–µ–ª, —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç —Ä–∞–±–æ—Ç—É **—Å—Ä–∞–∑—É**, —ç–∫–æ–Ω–æ–º—è —Ä–µ—Å—É—Ä—Å—ã.

### –ü–ª—é—Å—ã

* –Ω–∏–∫–∞–∫–æ–π –±–µ—Å–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
* –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏
* –º–µ–Ω—å—à–µ cascade failure

---

# ‚úî Priority Queues

–ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –æ–¥–Ω–∞ –¥–ª—è –≤—Å–µ—Ö ‚Äî
—Ö–≤–æ—Å—Ç –æ–¥–Ω–∏–º –º–µ–¥–ª–µ–Ω–Ω—ã–º batch job –ø–æ–ª–æ–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

–†–µ—à–µ–Ω–∏–µ: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º.

### –ü—Ä–∏–º–µ—Ä

* HIGH: checkout, –æ–ø–ª–∞—Ç–∞
* MEDIUM: –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
* LOW: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤

### –ü–ª—é—Å—ã

* –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ –ø—É—Ç–∏
* –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

### –ú–∏–Ω—É—Å—ã

* —Ä–∏—Å–∫ starvation –Ω–∏–∑–∫–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π

---

# ‚úî Circuit Breaker

–¢–∏–ø–∏—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

* –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å —Ç–æ—Ä–º–æ–∑–∏—Ç
* —Ç–≤–æ–π API –≤–∏—Å–∏—Ç
* —Ä–µ—Ç—Ä–∞–∏ —Ä–∞—Å—Ç—É—Ç
* –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä —É–º–∏—Ä–∞–µ—Ç

Circuit breaker –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å–µ—Ä–≤–∏—Å:

```mermaid
stateDiagram
    [*] --> Closed
    Closed --> Open: –û—à–∏–±–æ–∫ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
    Open --> HalfOpen: –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
    HalfOpen --> Closed: –£–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å
    HalfOpen --> Open: –ù–µ —É–¥–∞–ª–æ—Å—å
```

### –ü–ª—é—Å—ã

* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–∞–≤–∏–Ω—ã
* –∑–∞—â–∏—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å

### –ú–∏–Ω—É—Å—ã

* –Ω—É–∂–Ω–∞ fallback-–ª–æ–≥–∏–∫–∞
* —Å–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤

---

# üîπ 2.3 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

---

# ‚úî Local Caching (L1)

–≠—Ç–æ super-fast –∫—ç—à –ø—Ä—è–º–æ –≤ –ø–∞–º—è—Ç–∏ PHP: APCu, shared-memory, preloaded config –∏ —Ç. –¥.

–ü–ª—é—Å—ã: —Å–∫–æ—Ä–æ—Å—Ç—å ‚Üí <1ms
–ú–∏–Ω—É—Å—ã: **invalidation –±–æ–ª—å–Ω–∞—è**, coherence –ª–æ–º–∞–µ—Ç—Å—è.

---

# ‚úî Micro-sharding

–ï—Å–ª–∏ –æ–¥–∏–Ω shard —Ç–æ—Ä–º–æ–∑–∏—Ç ‚Äî –≤—Å—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Ä—è–µ—Ç p99.

Micro-sharding –¥–∞—ë—Ç:

* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ shard'—ã
* –º–∏–≥—Ä–∞—Ü–∏—é –±–µ–∑ –±–æ–ª–∏
* –∏–∑–æ–ª—è—Ü–∏—é hot spots

---

# ‚úî Queue-Based Load Leveling

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç –ø–∏–∫–∏.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:
–≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã 500 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–µ—Ä–≥–∞–ª–∏ ‚Äú—Å–æ–∑–¥–∞—Ç—å PDF‚Äù,
–æ–Ω–∏ –±—Ä–æ—Å–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å, –∞ –≤–æ—Ä–∫–µ—Ä—ã –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –µ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ.

---

# ‚úî Background jittering

–ï—Å–ª–∏ —É —Ç–µ–±—è 100 pod'–æ–≤ –∏ cron –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 00:00:00 —É –≤—Å–µ—Ö ‚Äî
—Ç—ã —Å–∞–º —Å–µ–±–µ —Å–æ–∑–¥–∞—ë—à—å thundering herd.

–†–µ—à–µ–Ω–∏–µ:

* —Ä–∞–∑–Ω–æ—Å–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å jitter
* –¥–µ–ª–∞—Ç—å random delay ¬± 20%

–û–∫–µ–π, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º. –°–µ–π—á–∞—Å –¥–∞–º —Ç–µ–±–µ **–ë–ª–æ–∫ 3**, **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**, **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã**, –∏ –≤ –∏—Ç–æ–≥–µ —É —Ç–µ–±—è –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π Tail Latency –≤ Production ‚Äî –≤—Å—ë –≤ —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ: –æ—Ç –±–æ–ª–∏ ‚Üí –∫ —Ä–µ—à–µ–Ω–∏—è–º ‚Üí –∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º.

–î–∞–ª—å—à–µ —Ç—ã —Å–º–æ–∂–µ—à—å —Å–æ–±—Ä–∞—Ç—å —ç—Ç–æ –≤ PDF, –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é, –≤ –¥–æ–∫–ª–∞–¥ –∏–ª–∏ —Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫—É –≤–∏–¥–µ–æ.

–ü–æ–µ—Ö–∞–ª–∏.

---

# üéØ –ë–õ–û–ö 3: –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –°–û–í–ï–¢–´ (5‚Äì7 –º–∏–Ω)

–í —ç—Ç–æ–º –±–ª–æ–∫–µ –Ω–∞–¥–æ –≤–µ—Ä–Ω—É—Ç—å –∑—Ä–∏—Ç–µ–ª—è –∏–∑ ¬´–±–æ–ª—å—à–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã¬ª –∫ –ø–æ–Ω—è—Ç–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –º–æ–∂–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å —É —Å–µ–±—è –ø—Ä—è–º–æ –∑–∞–≤—Ç—Ä–∞.

–ì–ª–∞–≤–Ω—ã–π –ø–æ—Å—ã–ª:

> Tail latency ‚Äî —ç—Ç–æ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–ª–æ—Ö–∏–µ –º–µ—Ç—Ä–∏–∫–∏.
> –ï—Å–ª–∏ —Ç—ã –∏—Ö —Ö–æ—Ä–æ—à–æ –º–µ—Ä—è–µ—à—å, —Ç—ã —É–∂–µ –≤ —Ç–æ–ø-10% –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.

---

# 3.1 –ß—Ç–æ –º–µ—Ä–∏—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç **—Å—Ä–µ–¥–Ω–µ–µ**.
–≠—Ç–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.

–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –Ω–∞–¥–æ **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** –∑–∞–¥–µ—Ä–∂–µ–∫. –í–æ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä:

### ‚úî p50 ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ï—Å–ª–∏ p50 –ø—Ä—ã–≥–Ω—É–ª ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –≤ –∫–æ–¥–µ, –∏–ª–∏ –≤ –ë–î.

### ‚úî p95 ‚Äî –ø–µ—Ä–≤—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –±–æ–ª–∏

–ï—Å–ª–∏ —Ä–∞—Å—Ç—ë—Ç p95 ‚Üí —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –±–µ–¥–∞.

### ‚úî p99 ‚Äî —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

–≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ.

### ‚úî p999 ‚Äî –∑–æ–Ω–∞ ‚Äú–≥—Ä–æ–±–∏—Ç –ø—Ä–æ–¥‚Äù

–¢—É—Ç –∂–∏–≤—É—Ç GC-–ø–∞—É–∑–∫–∏, —Ç–æ—Ä–º–æ–∑–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, NUMA, —Ä–µ—Ç—Ä–∞–∏, –∏ –≤—Å—è–∫–∞—è –Ω–µ—á–∏—Å—Ç—å.

### ‚úî Rate of retries

–ï—Å–ª–∏ —Ä–∞—Å—Ç—ë—Ç ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ —É–∂–µ –∏–¥—ë—Ç –ø–æ —Ü–µ–ø–æ—á–∫–µ.

### ‚úî Queue length (–Ω–∞ API/Gateway/DB/Redis/kafka)

–û—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç—ë—Ç ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–µ–∏–∑–±–µ–∂–Ω–∞.
–≠—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π Little's Law, —Ç–µ–ø–µ—Ä—å –Ω–µ –∫–∞–∫ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Ñ–∏–≥–Ω—è, –∞ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è –±–æ–ª—å.

---

# 3.2 Histogram vs Summary

–ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Prometheus:

* **summary** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç p95/p99, –Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–¥–µ
* **histogram** –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤—Å–µ–º –Ω–æ–¥–∞–º

–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ histograms.
Summary –ª–æ–º–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω—É –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç —Ö–≤–æ—Å—Ç—ã.

---

# 3.3 Distributed tracing –∫–∞–∫ —Ä–µ–Ω—Ç–≥–µ–Ω tail latency

–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å Jaeger/Tempo/Zipkin.

–ß—Ç–æ –¥–∞—ë—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:

* –≤–∏–¥–∏—à—å, –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –¥–∞–ª —Ö–≤–æ—Å—Ç
* –≤–∏–¥–∏—à—å, –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –∑–∞–ø—Ä–æ—Å –ø–æ–≤–∏—Å
* –ª–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—à—å –ª–æ–∫–∏
* –≤–∏–¥–∏—à—å –≥–¥–µ –≤–æ–∑–Ω–∏–∫ retried storm
* –≤–∏–¥–∏—à—å cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏

–î–æ–±–∞–≤—å —Ç–∞–∫—É—é –¥–∏–∞–≥—Ä–∞–º–º—É:

```mermaid
graph TD
A[Request start]
A --> B[API Gateway<br/>10ms]
B --> C[Service A<br/>30ms]
C --> D[Service B<br/>250ms p99]
D --> E[Database<br/>12ms]
E --> F[–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É]
```

–°—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –≥–¥–µ –ª–µ–∂–∏—Ç p99.

---

# 3.4 Alerting: –Ω–∞ —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã

–ù–µ –Ω–∞–¥–æ –±—É–¥–∏—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –ø—Ä–∏ `average latency > 50ms`.

–ù–∞–¥–æ:

### ‚úî p99 > 10 √ó p50

–°–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª, —á—Ç–æ —Ö–≤–æ—Å—Ç –ø–æ–ø–æ–ª–∑.

### ‚úî —Ä–æ—Å—Ç –æ—á–µ—Ä–µ–¥–µ–π

–û—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ LB –∏ –ë–î.

### ‚úî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ç—Ä–∞–µ–≤

–û–±—ã—á–Ω–æ —ç—Ç–æ —Ä–∞–Ω–Ω–∏–π —Å–∏–≥–Ω–∞–ª cascade failure.

### ‚úî —Ä–æ—Å—Ç –¥–æ–ª–∏ `5xx` –æ—Ç downstream —Å–µ—Ä–≤–∏—Å–æ–≤

–ï—Å–ª–∏ p99 –≤—ã—Ä–æ—Å ‚Üí –æ—à–∏–±–∫–∏ –Ω–µ–∏–∑–±–µ–∂–Ω—ã.

---

# 3.5 –ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–µ–Ω –±–æ—è—Ç—å—Å—è –∫–∞–∂–¥—ã–π)

* p99 –≥—É–ª—è–µ—Ç –∫–∞–∫ —Ö–æ—á–µ—Ç
* —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É p99 –∏ p50 > 20‚Äì30√ó
* –≤–æ—Ä–∫–µ—Ä—ã –∏–Ω–æ–≥–¥–∞ –ø–æ–¥–≤–∏—Å–∞—é—Ç –Ω–∞ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã
* Redis –≤–Ω–µ–∑–∞–ø–Ω–æ –¥–µ–ª–∞–µ—Ç EVICT
* Kafka lag –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω
* ‚Äú–∏–Ω–æ–≥–¥–∞ checkout 2 —Å–µ–∫—É–Ω–¥—ã‚Äù ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ —Ä–∞–∑–±–∏—Ä–∞–ª—Å—è

–≠—Ç–æ –≤—Å—ë —Å–∏–º–ø—Ç–æ–º—ã tail latency, –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —ç—Ç–æ —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç.

---

# üèÅ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (2‚Äì3 –º–∏–Ω)

–≠—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –Ω–∞–¥–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –≤ –æ–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π –ø–æ—Å—ã–ª, —á—Ç–æ–±—ã –∑—Ä–∏—Ç–µ–ª—å —É—à—ë–ª —Å —á—ë—Ç–∫–∏–º –≤—ã–≤–æ–¥–æ–º.

---

# ‚úî –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ç–∏–Ω—ã –æ Tail Latency

### 1) Tail latency ‚Äî —ç—Ç–æ –Ω–µ –±–∞–≥. –≠—Ç–æ —Ñ–∏–∑–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

–õ—é–±–æ–π —Å–µ—Ä–≤–∏—Å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞—á–∏–Ω–∞–µ—Ç ¬´—Ç—è–Ω—É—Ç—å —Ö–≤–æ—Å—Ç¬ª.

### 2) –•–≤–æ—Å—Ç—ã –Ω–µ–ª—å–∑—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞—Ç—å.

–ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ:

* —É–º–µ–Ω—å—à–∏—Ç—å,
* –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å,
* –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å,
* —Å–≥–ª–∞–¥–∏—Ç—å.

### 3) –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ ‚Üí —Ö–≤–æ—Å—Ç —Ä–∞—Å—Ç—ë—Ç –Ω–µ–ª–∏–Ω–µ–π–Ω–æ

p99 –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ ‚Üí –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ü–µ–ø–æ—á–∫–µ.

### 4) –†–µ—à–µ–Ω–∏—è –ª–µ–∂–∞—Ç –Ω–∞ —Ç—Ä—ë—Ö —É—Ä–æ–≤–Ω—è—Ö:

* –∫–æ—Ä–æ—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ ‚Äî hedging, tied, coalescing
* –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ ‚Äî latency-aware LB, deadline propagation, circuit breakers
* –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ ‚Äî L1/L2 caching, microsharding, async queues, background jitter

### 5) –•–æ—Ä–æ—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –ø–æ–ª–æ–≤–∏–Ω–∞ –ø–æ–±–µ–¥—ã

–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ —à–ª—ë—Ç –∞–ª–µ—Ä—Ç—ã –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É ‚Äî –æ–Ω–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–±–µ–¥–∏—Ç tail latency.

---

# ‚úî –ó–∞–≤–µ—Ä—à–∞—é—â–∏–π –º–µ—Å—Å–µ–¥–∂

> –í –º–∏—Ä–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —Å–≤–æ–µ–≥–æ —Ö–≤–æ—Å—Ç–∞.
> –ò–Ω–∂–µ–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–º–µ—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å p99, –∂–∏–≤—É—Ç –≤ –¥—Ä—É–≥–æ–º –º–∏—Ä–µ, –≥–¥–µ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –Ω–µ –≤–∞–ª–∏—Ç—Å—è –ø–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è–º –≤ 4 —É—Ç—Ä–∞.

–û—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã:

* Google: *The Tail at Scale*
* AWS Builder‚Äôs Library: *Timeouts, Retries, and Backoff*
* HighScalability articles about queuing
* Martin Kleppmann: *Designing Data-Intensive Applications*

---

# üìö –í–ò–ó–£–ê–õ–¨–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´ (–≥–æ—Ç–æ–≤—ã–µ –≤—Å—Ç–∞–≤–∫–∏)

–ú–æ–∂–µ—à—å –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –≤–∏–¥–µ–æ –∫–∞–∫ –µ—Å—Ç—å:

---

### 1. Histogram Latency

```mermaid
graph LR
A[p50]:::green --> B[p90]:::yellow --> C[p95]:::orange --> D[p99]:::red --> E[p999]:::crimson

classDef green fill:#c7f9cc,stroke:#333;
classDef yellow fill:#fff3b0,stroke:#333;
classDef orange fill:#ffbf69,stroke:#333;
classDef red fill:#ff6b6b,stroke:#333;
classDef crimson fill:#c1121f,stroke:#333;
```

---

### 2. Hedged Requests

```mermaid
sequenceDiagram
participant Client
participant A
participant B

Client->>A: Request
Client-->>Client: wait p95
Client->>B: Duplicate request

A-->>Client: Slow response
B-->>Client: Fast response
```

---

### 3. Tied Requests

```mermaid
sequenceDiagram
participant Client
participant A
participant B

Client->>A: Request (id=42)
Client-->>Client: Delay 2 RTT
Client->>B: Request (id=42, peer=A)

A-->>B: Cancel 42
B-->>A: Cancelled
```

---

### 4. Cascading Timeout

```mermaid
sequenceDiagram
participant User
participant API
participant Service
participant DB

User->>API: Request
API->>Service: RPC
Service->>DB: Query
DB-->>Service: Slow response
Service-->>API: Timeout
API-->>User: Timeout
Note over API,Service: Retry Storm Begins
```

---

### 5. Queueing Delay vs Load

```mermaid
graph LR
A[Load ‚Üë] --> B[Queue Length ‚Üë]
B --> C[Latency ‚Üë]
C --> D[Timeout ‚Üë]
D --> E[Retry Storm]
E --> F[Latency Collapse]
```

---

### 6. Priority Queue Architecture

```mermaid
graph TD
A[Incoming Requests] --> B{Priority?}
B -->|High| C[High Priority Queue]
B -->|Medium| D[Medium Priority Queue]
B -->|Low| E[Low Priority Queue]
C --> F[Worker Pool]
D --> F
E --> F
```

---

### 7. Circuit Breaker State

```mermaid
stateDiagram-v2
    [*] --> Closed
    Closed --> Open: Failure threshold exceeded
    Open --> HalfOpen: Timeout elapsed
    HalfOpen --> Closed: Success
    HalfOpen --> Open: Failure
```

---

### 8. Table of Techniques

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è  | –¢–µ—Ö–Ω–∏–∫–∞              | –°—É—Ç—å                                    |
| ---------- | -------------------- | --------------------------------------- |
| Short-term | Hedged               | –î—É–±–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ p95              |
| Short-term | Tied                 | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤, –æ—Ç–º–µ–Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ |
| Short-term | Coalescing           | –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ —Ç—ã—Å—è—á–∏               |
| Long-term  | Latency-aware LB     | –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –Ω–æ–¥—ã –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è              |
| Long-term  | Deadline Propagation | –¢–∞–π–º-–±—é–¥–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤–Ω–∏–∑             |
| Long-term  | Circuit Breaker      | –û—Ç–∫–ª—é—á–∞–µ—Ç —Ç–æ—Ä–º–æ–∑–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã             |
| Arch       | L1/L2 Cache          | –ú–µ–Ω—å—à–µ —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤                  |
| Arch       | Microsharding        | –ò–∑–æ–ª—è—Ü–∏—è –≥–æ—Ä—è—á–∏—Ö –∫–ª—é—á–µ–π                 |
| Arch       | Background jitter    | –ù–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á           |

