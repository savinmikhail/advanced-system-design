# üé¨ **–°–¶–ï–ù–ê–†–ò–ô: Rebalancing –∏ Migration –±–µ–∑ downtime**

## üß® 1. –í–°–¢–£–ü–õ–ï–ù–ò–ï (1 –º–∏–Ω—É—Ç–∞)

‚Äú–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–º–æ –ø–æ —Å–µ–±–µ ‚Äî –Ω–µ—Å–ª–æ–∂–Ω–∞—è –∏–¥–µ—è.
–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ **–Ω–∞–¥–æ –ø–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å**.‚Äù

–ò –¥–∞–ª—å—à–µ –±—Ä–æ—Å–æ–∫ –±–æ–ª–∏:

* –æ–¥–∏–Ω —à–∞—Ä–¥ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω
* –æ–¥–∏–Ω —à–∞—Ä–¥ —Ä–∞–∑—Ä–æ—Å—Å—è –±—ã—Å—Ç—Ä–µ–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
* –æ–¥–∏–Ω —à–∞—Ä–¥ —Å—Ç–∞–ª hot spot
* —É shard key –ø–ª–æ—Ö–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
* –ø—Ä–æ–µ–∫—Ç –≤—ã—Ä–æ—Å, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —à–∞—Ä–¥–æ–≤
* –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî –Ω—É–∂–Ω–æ —Å–ª–∏—Ç—å –ª–∏—à–Ω–∏–µ

–ò –≤—Å—ë —ç—Ç–æ ‚Äî **–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**, –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π, –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞.

–§—Ä–∞–∑–∞ –¥–ª—è –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ—Å—Ç–∏:

> ‚Äú–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–∞–∫ –ø–æ–ª–µ—Ç –Ω–∞ –≤–µ—Ä—Ç–æ–ª—ë—Ç–µ.
> –í–∑–ª–µ—Ç–µ—Ç—å –ª–µ–≥–∫–æ. –ê –≤–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å –ª–æ–ø–∞—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ ‚Äî —ç—Ç–æ —É–∂–µ rebalancing.‚Äù

---

# üß© 2. –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù REBALANCING (1 –º–∏–Ω—É—Ç–∞)

–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É:

### ‚úî 1) –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –¥–∞–Ω–Ω—ã—Ö

–û–¥–∏–Ω —à–∞—Ä–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ 10 —Ä–∞–∑ –±–æ–ª—å—à–µ –¥—Ä—É–≥–∏—Ö.

### ‚úî 2) –ì–æ—Ä—è—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Å—É—â–Ω–æ—Å—Ç–∏

–û–¥–∏–Ω —à–∞—Ä–¥ ‚Äî 90% –≤—Å–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

### ‚úî 3) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —à–∞—Ä–¥–æ–≤

–ù—É–∂–Ω–æ ‚Äú—Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å‚Äù —Å—Ç–∞—Ä—ã–µ.

### ‚úî 4) –ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–≥–∏–æ–Ω–æ–≤/—Ç–µ–Ω–∞–Ω—Ç–æ–≤

–ë–∏–∑–Ω–µ—Å —Ä–∞—Å—Ç—ë—Ç ‚Üí layout –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –º–µ–Ω—è—Ç—å.

### ‚úî 5) –ò–∑–º–µ–Ω–µ–Ω–∏–µ shard key

–°–∞–º–∞—è –±–æ–ª—å—à–∞—è –±–æ–ª—å.

---

# üß± 3. –í–ò–î–´ –ú–ò–ì–†–ê–¶–ò–ô (2 –º–∏–Ω—É—Ç—ã)

–ö–æ—Ä–æ—Ç–∫–æ, —á—Ç–æ–±—ã –∑—Ä–∏—Ç–µ–ª—å –Ω–µ –ø–æ—Ç–µ—Ä—è–ª—Å—è:

### ‚≠ê Resharding

–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª—é—á–∏ –º–µ–∂–¥—É —Ç–µ–º–∏ –∂–µ –Ω–æ–¥–∞–º–∏.

### ‚≠ê Upscaling

–î–æ–±–∞–≤–∏–ª–∏ —à–∞—Ä–¥ ‚Üí –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–∂–∏—Ç—å —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

### ‚≠ê Downscaling

–£–¥–∞–ª–∏–ª–∏ —à–∞—Ä–¥ ‚Üí –Ω—É–∂–Ω–æ —Å–ª–∏—Ç—å –µ–≥–æ –≤ –¥—Ä—É–≥–∏–µ.

### ‚≠ê Online relocation

–ü–µ—Ä–µ–Ω–æ—Å –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∫–ª—é—á–µ–π.

### ‚≠ê Shard key migration

–°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π: –º–µ–Ω—è–µ–º —Å–∞–º—É –ª–æ–≥–∏–∫—É —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è.

–¢–µ–±–µ –∑–¥–µ—Å—å –≤–∞–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª—å:

> ‚Äú–ú–∏–≥—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ –Ω–µ ‚Äò–ø–µ—Ä–µ–ª–æ–∂–∏—Ç—å –¥–∞–Ω–Ω—ã–µ‚Äô.
> –ú–∏–≥—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ ‚Äò–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞ –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É –º–∏—Ä–∞‚Äô.‚Äù

---

# üõë 4. –ë–û–õ–¨ –°–¢–ê–¢–ò–ß–ï–°–ö–û–ì–û –®–ê–†–î–ò–†–û–í–ê–ù–ò–Ø (1 –º–∏–Ω—É—Ç–∞)

‚Äúcustomer_id % 8‚Äù ‚Äî —ç—Ç–æ –Ω–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ.
–≠—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥.

–ü—Ä–æ–±–ª–µ–º—ã:

* —É–¥–≤–æ–∏—Ç—å —à–∞—Ä–¥–æ–≤ –Ω–µ–ª—å–∑—è
* —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ–ª—å–∑—è
* –∏–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –Ω–µ–ª—å–∑—è
* hot key —É–±–∏–≤–∞–µ—Ç —à–∞—Ä–¥
* cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ç—É—Ç
* –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–æ–¥ ‚Üí –ø–æ–ª–Ω—ã–π –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å

–ö–æ—Ä–æ—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞:

> ‚Äú–°—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–∞–∫ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞.
> –õ–µ–≥–∫–æ —Å–¥–µ–ª–∞—Ç—å, –±–æ–ª—å–Ω–æ –∂–∏—Ç—å.‚Äù

---

# ‚ö† 5. –ü–†–û–ë–õ–ï–ú–´, –ö–û–¢–û–†–´–ï –°–õ–ï–î–£–ï–¢ –†–ï–®–ê–¢–¨ (3 –º–∏–Ω—É—Ç—ã)

–û–±—ä—è—Å–Ω—è–µ–º –∏–Ω–∂–µ–Ω–µ—Ä–Ω—É—é –ø–æ–¥–æ–ø–ª—ë–∫—É:

### ‚úî 5.1. –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–Ω–æ—Å–∞

–î—É–±–ª–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö, —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π.

### ‚úî 5.2. In-flight writes

–ó–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç –≤ –º–æ–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–∏.

### ‚úî 5.3. Race conditions

–û–¥–Ω–∏ –≤–æ—Ä–∫–µ—Ä—ã —á–∏—Ç–∞—é—Ç —Å—Ç–∞—Ä—ã–π —à–∞—Ä–¥, –¥—Ä—É–≥–∏–µ ‚Äî –Ω–æ–≤—ã–π.

### ‚úî 5.4. Atomic cutover

–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º.

### ‚úî 5.5. –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å –∏ –±–∞–∑—É

Backfill –º–æ–∂–µ—Ç –ø–æ–ª–æ–∂–∏—Ç—å –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä.

### ‚úî 5.6. –ö–µ—à–∏

L1/L2 –∫–µ—à –¥–µ—Ä–∂–∞—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∂—É—Ç–∫–∏–µ stale.

–ú—ã –ø–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º –∑—Ä–∏—Ç–µ–ª—è:

> ‚Äú–ï—Å–ª–∏ –Ω–µ —Ä–µ—à–∏—Ç—å –∫–∞–∂–¥—É—é –∏–∑ —ç—Ç–∏—Ö –ø—Ä–æ–±–ª–µ–º ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É.‚Äù

---

# ‚öô 6. –°–¢–†–£–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´ ONLINE-–ú–ò–ì–†–ê–¶–ò–ò (–º–æ—Å—Ç–∏–∫ –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ç–µ—Ö–Ω–∏–∫–∞–º–∏)

–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å:

```mermaid
flowchart LR
    App --> Router
    Router --> OldShard
    Router --> NewShard

    OldShard -- CDC --> Kafka --> Migrator
    Migrator --> NewShard

    Router -. generation switch .-> NewShard
```

–¢—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞:

1. **–ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö (backfill)**
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (CDC)**
3. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (switch)**

–¢–µ–ø–µ—Ä—å –±–∞–ª–∞–Ω—Å –∏–¥–µ–∞–ª—å–Ω—ã–π ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º.

---

# üü¶ 7. –ü–û–î–•–û–î 1: Dual Write (–¥–≤–æ–π–Ω–∞—è –∑–∞–ø–∏—Å—å) (2 –º–∏–Ω—É—Ç—ã)

–ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤–∏—á–∫–∏, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ —Å—Ä–∞–∑—É –∫—Ä–∏—Ç–∏–∫—É–µ–º.

–ê–ª–≥–æ—Ä–∏—Ç–º:

1. –ü–∏—à–µ–º —Å—Ä–∞–∑—É –≤ —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π —à–∞—Ä–¥
2. –ß–∏—Ç–∞–µ–º –ø–æ–∫–∞ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ
3. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—ë –¥–æ–≥–Ω–∞–Ω–æ ‚Üí switched
4. –°—Ç–∞—Ä—ã–π –≤—ã–∫–ª—é—á–∞–µ–º

–ü–ª—é—Å—ã:

* –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å
* –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º

–ú–∏–Ω—É—Å—ã:

* —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω
* –¥–≤–æ–π–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã
* —Ä–∞–∑–Ω—ã–µ —Ç–∞–π–º–∏–Ω–≥–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
* —Å–ª–æ–∂–Ω—ã–µ –≥–æ–Ω–∫–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–∞—Ö

–§—Ä–∞–∑–∞:

> ‚ÄúDual write ‚Äî –ø—Ä–∏—Ö–≤–∞—Ç–∫–∞ —Å–∫–æ—Ç—á–µ–º. –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ —Å—Ç–æ–∏—Ç.‚Äù

---

# üü© 8. –ü–û–î–•–û–î 2: ‚ÄúWrite to new, Read from old‚Äù + Repair Worker (3 –º–∏–Ω—É—Ç—ã)

–ù–∞–¥—ë–∂–Ω–µ–µ, —á–∞—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:

–•–æ–¥:

1. –ü–∏—à–µ–º —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—ã–π —à–∞—Ä–¥
2. –ß–∏—Ç–∞–µ–º –ø–æ–∫–∞ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ
3. –§–æ–Ω–æ–≤—ã–π –º–∏–≥—Ä–∞—Ç–æ—Ä –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –∑–∞–ø–∏—Å–∏
4. –ö–æ–≥–¥–∞ –Ω–æ–≤—ã–π –¥–æ–≥–Ω–∞–ª ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —á—Ç–µ–Ω–∏–µ

–ü–ª—é—Å—ã:

* –ø—Ä–æ—â–µ –¥–æ–±–∏—Ç—å—Å—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
* –º–µ–Ω—å—à–µ –≥–æ–Ω–æ–∫
* rollback –ø—Ä–æ—Å—Ç–æ–π

–ú–∏–Ω—É—Å—ã:

* —Ç—Ä—É–¥–Ω–æ —á–∏—Å—Ç–∏—Ç—å –º—É—Å–æ—Ä

–≠—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω —Ö–æ—Ä–æ—à–æ –ª–æ–∂–∏—Ç—Å—è –Ω–∞ PHP + Symfony + RabbitMQ:

```php
// Consumer miggration worker
while ($msg = $queue->receive()) {
    $data = unserialize($msg->body);
    $newShard->upsert($data);
}
```

---

# üüß 9. –ü–û–î–•–û–î 3: ‚ÄúRouting First‚Äù (2 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç LinkedIn, Twitter.

–ò–¥–µ—è:

1. –ú–µ–Ω—è–µ–º shard map ‚Üí –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤ –Ω–æ–≤—ã–π
2. –ù–æ –¥–∞–Ω–Ω—ã–µ –µ—â—ë –≤ —Å—Ç–∞—Ä–æ–º
3. –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. –°—Ç–∞—Ä—ã–π —à–∞—Ä–¥ –æ—á–∏—â–∞–µ—Ç—Å—è

–ü–ª—é—Å—ã:

* –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π downtime
* –Ω–µ—Ç –¥–≤–æ–π–Ω–æ–π –∑–∞–ø–∏—Å–∏
* hot keys –º–∏–≥—Ä–∏—Ä—É—é—Ç —Å—Ä–∞–∑—É

–î–∏–∞–≥—Ä–∞–º–º–∞:

```mermaid
flowchart LR
    Router --> NewShard
    Router -->|redirect| OldShard
```

---

# üü• 10. –ü–û–î–•–û–î 4: CDC + Backfill (3‚Äì4 –º–∏–Ω—É—Ç—ã)

–°–∞–º—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π.

–ò—Å–ø–æ–ª—å–∑—É—é—Ç Uber, Pinterest, DoorDash, Shopify.

–•–æ–¥:

1. –î–µ–ª–∞–µ–º snapshot (backfill) ‚Üí –≥—Ä—É–∑–∏–º bulk –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π
2. CDC —Å–ª—É—à–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ ‚Üí Kafka ‚Üí Migrator
3. Migrator –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–æ–≤—ã–π
4. –î–æ–∂–∏–¥–∞–µ–º—Å—è, –ø–æ–∫–∞ lag = 0
5. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å

–ü–ª—é—Å—ã:

* –∏–¥–µ–∞–ª—å–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö
* –Ω–µ—Ç –≥–æ–Ω–æ–∫
* –Ω–µ—Ç –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö

–ú–∏–Ω—É—Å—ã:

* —Å–ª–æ–∂–Ω–µ–µ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
* –Ω—É–∂–µ–Ω –±—Ä–æ–∫–µ—Ä (Kafka/Pulsar)

–î–∏–∞–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç:

```mermaid
sequenceDiagram
Old->>CDC: Change event
CDC->>Kafka: Publish
Kafka->>Migrator: Consume
Migrator->>New: Apply
```

---

# üü™ 11. –ü–û–î–•–û–î 5: Live Traffic Replay (2 –º–∏–Ω—É—Ç—ã)

–≠—Ç–æ hardcore.

–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è high-throughput —Å–µ—Ä–≤–∏—Å–æ–≤.

–°—É—Ç—å:

1. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫
2. –†–µ–ø–ª–µ–∏–º –µ–≥–æ –≤ –Ω–æ–≤—ã–π —à–∞—Ä–¥
3. –ö–æ–≥–¥–∞ –Ω–æ–≤—ã–π = —Å—Ç–∞—Ä—ã–π ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Amazon DynamoDB, Spanner migrations.

---

# üß¨ 12. Atomic Cutover (3 –º–∏–Ω—É—Ç—ã)

–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.

### –¢–µ—Ö–Ω–∏–∫–∞ 1: Feature Flag

–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å newShardEnabled=true.

### –¢–µ—Ö–Ω–∏–∫–∞ 2: Routing Map Generation

–ö–∞—Ä—Ç–∞ N ‚Üí –∫–∞—Ä—Ç–∞ N+1.

### –¢–µ—Ö–Ω–∏–∫–∞ 3: Epoch / Generation

–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ—Å—ë—Ç ‚Äú–ø–æ–∫–æ–ª–µ–Ω–∏–µ‚Äù.

–ï—Å–ª–∏ —Å—Ç–∞—Ä–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ:

```text
X-Generation: 7   ‚Üí redirect –Ω–∞ –Ω–æ–≤—ã–π —à–∞—Ä–¥
```

### –¢–µ—Ö–Ω–∏–∫–∞ 4: Pausing writers

–§—Ä–∏–∑ –ø–∏—Å–∞—Ç–µ–ª–µ–π –Ω–∞ 20‚Äì50ms.

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ; –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞–º–µ—á–∞—é—Ç.

### –¢–µ—Ö–Ω–∏–∫–∞ 5: Write fencing

–ü–∏—à–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ generation —Å–æ–≤–ø–∞–¥–∞–µ—Ç:

```sql
UPDATE users
SET ...
WHERE id = :id AND generation = 18;
```

---

# üß® 13. In-Flight Writes (1 –º–∏–Ω—É—Ç–∞)

–û–±—ä—è—Å–Ω—è–µ–º:

* –∑–∞–ø–∏—Å–∏ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏
* –Ω–∞–¥–æ –∏—Ö –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ

–†–µ—à–µ–Ω–∏—è:

* idempotency
* write fencing
* queue draining
* –∫–æ—Ä–æ—Ç–∫–∏–µ freeze –æ–∫–Ω–∞

---

# üßπ 14. Post-Migration Cleanup (1 –º–∏–Ω—É—Ç–∞)

–û—á–∏—Å—Ç–∏—Ç—å:

* —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
* —Å—Ç–∞—Ä—ã–µ –∫–µ—à–∏
* —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ shard map
* orphaned data

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å:

* GC –≤–æ—Ä–∫–µ—Ä
* TTL
* Version purge

---

# üö´ 15. –ê–ù–¢–ò-–ü–ê–¢–¢–ï–†–ù–´ (1 –º–∏–Ω—É—Ç–∞)

### ‚ùå –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞

–Ω–µ –≤–∞—Ä–∏–∞–Ω—Ç

### ‚ùå –û–¥–∏–Ω –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–π SQL —Å–∫—Ä–∏–ø—Ç

–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç

### ‚ùå –ö–ª–∏–µ–Ω—Ç –∑–Ω–∞–µ—Ç shard layout

—É–±–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å rebalancing

### ‚ùå ‚Äú–°–Ω–∞—á–∞–ª–∞ –≤—ã—Ä—É–±–∏–º —Å—Ç–∞—Ä—ã–π —à–∞—Ä–¥, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–Ω–µ—Å—ë–º –¥–∞–Ω–Ω—ã–µ‚Äù

—Ç—É—Ç –¥–∞–∂–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ –Ω–∞–¥–æ

---

# üî• 16. –ò–¢–û–ì–ò + –ü–ï–†–ï–•–û–î –ö –î–†–£–ì–û–ô –¢–ï–ú–ï (1 –º–∏–Ω—É—Ç–∞)

–§–∏–Ω–∞–ª—å–Ω–∞—è –º—ã—Å–ª—å:

> ‚Äú–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ rebalancing ‚Äî –ø—Ä–æ—Å—Ç–æ –±–æ–º–±–∞ —Å —Ç–∞–π–º–µ—Ä–æ–º.
> –ß—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –∂–∏–≤–æ–π, —à–∞—Ä–¥—ã –¥–æ–ª–∂–Ω—ã —É–º–µ—Ç—å –¥–≤–∏–≥–∞—Ç—å—Å—è.
> –ò –¥–≤–∏–≥–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω.‚Äù

–ú–æ—Å—Ç–∏–∫:

> ‚Äú–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–º–µ—Ä–∞–º —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π:
> –∫–∞–∫ Uber, Amazon, LinkedIn, TikTok –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ,
> –∏ –ø–æ—á–µ–º—É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –º–∏—Ä–µ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è.‚Äù
