# **–ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: Dynamic Sharding —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (15 –º–∏–Ω—É—Ç)**

# –ò–Ω—Ç—Ä–æ (30‚Äì40 —Å–µ–∫—É–Ω–¥)

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å.
–í—Å—ë –∫—Ä–∞—Å–∏–≤–æ: –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, —à–∞—Ä–¥—ã, –±–∞–∑—ã, –∫–µ—à–∏.
–°–µ—Ä–≤–∏—Å —Ä–∞—Å—Ç—ë—Ç, –±–∏–∑–Ω–µ—Å —Ä–∞–¥—É–µ—Ç—Å—è, –≥—Ä–∞—Ñ–∏–∫–∏ –≤–≤–µ—Ä—Ö.

–ü–æ–∫–∞ –æ–¥–Ω–∞–∂–¥—ã –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `userId = 123`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—á–µ–º—É-—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **30% –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞**.
–ò –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –±–∏–∑–Ω–µ—Å –≥–æ–≤–æ—Ä–∏—Ç: ‚Äú–¥–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –µ—â—ë –ø–∞—Ä—É —à–∞—Ä–¥–æ–≤, –∞ —Ç–æ —Ç–µ–∫—É—â–∏–µ —É–∂–µ –∑–∞—Ö–ª—ë–±—ã–≤–∞—é—Ç—Å—è‚Äù.

–í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤—ã—è—Å–Ω—è–µ—Ç—Å—è –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ–µ:

1. ‚Äú–û–¥–∏–Ω —Ä–∞–∑ –ø–æ—Ä–µ–∑–∞–ª–∏ –ø–æ —à–∞—Ä–¥–∞–º –∏ –∑–∞–±—ã–ª–∏‚Äù ‚Äî —ç—Ç–æ –Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è. –î–∞–Ω–Ω—ã–µ –∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—Å—ë –≤—Ä–µ–º—è –º–µ–Ω—è—é—Ç—Å—è.
2. –ù–∞–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ `hash(userId) % N` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ä–æ–≤–Ω–æ –ø–æ–∫–∞ N –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**.
   –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å —à–∞—Ä–¥—ã –∏–ª–∏ –ø–µ—Ä–µ—Ä–∞–∑–º–∞–∑–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É ‚Äî –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –±–æ–ª—å: –ø–æ—á—Ç–∏ –≤—Å–µ –∫–ª—é—á–∏ ‚Äú–ø–µ—Ä–µ–µ–∑–∂–∞—é—Ç‚Äù, –∫–µ—à–∏ –ø—Ä–æ—Ç—É—Ö–∞—é—Ç, –±–∞–∑–∞ –ª–æ–≤–∏—Ç —à—Ç–æ—Ä–º.

–í –ø—Ä–µ–¥—ã–¥—É—â–µ–π —á–∞—Å—Ç–∏ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏—Å—å:

* —á—Ç–æ —Ç–∞–∫–æ–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ;
* –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç RANGE/LIST/HASH-–ø–∞—Ä—Ç–∏—Ü–∏–∏;
* –∫–∞–∫ –º–æ–∂–Ω–æ —à–∞—Ä–¥–∏–Ω–≥–æ–º —Ä–∞–∑–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–∑–Ω—ã–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º –∏ —Ä–µ–≥–∏–æ–Ω–∞–º.

–¢–µ–ø–µ—Ä—å —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å:
**–Ω–µ –ø—Ä–æ—Å—Ç–æ ‚Äú–∫–∞–∫ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Ä–µ–∑–∞—Ç—å‚Äù, –∞ –∫–∞–∫ –∂–∏—Ç—å, –∫–æ–≥–¥–∞ —à–∞—Ä–¥—ã –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–≤–∏–≥–∞—Ç—å –∏ –ø–µ—Ä–µ–≤–µ—à–∏–≤–∞—Ç—å –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –∏ –ø–µ—Ä–µ–∫–æ—Å–∞ –Ω–∞–≥—Ä—É–∑–∫–∏.**

–¢–æ –µ—Å—Ç—å: **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ.**

---

# –ß–∞—Å—Ç—å 1: –ß—Ç–æ —Ç–∞–∫–æ–µ Dynamic Sharding (1 –º–∏–Ω—É—Ç–∞)

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞:

* —Ä–æ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ ‚Üí –ø–µ—Ä–µ–∫–æ—Å (skew);
* –ø–æ—è–≤–ª–µ–Ω–∏–µ –≥–æ—Ä—è—á–∏—Ö –∫–ª—é—á–µ–π ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞—Ä–¥—ã –Ω–∞—á–∏–Ω–∞—é—Ç –≥–æ—Ä–µ—Ç—å;
* —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ ‚Üí –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —à–∞—Ä–¥—ã, —Ä–µ–≥–∏–æ–Ω—ã, –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Ç–µ—Ä–∞;
* –∑–∞–º–µ–Ω–∏–ª–∏ –∂–µ–ª–µ–∑–æ, —Å–Ω—è–ª–∏ —Å—Ç–∞—Ä—ã–µ –Ω–æ–¥—ã ‚Üí –≤—Å—ë —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–¥–æ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å.

**Dynamic sharding** ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–µ—Ç:

* –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —à–∞—Ä–¥—ã –≤ —Ä–∞–Ω—Ç–∞–π–º–µ;
* –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –∫–ª—é—á–µ–π;
* –¥–µ–ª–∏—Ç—å –ø–µ—Ä–µ–≥—Ä–µ—Ç—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã;
* –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª—é—á–∏;
* –¥–µ–ª–∞—Ç—å –≤—Å—ë —ç—Ç–æ *–±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞*.

–í–∞–∂–Ω–æ: **—Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–µ–ª–µ–Ω–∏—è –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.**
–ö–∞–∫ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ –¥–µ–ª–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ rebalancing –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –≥–ª–∞–≤–∞.

---

# üß± –ß–∞—Å—Ç—å 2: –ë–∞–∑–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è (1‚Äì2 –º–∏–Ω—É—Ç—ã)

–ß—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è —Å –±–∞–∑–æ–≤–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–µ–π.

## 1. Shard Key

–ü—Ä–∞–≤–∏–ª–æ: *–ø–æ —á–µ–º—É –º—ã —Ä–µ–∂–µ–º –¥–∞–Ω–Ω—ã–µ / –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å*.

–ü—Ä–∏–º–µ—Ä—ã:

* `user_id`
* `tenant_id`
* `(country, city)`
* –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω (`created_at`)

–ü–ª–æ—Ö–æ–π shard key = —É–º–∏—Ä–∞—é—â–∏–π –ø—Ä–æ–¥:

* –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ –∫—Ä—É–ø–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ;
* –≤—Å–µ ‚Äú–≤–∞–∂–Ω—ã–µ‚Äù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –≤ –æ–¥–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ.

## 2. Hot Key

–ö–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ—Å–æ—Ä–∞–∑–º–µ—Ä–Ω–æ –±–æ–ª—å—à–æ–π —Ç—Ä–∞—Ñ–∏–∫.

* –≤–∏–¥–µ–æ –≤ —Ç—Ä–µ–Ω–¥–∞—Ö ‚Üí 100k RPS –Ω–∞ –æ–¥–∏–Ω `video_id`;
* ‚Äú–∑–≤—ë–∑–¥–Ω—ã–π‚Äù –ø—Ä–æ–¥–∞–≤–µ—Ü, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —á—Ç–æ-—Ç–æ —Å—á–∏—Ç–∞—é—Ç.

–û–¥–∏–Ω hot key –º–æ–∂–µ—Ç –ø–æ–ª–æ–∂–∏—Ç—å —Ü–µ–ª—ã–π —à–∞—Ä–¥.

## 3. Skew

–ü–µ—Ä–µ–∫–æ—Å –Ω–∞–≥—Ä—É–∑–∫–∏, –∫–æ–≥–¥–∞ –æ–¥–Ω–∏ —à–∞—Ä–¥—ã –≥–æ—Ä—è—Ç, –∞ –¥—Ä—É–≥–∏–µ —Å–ø—è—Ç.

* shard1 ‚Äî 80% RPS;
* shard2‚Äì4 ‚Äî –ø–æ 5‚Äì7% –∏ —Å–∫—É—á–∞—é—Ç.

Skew —É–±–∏–≤–∞–µ—Ç –ª—é–±—ã–µ –∫—Ä–∞—Å–∏–≤—ã–µ ‚Äú—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–µ‚Äù —Å—Ö–µ–º—ã, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —É–º–µ–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è.

---

# üõ∞ –ß–∞—Å—Ç—å 2.5. –ì–¥–µ –∂–∏–≤—ë—Ç —Ä–æ—É—Ç–∏–Ω–≥ (1‚Äì2 –º–∏–Ω—É—Ç—ã)

–í –ø—Ä–æ—à–ª–æ–π —Å–µ–∫—Ü–∏–∏ (2.0) –º—ã –ø–æ–∫–∞–∑–∞–ª–∏ shard map / —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

–°–µ–π—á–∞—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º, **–≥–¥–µ –≤–æ–æ–±—â–µ –º–æ–∂–µ—Ç –∂–∏—Ç—å –ª–æ–≥–∏–∫–∞ ‚Äú–∫—É–¥–∞ –∏–¥—Ç–∏ –∑–∞ —ç—Ç–∏–º –∫–ª—é—á–æ–º‚Äù**.

–ï—Å—Ç—å —Ç—Ä–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞.

### 1) Client-side routing

* –õ–æ–≥–∏–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—à–∏—Ç–∞ –≤ —Å–∞–º —Å–µ—Ä–≤–∏—Å-–∫–ª–∏–µ–Ω—Ç.
* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ `user_id` —Å–∞–º–æ —Å—á–∏—Ç–∞–µ—Ç: ‚Äú–∫—É–¥–∞ –∏–¥—Ç–∏‚Äù.

–ü–ª—é—Å—ã:

* –Ω–µ—Ç –ª–∏—à–Ω–µ–≥–æ —Ö–æ–ø–∞ –ø–æ —Å–µ—Ç–∏;
* –º–µ–Ω—å—à–µ latency, –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞.

–ú–∏–Ω—É—Å—ã:

* –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –ø—Ä–æ shard layout;
* –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã = –¥–µ–ø–ª–æ–π –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤;
* –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∏—Ç—å –∑–æ–æ–ø–∞—Ä–∫ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π.

### 2) –¢—É–ø–æ–π proxy

* –ö–ª–∏–µ–Ω—Ç –∏–¥—ë—Ç –Ω–∞ –µ–¥–∏–Ω—ã–π endpoint;
* proxy –ø–æ –∫–∞–∫–æ–º—É-—Ç–æ –ø—Ä–∞–≤–∏–ª—É (`hash(key) % N`, shard map) –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω—É–∂–Ω—ã–π —à–∞—Ä–¥.

–ü–ª—é—Å—ã:

* –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π;
* –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ö–µ–º—É –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º.

–ú–∏–Ω—É—Å—ã:

* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è latency (–µ—â—ë –æ–¥–∏–Ω —Ö–æ–ø);
* SPOF/–±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ, –µ—Å–ª–∏ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º proxy.

### 3) –£–º–Ω—ã–π coordinator

* –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä:

    * –∑–Ω–∞–µ—Ç layout —à–∞—Ä–¥–æ–≤;
    * —É–º–µ–µ—Ç —Å–∞–º –¥–µ–ª–∞—Ç—å cross-shard –∑–∞–ø—Ä–æ—Å—ã, joins, –∞–≥—Ä–µ–≥–∞—Ç—ã;
    * –º–æ–∂–µ—Ç –≤—ã—Å—Ç—É–ø–∞—Ç—å –∫–∞–∫ ‚Äú—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤‚Äù.

–ü–ª—é—Å—ã:

* —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å;
* –º–æ–∂–Ω–æ –ø—Ä—è—Ç–∞—Ç—å –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å–ª–æ–∂–Ω—ã–µ cross-shard –æ–ø–µ—Ä–∞—Ü–∏–∏.

–ú–∏–Ω—É—Å—ã:

* —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –∫—É—Å–æ–∫ —Å–∏—Å—Ç–µ–º—ã;
* –ª–µ–≥–∫–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –µ–≥–æ –≤ –º–æ–Ω—Å—Ç—Ä–∞ –∏ —Ç–æ—á–∫—É –æ—Ç–∫–∞–∑–∞.

–í —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏:

* –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö KV/–∫–µ—à–∞ ‚Äî —á–∞—â–µ client-side –∏–ª–∏ —Ç—É–ø–æ–π proxy;
* –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ë–î ‚Äî —É–º–Ω—ã–π coordinator (Citus, Vitess, Cockroach –∏ —Ç.–ø.).

–î–∞–ª—å—à–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ–º, —á—Ç–æ **–≥–¥–µ-—Ç–æ** –∂–∏–≤—ë—Ç —ç—Ç–æ—Ç routing layer ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, proxy –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä.

---

# üß© –ß–∞—Å—Ç—å 3: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è (8‚Äì10 –º–∏–Ω—É—Ç)

–¢–µ–ø–µ—Ä—å ‚Äî —Å–∞–º–æ–µ –≤–∫—É—Å–Ω–æ–µ.

–≠—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç:

* Redis Cluster
* Cassandra
* Kafka
* MongoDB
* HBase / TiDB / Cockroach
* Twitter / Instagram / Facebook / Uber (–≤ —Å–≤–æ–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö)

---

# üöÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Consistent Hashing + –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–¥—ã (2 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç: Redis Cluster, Cassandra, Kafka.

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –Ω–∞–∏–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:

```text
shard = hash(user_id) % N
```

–†–∞–±–æ—Ç–∞–µ—Ç –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ `N` –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.

–î–æ–±–∞–≤–∏–ª–∏ –µ—â—ë –æ–¥–∏–Ω —à–∞—Ä–¥?

* –ø–æ—á—Ç–∏ **–≤—Å–µ** –∫–ª—é—á–∏ –º–µ–Ω—è—é—Ç Shard;
* –∫–µ—à ‚Äî –ø—Ä–æ—Ç—É—Ö;
* –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É/—Å–µ—Ç—å —É–ª–µ—Ç–µ–ª–∞ –≤–≤–µ—Ä—Ö;
* rebalancing –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –º–∏–Ω–∏-DDoS –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É.

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Consistent Hashing

–ò–¥–µ—è:

* —Å—Ç—Ä–æ–∏–º **–∫–æ–ª—å—Ü–æ hash-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞**;
* —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ –Ω–µ–º—É —É–∑–ª—ã;
* –∫–∞–∂–¥—ã–π –∫–ª—é—á –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª –ø–æ —á–∞—Å–æ–≤–æ–π.

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –Ω–æ–¥—ã:

* **–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∫–ª—é—á–µ–π**, –∞ –Ω–µ –≤–µ—Å—å –º–∏—Ä;
* –º—ã —É–º–µ–Ω—å—à–∞–µ–º –æ–±—ä—ë–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Ä–∞–∑–º–µ—Ä –∫–µ—à-—à—Ç–æ—Ä–º–∞.

```mermaid
graph LR
  subgraph "Hash Ring"
    A((Node1))
    B((Node2))
    C((Node3))
    A --- B --- C --- A
  end
```

–ß—Ç–æ–±—ã —Å–≥–ª–∞–¥–∏—Ç—å –ø–µ—Ä–µ–∫–æ—Å, –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–¥—ã**:

* –∫–∞–∂–¥–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–µ—Å—è—Ç–∫–æ–º‚Äì—Å–æ—Ç–Ω–µ–π ‚Äú—Ç–æ—á–µ–∫‚Äù –Ω–∞ –∫–æ–ª—å—Ü–µ;
* —ç—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç skew –∏ –¥–∞—ë—Ç –≥–∏–±–∫–æ—Å—Ç—å.

‚ö† –í–∞—Ä–∏–∞–Ω—Ç –Ω–∞ –∑–∞–º–µ—Ç–∫—É:
–≤–º–µ—Å—Ç–æ –∫–æ–ª—å—Ü–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **rendezvous hashing** (HRW-—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî
–∫–ª—é—á –≤—ã–±–∏—Ä–∞–µ—Ç ‚Äú–ª—É—á—à–∏–π‚Äù —É–∑–µ–ª –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–±–æ—Ä–∞ —É–∑–ª–æ–≤ –ø–µ—Ä–µ—Å—á—ë—Ç –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∫–ª—é—á–µ–π.
–ù–æ –∏–¥–µ—è —Ç–∞ –∂–µ: —É–º–µ–Ω—å—à–∏—Ç—å –æ–±—ä—ë–º –ø–µ—Ä–µ—Å–∫–æ–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.

### –ü—Ä–æ–±–ª–µ–º–∞

Consistent hashing **–Ω–µ —Å–ø–∞—Å–∞–µ—Ç –æ—Ç hot keys**.

–ï—Å–ª–∏ –æ–¥–∏–Ω `user_id` –∏–ª–∏ `video_id` —Å—Ç–∞–ª –±–µ–∑—É–º–Ω–æ –≥–æ—Ä—è—á–∏–º:

* –æ–Ω –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–∏–¥–∏—Ç –Ω–∞ –æ–¥–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ –∫–æ–ª—å—Ü–∞;
* —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª –ø–µ—Ä–µ–≥—Ä–µ–≤–∞—é—Ç—Å—è.

Consistent hashing —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É *–º–∞—Å—Å–æ–≤–æ–π* –º–∏–≥—Ä–∞—Ü–∏–∏,
–Ω–æ **–Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–≥—Ä–µ–≤–∞**. –ù—É–∂–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏.

---

### ‚ö† –ö–∞—Å–∫–∞–¥–Ω—ã–µ –æ—Ç–∫–∞–∑—ã –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏

–û—Ç–¥–µ–ª—å–Ω–∞—è –±–µ–¥–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º ‚Äî –∫–∞—Å–∫–∞–¥–Ω—ã–µ –ø–∞–¥–µ–Ω–∏—è.

–°—Ü–µ–Ω–∫–∞:

* –æ–¥–∏–Ω —à–∞—Ä–¥ –Ω–∞—á–∞–ª –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å (–¥–∏—Å–∫, GC, —Å–µ—Ç—å);
* routing-—Å–ª–æ–π –ø–æ–º–µ—Ç–∏–ª –µ–≥–æ –∫–∞–∫ unhealthy –∏ –Ω–∞—á–∞–ª –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ;
* —Å–æ—Å–µ–¥–Ω–∏–µ —à–∞—Ä–¥—ã –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ —Ç–∞–∫–æ–π –æ–±—ä—ë–º, –∏—Ö latency —Ä–∞—Å—Ç—ë—Ç;
* –∫–ª–∏–µ–Ω—Ç—ã/—Ä–µ—Ç—Ä–∞–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –¥–æ–ª–±–∏—Ç—å –∏—Ö –µ—â—ë —Å–∏–ª—å–Ω–µ–µ.

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤–º–µ—Å—Ç–æ ‚Äú–º–∏–Ω—É—Å –æ–¥–∏–Ω —à–∞—Ä–¥‚Äù –ø–æ–ª—É—á–∞–µ–º:
**–º–∏–Ω—É—Å –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä.**

–ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –Ω–µ –ª–æ–≤–∏—Ç—å, –æ–¥–Ω–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞–ª–æ. –ù—É–∂–Ω—ã:

* **rate limiting** –∏ **backpressure** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤—Ö–æ–¥–Ω–æ–π –ø–æ—Ç–æ–∫ –Ω–∞ –∫–∞–∂–¥—ã–π —à–∞—Ä–¥;
* **circuit breaker‚Äô—ã** ‚Äî –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –±–∏—Ç—å –≤ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–≤—à–∏–µ —É–∑–ª—ã;
* –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ—Ç—Ä–∞–µ–≤ (–±–µ–∑ ‚Äú–≤—Å—ë —Ä–µ—Ç—Ä–∞–∏–º –Ω–∞ –≤—Å–µ —à–∞—Ä–¥—ã –ø–æ–¥—Ä—è–¥‚Äù).

___

### üßÆ –í–∞—Ä–∏–∞–Ω—Ç: Rendezvous (HRW) hashing

–ï—Å—Ç—å –µ—â—ë –æ–¥–∏–Ω –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî **rendezvous hashing** (HRW).

–ò–¥–µ—è:

* –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞ —Å—á–∏—Ç–∞–µ–º ‚Äú–æ—Ü–µ–Ω–∫—É‚Äù –¥–ª—è –ö–ê–ñ–î–û–ì–û —É–∑–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä `score = hash(key + node_id)`;
* –≤—ã–±–∏—Ä–∞–µ–º —É–∑–µ–ª —Å **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º score**;
* –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –Ω–æ–¥—ã –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –≤—ã–±–æ—Ä–æ–≤.

–ü–ª—é—Å—ã:

* –Ω–µ—Ç –∫–æ–ª—å—Ü–∞ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–¥, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—â–µ;
* –∫–∞–∫ –∏ consistent hash, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ ‚Äú–ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞—é—Ç‚Äù –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–±–æ—Ä–∞ –Ω–æ–¥.

–ú–∏–Ω—É—Å—ã:

* –∫–∞–∫ –∏ –∫–æ–ª—å—Ü–æ, **–Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É hot keys –∏ –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤** ‚Äî
  —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ª–µ—á–∏—Ç—Å—è rate limiting‚Äô–æ–º, microsharding‚Äô–æ–º –∏ hot-key isolation.

___

# üìö –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: Directory-Based Sharding (2 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç: Instagram, Facebook TAO, –º–Ω–æ–≥–∏–µ –∫—Ä—É–ø–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.

–°—É—Ç—å:

> –í–º–µ—Å—Ç–æ —á–∏—Å—Ç–æ–π —Ñ–æ—Ä–º—É–ª—ã (`hash % N`) –¥–µ–ª–∞–µ–º **—è–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏**.

–ü—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:

```text
0‚Äì1M userId   ‚Üí shard1
1M‚Äì2M userId  ‚Üí shard2
2M‚Äì3M userId  ‚Üí shard3
...
```

–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:

* —Ç–∞–±–ª–∏—Ü–∞ `shard_map` –≤ –±–∞–∑–µ;
* –∫–æ–Ω—Ñ–∏–≥ –≤ key-value —Ö—Ä–∞–Ω–∏–ª–∏—â–µ;
* –æ—Ç–¥–µ–ª—å–Ω—ã–π metadata service.

–° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

1. –ø–æ –∫–ª—é—á—É (`user_id`, `region`) —Å–ø—Ä–∞—à–∏–≤–∞–µ–º shard-map: ‚Äú–∫—É–¥–∞ –∏–¥—Ç–∏?‚Äù;
2. –ø–æ–ª—É—á–∞–µ–º —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —à–∞—Ä–¥/–∫–ª–∞—Å—Ç–µ—Ä;
3. —É–∂–µ —Ç—É–¥–∞ –ø–æ—Å—ã–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å.

–ú—ã —ç—Ç—É –∏–¥–µ—é —É–∂–µ –≤–∏–¥–µ–ª–∏ –≤ –ª–∏–∫–±–µ–∑–µ (2.0) –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ `shard_map` –ø–æ `region`.
–ó–¥–µ—Å—å –¥–µ–ª–∞–µ–º –µ—ë –æ—Å–Ω–æ–≤–æ–π **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ** —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

### –ü–ª—é—Å—ã

* –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ö–µ–º—É —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–Ω—Ç–∞–π–º–µ:

    * —Ä–∞–∑–¥–µ–ª—è—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã;
    * –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã –º–µ–∂–¥—É —É–∑–ª–∞–º–∏;
    * –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤/tenant‚Äô–æ–≤.
* –º–æ–∂–Ω–æ –≤–æ–æ–±—â–µ —Å–º–µ–Ω–∏—Ç—å shard key:

    * –±—ã–ª–æ –ø–æ `user_id`, —Å—Ç–∞–ª–æ –ø–æ `(region, user_id)` ‚Äî shard-map –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–ª–∏.

### –ú–∏–Ω—É—Å—ã

* –Ω—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π metadata —Å–ª–æ–π:

    * shard-map –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–µ—à–µ –ø–æ—á—Ç–∏ –≤–µ–∑–¥–µ;
    * –Ω—É–∂–Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è/HA, –∏–Ω–∞—á–µ —ç—Ç–æ SPOF.
* routing-—Å–ª–æ–π —É—Å–ª–æ–∂–Ω—è–µ—Ç—Å—è.

–ù–æ –≤ –æ–±–º–µ–Ω –º—ã –ø–æ–ª—É—á–∞–µ–º **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å**:

* –ª—é–±–∞—è –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ shard-map, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö.

---

# üåó –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: Dynamic Range Splitting (1.5 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç: MongoDB, HBase, CockroachDB, TiDB.

Core –∏–¥–µ—è:

> ‚Äú–ö–∞–∂–¥—ã–π —à–∞—Ä–¥ ‚Äî —ç—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω. –î–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–∞–ª —Å–ª–∏—à–∫–æ–º –∂–∏—Ä–Ω—ã–º –∏–ª–∏ –≥–æ—Ä—è—á–∏–º ‚Äî —Ä–µ–∂–µ–º –ø–æ–ø–æ–ª–∞–º.‚Äù

–ë—ã–ª–æ:

```text
[0..10M] ‚Üí shard1
```

–°—Ç–∞–ª–æ:

```text
[0..5M]  ‚Üí shard1
[5M..10M] ‚Üí shard2
```

–°–∏—Å—Ç–µ–º–∞:

* –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Ä–∞–∑–º–µ—Ä –∏ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω—ã;
* –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞:

    * —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω;
    * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö;
    * –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ routing‚Äô–∞.

### –ü–ª—é—Å—ã

* –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç, timestamp);
* —à–∞—Ä–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞;
* –º–æ–∂–Ω–æ *–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å* —Ä–∞–∑–±–∏–µ–Ω–∏–µ.

### –ú–∏–Ω—É—Å—ã

* –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö;
* –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤;
* –Ω—É–∂–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç layout‚Äô–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤.

–ü–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —ç—Ç–æ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç—Å—è —Å directory-based –ø–æ–¥—Ö–æ–¥–æ–º:

* meta-service –∑–Ω–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –≥–¥–µ –ª–µ–∂–∞—Ç;
* range-splitting ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –æ–¥–Ω–∞ –∏–∑ –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ —ç—Ç–∏–º layout‚Äô–æ–º.

---

# ü™∂ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: Microsharding (2 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç: Twitter Manhattan, Uber –∏ –¥—Ä—É–≥–∏–µ –∫—Ä—É–ø–Ω—ã–µ —Ä–µ–±—è—Ç–∞.

–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏–º–µ—Ç—å 8‚Äì16 ‚Äú—Ç–æ–ª—Å—Ç—ã—Ö‚Äù —à–∞—Ä–¥–æ–≤, –º—ã –¥–µ–ª–∞–µ–º **—Å–æ—Ç–Ω–∏/—Ç—ã—Å—è—á–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —à–∞—Ä–¥–æ–≤**:

```text
virtual shards: 0‚Ä¶999
```

–§–∏–∑–∏—á–µ—Å–∫–∏ –æ–Ω–∏ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è —Ç–∞–∫:

```text
Node1 ‚Üí 13 virtual shards
Node2 ‚Üí 17 virtual shards
Node3 ‚Üí 16 virtual shards
...
```

–°—Ü–µ–Ω–∞—Ä–∏–π:

* —É–∑–µ–ª –ø–µ—Ä–µ–≥—Ä–µ–ª—Å—è ‚Üí —Å–Ω–∏–º–∞–µ–º —Å –Ω–µ–≥–æ 5‚Äì10 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —à–∞—Ä–¥–æ–≤ ‚Üí –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –¥—Ä—É–≥–∏–µ –Ω–æ–¥—ã;
* layout –º–æ–∂–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ.

### –ü–ª—é—Å—ã

* –æ—á–µ–Ω—å –≥–∏–±–∫–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏;
* rebalancing –¥–µ–ª–∞–µ—Ç—Å—è –º–∞–ª—ã–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏:

    * –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –¥–µ—Å—è—Ç–∫–∏ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π;
    * –ø–µ—Ä–µ–Ω–æ—Å–∏–º –º–∞–ª–µ–Ω—å–∫–∏–µ –∫—É—Å–∫–∏;
* –∑–∞—â–∏—Ç–∞ –æ—Ç skew:

    * –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–π ‚Äú—Ç–æ–ª—Å—Ç–æ–π‚Äù –ø–∞—Ä—Ç–∏—Ü–∏–∏.

### –ú–∏–Ω—É—Å—ã

* routing —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω–µ–µ:

    * —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —à–∞—Ä–¥ –¥–ª—è –∫–ª—é—á–∞;
    * –ø–æ—Ç–æ–º –ø–æ shard-map —Å–º–æ—Ç—Ä–∏–º, –Ω–∞ –∫–∞–∫–æ–π –Ω–æ–¥–µ –æ–Ω –∂–∏–≤—ë—Ç;
* –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π ‚Äúplacement driver‚Äù / metadata service.

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ —á–∞—Å—Ç–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:

* **microshards** + **consistent/directory-based hashing** + **routing —Å–µ—Ä–≤–∏—Å**.

---

# üî• –°—Ç—Ä–∞—Ç–µ–≥–∏—è 5: Hot-Key Isolation (1.5 –º–∏–Ω—É—Ç—ã)

–ò—Å–ø–æ–ª—å–∑—É—é—Ç: DynamoDB Adaptive Capacity, Cloudflare, –º–Ω–æ–≥–∏–µ CDN/–∫–µ—à–∏.

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –æ–±—â–µ–º layout‚Äô–µ, –∞ –≤ **–ø–∞—Ä–µ –≥–æ—Ä—è—á–∏—Ö –∫–ª—é—á–µ–π**,
–∏–Ω–æ–≥–¥–∞ –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –º—É–¥—Ä–∏—Ç—å —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π.

–ò–¥–µ—è:

> ‚Äú–ì–æ—Ä—è—á–∏–µ –∫–ª—é—á–∏ ‚Äî –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞—Ä–¥—ã, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –∫–∞–∫ –±—ã–ª–æ.‚Äù

–ü—Ä–∏–º–µ—Ä:

```text
KEY123 ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π hot-shard
KEY777 ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π hot-shard
–≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –æ–±—ã—á–Ω–æ–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

–ú–æ–∂–Ω–æ:

* –≤—ã–Ω–µ—Å—Ç–∏ –∫–ª—é—á –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å;
* –¥–∞—Ç—å –µ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª —Ä–µ—Å—É—Ä—Å–æ–≤;
* –ø–æ–≤–µ—Å–∏—Ç—å –¥–æ–ø. –∑–∞—â–∏—Ç—É/–ª–∏–º–∏—Ç—ã.

### –ü–ª—é—Å—ã

* –±—ã—Å—Ç—Ä–æ —Å–Ω–∏–º–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É;
* –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ rebalancing‚Äô–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.

### –ú–∏–Ω—É—Å—ã

* —É—Å–ª–æ–∂–Ω—è–µ—Ç—Å—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

    * —á–∞—Å—Ç—å –ª–æ–≥–∏–∫–∏ ‚Äú–æ—Å–æ–±–µ–Ω–Ω–∞—è‚Äù –¥–ª—è —ç—Ç–∏—Ö –∫–ª—é—á–µ–π;
* –Ω—É–∂–Ω—ã —Ö–æ—Ä–æ—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

    * —á—Ç–æ–±—ã –≤–æ–≤—Ä–µ–º—è –Ω–∞—Ö–æ–¥–∏—Ç—å hot keys;
    * —á—Ç–æ–±—ã –Ω–µ —Ç–∞—â–∏—Ç—å —Ç—É–¥–∞ –≤—Å—ë –ø–æ–¥—Ä—è–¥.

–ß–∞—Å—Ç–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è ‚Äú–∑–∞–ø–ª–∞—Ç–∫–∞‚Äù, –Ω–æ –≤ –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö **hot-key isolation** ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω.

---

# üß® –ß–∞—Å—Ç—å 4: –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ (1 –º–∏–Ω—É—Ç–∞)

–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–µ ‚Äú–æ–¥–Ω–∞ –º–∞–≥–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞‚Äù.

**Dynamic sharding** ‚Äî —ç—Ç–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏–π:

* –∫–∞–∫ –º—ã —Ä–µ–∂–µ–º –¥–∞–Ω–Ω—ã–µ (range/hash/directory/microshards);
* –≥–¥–µ –∂–∏–≤—ë—Ç routing (–∫–ª–∏–µ–Ω—Ç, proxy, coordinator, metadata service);
* –∫–∞–∫ –º—ã –±–æ—Ä–µ–º—Å—è —Å–æ skew –∏ hot keys;
* –∫–∞–∫ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –∏ —É–¥–∞–ª—è–µ–º —à–∞—Ä–¥—ã, –Ω–µ —É–±–∏–≤–∞—è –ø—Ä–æ–¥.

–ü—Ä–∏ —ç—Ç–æ–º:

* –Ω–∞–∏–≤–Ω–æ–µ `hash(key) % N` –∂–∏–≤—ë—Ç —Ä–æ–≤–Ω–æ –¥–æ **–ø–µ—Ä–≤–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è N**;
* consistent hashing —Å–ø–∞—Å–∞–µ—Ç –æ—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞–∑–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ –æ—Ç hot keys;
* directory-based –∏ microsharding –¥–∞—é—Ç –≥–∏–±–∫–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É—é—Ç —É–º–Ω–æ–≥–æ metadata —Å–ª–æ—è;
* hot-key isolation ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—É–±–µ–∂ –æ–±–æ—Ä–æ–Ω—ã, –∫–æ–≥–¥–∞ –ø–∞—Ä—É –∫–ª—é—á–µ–π –Ω—É–∂–Ω–æ ‚Äú–ø–æ—Å–∞–¥–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ‚Äù.

–ò —ç—Ç–æ –µ—â—ë –Ω–µ –≤—Å—ë.

–ü–æ–∫–∞ –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ —Ç–æ–º, **–∫–∞–∫ –¥–µ–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—Ä–∞–∑–º–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**.
–ù–æ –æ—Å—Ç–∞—é—Ç—Å—è –¥–≤–∞ —Å–∞–º—ã—Ö –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞:

---

# üëâ –°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞: Cross-Shard Operations (join‚Äô—ã, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã)

–ö–∞–∫ –∂–∏—Ç—å, –∫–æ–≥–¥–∞ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞—Ä–¥–æ–≤:

* join –ø–æ —Ä–∞–∑–Ω—ã–º —à–∞—Ä—Ç–∞–º;
* –∞–≥—Ä–µ–≥–∞—Ç—ã (`COUNT/AVG/SUM`) –ø–æ –≤—Å–µ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É;
* —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–æ–≥–∞—é—Ç —Ä–∞–∑–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã;
* –ø–æ–∏—Å–∫ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç —à–∞—Ä–¥—ã.

–ò –∫–∞–∫ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —É–±–∏–≤–∞—Ç—å latency –∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å coordinator –≤ –º–æ–Ω—Å—Ç—Ä–∞.

---

# üëâ –ì–ª–∞–≤–∞ –ø–æ—Å–ª–µ –Ω–µ—ë: Rebalancing & Migration –±–µ–∑ downtime

–î–∞–∂–µ –∏–¥–µ–∞–ª—å–Ω—ã–π layout —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç.

–ù—É–∂–Ω–æ —É–º–µ—Ç—å:

* –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏;
* –º–µ–Ω—è—Ç—å –∫–ª—é—á–∏/–¥–∏–∞–ø–∞–∑–æ–Ω—ã;
* –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –Ω–æ–¥—ã;
* –¥–µ–ª–∞—Ç—å –≤—Å—ë —ç—Ç–æ:

    * **–±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞**;
    * **–±–µ–∑ –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö**;
    * **–±–µ–∑ ‚Äú–¥–≤–æ–π–Ω—ã—Ö‚Äù –∏–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π**.

–≠—Ç–æ —Ç–µ–º–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–ª–∞–≤—ã ‚Äî –ø—Ä–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ rebalancing.
